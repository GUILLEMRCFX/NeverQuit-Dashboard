<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEVER QUIT DASHBOARD</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #121417; color: #E6E8EB; line-height: 1.6; padding: 2rem; }

        /* ‚îÄ‚îÄ‚îÄ GLOBE LANGUAGE SELECTOR ‚îÄ‚îÄ‚îÄ */
        .lang-globe-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #181B20;
            border: 1px solid rgba(230,232,235,0.15);
            color: #9AA0A6;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
            box-shadow: 0 4px 14px rgba(0,0,0,0.35);
        }
        .lang-globe-btn:hover { border-color: #2ECC71; color: #2ECC71; transform: scale(1.08); }
        .lang-globe-btn.open { border-color: #2ECC71; color: #2ECC71; }

        .lang-dropdown {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 9998;
            background: #181B20;
            border: 1px solid rgba(230,232,235,0.1);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.5);
            transform: translateY(-8px) scale(0.95);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .lang-dropdown.visible {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: all;
        }
        .lang-opt {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.75rem 1.25rem;
            color: #9AA0A6;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        .lang-opt:hover { background: rgba(46,204,113,0.08); color: #E6E8EB; }
        .lang-opt.active { color: #2ECC71; }
        .lang-opt .flag { font-size: 1rem; }
        .lang-opt:not(:last-child) { border-bottom: 1px solid rgba(230,232,235,0.05); }

        /* ‚îÄ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ‚îÄ */
        .history-fab {
            position: fixed;
            bottom: 24px;
            left: 24px;
            z-index: 9997;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498DB, #2980B9);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(52,152,219,0.4);
            transition: all 0.25s;
        }
        .history-fab:hover { transform: scale(1.1); box-shadow: 0 8px 28px rgba(52,152,219,0.55); }
        .history-fab .badge {
            position: absolute;
            top: -4px; right: -4px;
            background: #E74C3C;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            width: 18px; height: 18px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        .history-panel {
            position: fixed;
            bottom: 84px;
            left: 24px;
            z-index: 9996;
            width: 380px;
            max-width: calc(100vw - 48px);
            background: #181B20;
            border: 1px solid rgba(230,232,235,0.1);
            border-radius: 14px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.55);
            transform: translateY(12px) scale(0.96);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.22s ease, opacity 0.22s ease;
            overflow: hidden;
        }
        .history-panel.visible { transform: translateY(0) scale(1); opacity: 1; pointer-events: all; }
        .history-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(230,232,235,0.08);
        }
        .history-panel-title { font-weight: 700; font-size: 0.9rem; color: #E6E8EB; }
        .history-panel-close {
            background: none; border: none; color: #9AA0A6;
            font-size: 1.1rem; cursor: pointer; line-height: 1;
            transition: color 0.2s;
        }
        .history-panel-close:hover { color: #E74C3C; }

        .history-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9AA0A6;
            padding: 0.75rem 1.25rem 0.4rem;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.65rem 1.25rem;
            transition: background 0.15s;
        }
        .history-item:hover { background: rgba(46,204,113,0.04); }
        .history-item-icon { font-size: 0.95rem; flex-shrink: 0; }
        .history-item-info { flex: 1; min-width: 0; }
        .history-item-name { font-size: 0.82rem; font-weight: 600; color: #E6E8EB; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item-sub { font-size: 0.72rem; color: #9AA0A6; margin-top: 0.1rem; }
        .history-item-delete {
            flex-shrink: 0;
            width: 26px; height: 26px;
            border-radius: 6px;
            background: rgba(231,76,60,0.12);
            border: none;
            color: #E74C3C;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .history-item-delete:hover { background: rgba(231,76,60,0.25); transform: scale(1.1); }
        .history-empty { padding: 1.5rem 1.25rem; text-align: center; color: #9AA0A6; font-size: 0.85rem; }
        .history-panel-body { max-height: 380px; overflow-y: auto; padding-bottom: 0.5rem; }
        .history-panel-body::-webkit-scrollbar { width: 4px; }
        .history-panel-body::-webkit-scrollbar-track { background: transparent; }
        .history-panel-body::-webkit-scrollbar-thumb { background: #2ECC71; border-radius: 2px; }
        .history-divider { height: 1px; background: rgba(230,232,235,0.05); margin: 0.25rem 0; }

        /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center; }
        .modal-overlay.active { display:flex; }
        .modal-content { background:#181B20; border-radius:12px; padding:2rem; max-width:500px; width:90%; border:1px solid rgba(230,232,235,0.1); }
        .modal-header { font-size:1.5rem; font-weight:700; color:#E6E8EB; margin-bottom:1rem; }
        .modal-body { color:#9AA0A6; margin-bottom:2rem; line-height:1.6; }
        .modal-actions { display:flex; gap:1rem; justify-content:flex-end; }
        .modal-btn { padding:0.75rem 1.5rem; border:none; border-radius:8px; font-family:'Inter',sans-serif; font-size:0.9rem; font-weight:600; cursor:pointer; transition:all 0.3s; }
        .modal-btn.cancel { background:#9AA0A6; color:#121417; }
        .modal-btn.cancel:hover { background:#7F8C8D; }
        .modal-btn.confirm { background:#E74C3C; color:white; }
        .modal-btn.confirm:hover { background:#C0392B; }
        #resetConfirmInput:focus { outline:none; border-color:#E74C3C!important; box-shadow:0 0 0 3px rgba(231,76,60,0.2); }

        .container { max-width:1400px; margin:0 auto; }
        .header { margin-bottom:2rem; padding-bottom:1.5rem; border-bottom:1px solid rgba(230,232,235,0.1); }
        .header h1 { font-size:2rem; font-weight:800; background:linear-gradient(135deg,#E6E8EB 0%,#2ECC71 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.5rem; }
        .header p { color:#9AA0A6; font-size:0.9rem; }
        .year-selector { display:flex; align-items:center; gap:1rem; margin-top:1rem; flex-wrap:wrap; }
        .year-selector label { color:#9AA0A6; font-size:0.85rem; font-weight:600; text-transform:uppercase; }
        .year-selector select { padding:0.5rem 1rem; background:#181B20; border:1px solid rgba(230,232,235,0.1); border-radius:6px; color:#E6E8EB; font-family:'Inter',sans-serif; }
        .btn-reset { padding:0.5rem 1rem; background:#E74C3C; color:white; border:none; border-radius:6px; font-family:'Inter',sans-serif; font-size:0.8rem; font-weight:600; cursor:pointer; transition:all 0.3s; text-transform:uppercase; letter-spacing:0.05em; }
        .btn-reset:hover { background:#C0392B; transform:translateY(-1px); }

        .tabs { display:flex; gap:0.5rem; margin-bottom:2rem; border-bottom:2px solid rgba(230,232,235,0.05); overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin; scrollbar-color:#2ECC71 rgba(230,232,235,0.05); padding-bottom:0.5rem; }
        .tabs::-webkit-scrollbar { height:6px; }
        .tabs::-webkit-scrollbar-track { background:rgba(230,232,235,0.05); border-radius:3px; }
        .tabs::-webkit-scrollbar-thumb { background:#2ECC71; border-radius:3px; }
        .tab { padding:0.75rem 1.5rem; background:transparent; border:none; color:#9AA0A6; cursor:pointer; font-family:'Inter',sans-serif; font-size:0.875rem; font-weight:600; border-bottom:3px solid transparent; white-space:nowrap; }
        .tab:hover { color:#E6E8EB; }
        .tab.active { color:#2ECC71; border-bottom-color:#2ECC71; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }

        .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1.5rem; margin-bottom:2rem; }
        .card { background:#181B20; border-radius:12px; padding:1.5rem; border:1px solid rgba(230,232,235,0.05); }
        .card-title { font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:#9AA0A6; margin-bottom:1.5rem; }
        .form-group { margin-bottom:1rem; }
        .form-group label { display:block; font-size:0.8rem; font-weight:600; color:#9AA0A6; margin-bottom:0.5rem; text-transform:uppercase; }
        .form-group input, .form-group select { width:100%; padding:0.75rem; background:#121417; border:1px solid rgba(230,232,235,0.1); border-radius:8px; color:#E6E8EB; font-family:'Inter',sans-serif; font-size:0.9rem; }
        .form-group input:focus, .form-group select:focus { outline:none; border-color:#2ECC71; }
        .btn { padding:0.875rem 1.5rem; background:#2ECC71; color:#121417; border:none; border-radius:8px; font-family:'Inter',sans-serif; font-size:0.85rem; font-weight:700; text-transform:uppercase; cursor:pointer; width:100%; transition:all 0.3s; }
        .btn:hover { background:#27AE60; transform:translateY(-1px); }

        .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; margin-bottom:2rem; }
        .kpi-card { background:#181B20; padding:1.5rem; border-radius:12px; border:1px solid rgba(230,232,235,0.05); }
        .kpi-label { font-size:0.75rem; font-weight:700; text-transform:uppercase; color:#9AA0A6; margin-bottom:0.75rem; letter-spacing:0.05em; }
        .kpi-value { font-size:2rem; font-weight:800; color:#E6E8EB; margin-bottom:0.5rem; }
        .kpi-value.success { color:#2ECC71; }
        .kpi-value.warning { color:#F39C12; }
        .kpi-value.danger { color:#E74C3C; }
        .kpi-subtitle { font-size:0.8rem; color:#9AA0A6; }

        .table-container { background:#181B20; border-radius:12px; padding:1.5rem; border:1px solid rgba(230,232,235,0.05); overflow-x:auto; margin-bottom:1.5rem; }
        table { width:100%; border-collapse:collapse; }
        th { text-align:left; padding:1rem; border-bottom:2px solid rgba(230,232,235,0.1); color:#9AA0A6; font-weight:700; font-size:0.75rem; text-transform:uppercase; }
        td { padding:1rem; border-bottom:1px solid rgba(230,232,235,0.05); font-size:0.9rem; }
        tr:hover { background:rgba(46,204,113,0.05); }
        .status-badge { padding:0.25rem 0.75rem; border-radius:6px; font-size:0.7rem; font-weight:700; text-transform:uppercase; display:inline-block; }
        .status-badge.funded { background:rgba(46,204,113,0.15); color:#2ECC71; }
        .status-badge.phase1 { background:rgba(52,152,219,0.15); color:#3498DB; }
        .status-badge.phase2 { background:rgba(243,156,18,0.15); color:#F39C12; }
        .status-badge.suspended { background:rgba(231,76,60,0.15); color:#E74C3C; }

        .alert { position:fixed; top:20px; right:74px; padding:1.25rem 1.5rem; border-radius:12px; font-size:0.95rem; font-weight:600; z-index:9999; box-shadow:0 8px 24px rgba(0,0,0,0.4); animation:slideInRight 0.3s ease-out; max-width:400px; display:flex; align-items:center; gap:0.75rem; }
        @keyframes slideInRight { from { transform:translateX(400px); opacity:0; } to { transform:translateX(0); opacity:1; } }
        @keyframes slideOutRight { from { transform:translateX(0); opacity:1; } to { transform:translateX(400px); opacity:0; } }
        .alert.hiding { animation:slideOutRight 0.3s ease-in forwards; }
        .alert.success { background:linear-gradient(135deg,#2ECC71,#27AE60); border:1px solid rgba(255,255,255,0.2); color:white; }
        .alert.success::before { content:'‚úì'; font-size:1.5rem; font-weight:bold; }
        .alert.error { background:linear-gradient(135deg,#E74C3C,#C0392B); border:1px solid rgba(255,255,255,0.2); color:white; }
        .alert.error::before { content:'‚úï'; font-size:1.5rem; font-weight:bold; }

        .empty-state { text-align:center; padding:3rem 2rem; color:#9AA0A6; }
        .chart-container { max-width:400px; margin:0 auto; padding:1rem; }
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:2rem; }
        .dashboard-header { text-align:center; margin-bottom:2.5rem; padding:2rem; border-bottom:1px solid rgba(230,232,235,0.1); }
        .dashboard-header h2 { font-size:2.5rem; font-weight:800; color:#E6E8EB; margin-bottom:0.5rem; }
        .dashboard-header .subtitle { color:#9AA0A6; font-size:0.95rem; }

        .bar-chart { width:100%; margin:1rem 0; }
        .bar-row { display:flex; align-items:center; gap:1rem; margin-bottom:1rem; }
        .bar-label { min-width:100px; font-size:0.85rem; font-weight:600; color:#E6E8EB; }
        .bar-track { flex:1; height:32px; background:rgba(230,232,235,0.05); border-radius:6px; overflow:hidden; }
        .bar-fill { height:100%; background:linear-gradient(90deg,#2ECC71,#27AE60); border-radius:6px; transition:width 0.5s ease; display:flex; align-items:center; justify-content:flex-end; padding-right:0.75rem; }
        .bar-value { font-size:0.85rem; font-weight:700; color:#121417; }
        .bar-count { min-width:60px; text-align:right; font-weight:700; color:#E6E8EB; }

        .gauge-container { position:relative; max-width:300px; margin:2rem auto; }
        .gauge-text { position:absolute; top:60%; left:50%; transform:translate(-50%,-50%); text-align:center; }
        .gauge-percentage { font-size:3rem; font-weight:800; color:#2ECC71; }
        .gauge-label { font-size:0.85rem; color:#9AA0A6; text-transform:uppercase; font-weight:600; }

        .wrapped-header { background:linear-gradient(135deg,rgba(243,156,18,0.1),rgba(46,204,113,0.1)); border-radius:12px; padding:2rem; margin-bottom:2rem; text-align:center; border:1px solid rgba(243,156,18,0.2); }
        .wrapped-title { font-size:2.5rem; font-weight:800; background:linear-gradient(135deg,#F39C12,#2ECC71); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.5rem; }
        .wrapped-subtitle { color:#9AA0A6; font-size:0.95rem; text-transform:uppercase; letter-spacing:0.1em; }
        .achievement-card { background:linear-gradient(135deg,rgba(46,204,113,0.05),rgba(52,152,219,0.05)); border:1px solid rgba(46,204,113,0.2); padding:1.5rem; border-radius:12px; margin-bottom:1rem; display:flex; align-items:center; gap:1rem; }
        .achievement-icon { font-size:2rem; }
        .achievement-content h4 { color:#E6E8EB; margin-bottom:0.25rem; }
        .achievement-content p { color:#9AA0A6; font-size:0.85rem; }
        .wrapped-generator { background:linear-gradient(135deg,rgba(243,156,18,0.1),rgba(46,204,113,0.1)); border:2px solid rgba(243,156,18,0.3); border-radius:12px; padding:2rem; margin-top:2rem; }
        .config-section { background:#181B20; border-radius:8px; padding:1.5rem; margin-bottom:1.5rem; }
        .config-title { font-size:0.9rem; font-weight:700; text-transform:uppercase; color:#F39C12; margin-bottom:1rem; letter-spacing:0.05em; }
        .metric-checkbox { display:flex; align-items:center; gap:0.75rem; padding:0.75rem; background:rgba(230,232,235,0.03); border-radius:6px; margin-bottom:0.5rem; cursor:pointer; transition:all 0.2s; }
        .metric-checkbox:hover { background:rgba(46,204,113,0.1); }
        .metric-checkbox input[type="checkbox"] { width:20px; height:20px; cursor:pointer; }
        .metric-checkbox label { cursor:pointer; flex:1; font-size:0.9rem; color:#E6E8EB; }
        .design-selector { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:1rem; margin-top:1rem; }
        .design-option { padding:1rem; background:rgba(230,232,235,0.05); border:2px solid transparent; border-radius:8px; text-align:center; cursor:pointer; transition:all 0.3s; }
        .design-option:hover { border-color:#F39C12; }
        .design-option.selected { border-color:#2ECC71; background:rgba(46,204,113,0.1); }
        .design-preview { width:100%; height:100px; border-radius:6px; margin-bottom:0.5rem; }
        .design-preview.gradient1 { background:linear-gradient(135deg,#F39C12,#E67E22); }
        .design-preview.gradient2 { background:linear-gradient(135deg,#2ECC71,#27AE60); }
        .design-preview.gradient3 { background:linear-gradient(135deg,#3498DB,#2980B9); }
        .design-preview.dark { background:#121417; }
        .btn-primary { padding:1rem 2rem; background:linear-gradient(135deg,#F39C12,#E67E22); color:white; border:none; border-radius:8px; font-family:'Inter',sans-serif; font-size:1rem; font-weight:700; text-transform:uppercase; cursor:pointer; transition:all 0.3s; letter-spacing:0.05em; }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(243,156,18,0.4); }
        .btn-secondary { padding:0.75rem 1.5rem; background:#9AA0A6; color:#121417; border:none; border-radius:8px; font-family:'Inter',sans-serif; font-size:0.9rem; font-weight:600; cursor:pointer; transition:all 0.3s; }
        .btn-secondary:hover { background:#7F8C8D; }

        /* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
        .login-overlay {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:linear-gradient(135deg,#0c0e11 0%,#121417 50%,#0f1215 100%);
            z-index:10000; display:flex; justify-content:center; align-items:center;
            opacity:1; transition:opacity 0.5s ease-out; overflow:hidden;
        }
        .login-overlay.hidden { opacity:0; pointer-events:none; }

        /* ‚îÄ‚îÄ‚îÄ LOGIN CURSOR CANVAS ‚îÄ‚îÄ‚îÄ */
        #loginCursorCanvas {
            position:absolute; top:0; left:0; width:100%; height:100%;
            pointer-events:none; z-index:1;
        }

        .login-box {
            position:relative; z-index:2;
            background:#181B20; border-radius:20px; padding:3rem; max-width:400px; width:90%;
            border:1px solid rgba(46,204,113,0.15); box-shadow:0 20px 60px rgba(0,0,0,0.5);
            animation:loginSlideIn 0.5s ease-out;
            backdrop-filter:blur(4px);
        }
        @keyframes loginSlideIn { from { transform:translateY(30px); opacity:0; } to { transform:translateY(0); opacity:1; } }
        .login-header { text-align:center; margin-bottom:2rem; }
        .login-header h1 { font-size:2rem; font-weight:800; background:linear-gradient(135deg,#E6E8EB 0%,#2ECC71 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.5rem; }
        .login-header p { color:#9AA0A6; font-size:0.9rem; }
        .login-form .form-group { margin-bottom:1.5rem; }
        .login-form label { display:block; font-size:0.85rem; font-weight:600; color:#9AA0A6; margin-bottom:0.5rem; text-transform:uppercase; letter-spacing:0.05em; }
        .login-form input { width:100%; padding:1rem; background:#121417; border:1px solid rgba(230,232,235,0.1); border-radius:10px; color:#E6E8EB; font-family:'Inter',sans-serif; font-size:1rem; transition:all 0.3s; }
        .login-form input:focus { outline:none; border-color:#2ECC71; box-shadow:0 0 0 3px rgba(46,204,113,0.1); }
        .login-btn { width:100%; padding:1rem; background:linear-gradient(135deg,#2ECC71,#27AE60); color:white; border:none; border-radius:10px; font-family:'Inter',sans-serif; font-size:1rem; font-weight:700; cursor:pointer; transition:all 0.3s; text-transform:uppercase; letter-spacing:0.05em; }
        .login-btn:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(46,204,113,0.3); }
        .dev-bypass { margin-top:1rem; text-align:center; padding-top:1rem; border-top:1px solid rgba(230,232,235,0.05); }
        .dev-bypass button { background:transparent; border:1px solid rgba(230,232,235,0.1); color:#9AA0A6; padding:0.5rem 1rem; border-radius:6px; font-family:'Inter',sans-serif; font-size:0.75rem; cursor:pointer; transition:all 0.3s; }
        .dev-bypass button:hover { border-color:#2ECC71; color:#2ECC71; }
        .login-error { background:rgba(231,76,60,0.1); border:1px solid rgba(231,76,60,0.3); color:#E74C3C; padding:0.75rem; border-radius:8px; margin-bottom:1rem; font-size:0.85rem; text-align:center; display:none; }
        .login-error.show { display:block; animation:shake 0.5s; }
        @keyframes shake { 0%,100% { transform:translateX(0); } 25% { transform:translateX(-10px); } 75% { transform:translateX(10px); } }

        /* ‚îÄ‚îÄ‚îÄ STATUS TRANSITION HINT ‚îÄ‚îÄ‚îÄ */
        .status-hint {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #9AA0A6;
            background: rgba(230,232,235,0.05);
            border: 1px solid rgba(230,232,235,0.08);
            border-radius: 6px;
            padding: 0.35rem 0.65rem;
            transition: all 0.2s;
        }
        .status-hint .arrow { color: #2ECC71; font-weight: 700; margin: 0 0.15rem; }
        .status-hint .from-badge {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
        }
        .status-hint .from-badge.phase1 { background: rgba(52,152,219,0.15); color: #3498DB; }
        .status-hint .from-badge.phase2 { background: rgba(243,156,18,0.15); color: #F39C12; }
        .status-hint .from-badge.funded { background: rgba(46,204,113,0.15); color: #2ECC71; }
        .status-hint .from-badge.suspended { background: rgba(231,76,60,0.15); color: #E74C3C; }
        .status-hint .to-badge {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            background: rgba(46,204,113,0.08);
            color: #2ECC71;
            border: 1px solid rgba(46,204,113,0.2);
        }
        .status-hint.no-transitions {
            color: #E74C3C;
            border-color: rgba(231,76,60,0.2);
            background: rgba(231,76,60,0.04);
        }

        @media (max-width:968px) { .grid-2 { grid-template-columns:1fr; } .kpi-grid { grid-template-columns:1fr; } .lang-globe-btn { top:10px; right:10px; } .history-fab { bottom:16px; left:16px; } .history-panel { left:16px; bottom:76px; } }
    </style>
</head>
<body>

    <!-- Globe Language Selector -->
    <button class="lang-globe-btn" id="langGlobeBtn" onclick="toggleLangDropdown()" title="Language / Idioma">üåê</button>
    <div class="lang-dropdown" id="langDropdown">
        <button class="lang-opt active" id="opt-es" onclick="setLanguage('es')"><span class="flag">üá™üá∏</span> Espa√±ol</button>
        <button class="lang-opt" id="opt-en" onclick="setLanguage('en')"><span class="flag">üá¨üáß</span> English</button>
    </div>

    <!-- History FAB -->
    <button class="history-fab" id="historyFab" onclick="toggleHistoryPanel()" title="Recent actions">
        üïí
        <span class="badge" id="historyBadge">0</span>
    </button>
    <div class="history-panel" id="historyPanel">
        <div class="history-panel-header">
            <span class="history-panel-title" data-i18n="history.title">Recent Actions</span>
            <button class="history-panel-close" onclick="toggleHistoryPanel()">‚úï</button>
        </div>
        <div class="history-panel-body" id="historyPanelBody"></div>
    </div>

    <!-- Login Screen -->
    <div id="loginOverlay" class="login-overlay">
        <canvas id="loginCursorCanvas"></canvas>
        <div class="login-box">
            <div class="login-header">
                <h1 data-i18n="app.name">NEVER QUIT</h1>
                <p data-i18n="login.subtitle">Dashboard de Gesti√≥n Profesional</p>
            </div>
            <div id="loginError" class="login-error" data-i18n="login.error">Usuario o contrase√±a incorrectos</div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label data-i18n="login.username">Usuario</label>
                    <input type="text" id="loginUsername" placeholder="Introduce tu usuario" autocomplete="username">
                </div>
                <div class="form-group">
                    <label data-i18n="login.password">Contrase√±a</label>
                    <input type="password" id="loginPassword" placeholder="Introduce tu contrase√±a" autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn" data-i18n="login.submit">Entrar al Dashboard</button>
            </form>
            <div class="dev-bypass">
                <button onclick="bypassLogin()" data-i18n="login.devMode">üîß Modo Desarrollo (Skip Login)</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Reset Modal -->
        <div id="resetModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header" data-i18n="modal.resetTitle">‚ö†Ô∏è Confirmar Reset</div>
                <div class="modal-body">
                    <span data-i18n="modal.resetConfirm">¬øEst√°s seguro? Esta acci√≥n <strong>no se puede deshacer</strong>.</span><br><br>
                    <label style="display:block;font-size:0.85rem;font-weight:600;color:#E74C3C;margin-bottom:0.5rem;text-transform:uppercase;" data-i18n="modal.typeReset">Escribe RESET para confirmar:</label>
                    <input type="text" id="resetConfirmInput" placeholder="RESET"
                        style="width:100%;padding:0.75rem;background:#121417;border:2px solid rgba(231,76,60,0.3);border-radius:8px;color:#E6E8EB;font-family:'Inter',sans-serif;font-size:1rem;text-transform:uppercase;letter-spacing:0.1em;"
                        oninput="document.getElementById('confirmResetBtn').disabled=this.value.toUpperCase()!=='RESET'">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeResetModal()" data-i18n="modal.cancel">Cancelar</button>
                    <button id="confirmResetBtn" class="modal-btn confirm" onclick="confirmReset()" disabled style="opacity:0.5;cursor:not-allowed;" data-i18n="modal.confirmDelete">S√≠, Eliminar Todo</button>
                </div>
            </div>
        </div>

        <div class="header">
            <h1 data-i18n="app.fullName">NEVER QUIT DASHBOARD</h1>
            <p data-i18n="app.tagline">Sistema de Gesti√≥n de Capital Profesional</p>
            <div class="year-selector">
                <label data-i18n="year.label">A√ëO ACTIVO:</label>
                <select id="yearSelect">
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                </select>
                <button class="btn-reset" onclick="openResetModal()" data-i18n="actions.resetData">üîÑ Reset Datos</button>
                <button class="btn-reset" onclick="logout()" style="background:#9AA0A6;" data-i18n="actions.logout">üö™ Salir</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="tabs">
            <button class="tab active" data-tab="control" data-i18n="tabs.control">Control Center</button>
            <button class="tab" data-tab="overview" data-i18n="tabs.overview">Overview</button>
            <button class="tab" data-tab="performance" data-i18n="tabs.performance">Performance</button>
            <button class="tab" data-tab="propfirm" data-i18n="tabs.propfirm">Prop Firm</button>
            <button class="tab" data-tab="ceoview" data-i18n="tabs.ceoview">CEO View</button>
            <button class="tab" data-tab="efficiency" data-i18n="tabs.efficiency">Capital Efficiency</button>
            <button class="tab" data-tab="wrapped" data-i18n="tabs.wrapped">Wrapped</button>
        </div>

        <!-- CONTROL CENTER -->
        <div id="control" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <div class="card-title" data-i18n="forms.createTitle">Create Challenge</div>
                    <div class="form-group"><label data-i18n="forms.propFirm">Prop Firm</label>
                        <select id="createPropFirm"><option>FTMO</option><option>Alpha Capital Group</option><option>Orion Funded</option><option>Bullfy</option><option>FundedNext</option><option>The5ers</option><option>MyForexFunds</option></select>
                    </div>
                    <div class="form-group"><label data-i18n="forms.accountSize">Account Size</label>
                        <select id="createAccountSize"><option>10K</option><option>25K</option><option selected>50K</option><option>100K</option><option>200K</option></select>
                    </div>
                    <div class="form-group"><label data-i18n="forms.purchaseDate">Purchase Date</label><input type="date" id="createPurchaseDate"></div>
                    <div class="form-group"><label data-i18n="forms.challengeCost">Challenge Cost ($)</label><input type="number" id="createChallengeCost" placeholder="345.00" min="0" step="0.01"></div>
                    <div class="form-group"><label data-i18n="forms.accountNumber">Account Number</label><input type="text" id="createAccountNumber" placeholder="N√∫mero de cuenta"></div>
                    <button class="btn" onclick="createChallenge()" data-i18n="forms.createButton">Crear Challenge</button>
                </div>
                <div class="card">
                    <div class="card-title" data-i18n="forms.updateTitle">Update Challenge</div>
                    <div class="form-group"><label data-i18n="forms.account">Account</label><select id="updateAccountId"></select></div>
                    <div class="form-group">
                        <label data-i18n="forms.newStatus">New Status</label>
                        <select id="updateNewStatus"><option value="PHASE 1">PHASE 1</option><option value="PHASE 2">PHASE 2</option><option value="FUNDED">FUNDED</option><option value="SUSPENDED">SUSPENDED</option></select>
                        <div id="statusTransitionHint" class="status-hint" style="display:none;"></div>
                    </div>
                    <div class="form-group"><label data-i18n="forms.statusDate">Status Date</label><input type="date" id="updateStatusDate"></div>
                    <button class="btn" onclick="updateChallenge()" data-i18n="forms.updateButton">Actualitzar Challenge</button>
                </div>
                <div class="card">
                    <div class="card-title" data-i18n="forms.payoutTitle">Register Payout</div>
                    <div class="form-group"><label data-i18n="forms.account">Account</label><select id="payoutAccountId"></select></div>
                    <div class="form-group"><label data-i18n="forms.amount">Amount ($)</label><input type="number" id="payoutAmount" placeholder="2500.00" min="0" step="0.01"></div>
                    <div class="form-group"><label data-i18n="forms.payoutDate">Payout Date</label><input type="date" id="payoutDate"></div>
                    <div class="form-group"><label data-i18n="forms.status">Status</label>
                        <select id="payoutStatus">
                            <option value="Solicitado" data-i18n="status.requested">Solicitado</option>
                            <option value="Aprobado" data-i18n="status.approved">Aprobado</option>
                            <option value="Recibido" selected data-i18n="status.received">Recibido</option>
                        </select>
                    </div>
                    <button class="btn" onclick="registerPayout()" data-i18n="forms.payoutButton">Registrar Payout</button>
                </div>
            </div>
        </div>

        <div id="overview" class="tab-content"></div>
        <div id="performance" class="tab-content"></div>
        <div id="propfirm" class="tab-content"></div>
        <div id="ceoview" class="tab-content"></div>
        <div id="efficiency" class="tab-content"></div>
        <div id="wrapped" class="tab-content"></div>
    </div>

<script>
// ============================================
// LOGIN CURSOR EFFECT ‚Äî Particle Constellation
// ============================================
(function initLoginCursor() {
    const overlay = document.getElementById('loginOverlay');
    const canvas  = document.getElementById('loginCursorCanvas');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let W, H, mouse = { x: -999, y: -999 };
    const PARTICLES = [];
    const PARTICLE_COUNT = 110;
    const CONNECTION_DIST = 130;
    const COLORS = ['#2ECC71','#27AE60','#1abc9c','#58d68d','#48c774'];

    function resize() {
        W = canvas.width  = overlay.offsetWidth;
        H = canvas.height = overlay.offsetHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    // Create background floating particles
    for (let i = 0; i < PARTICLE_COUNT; i++) {
        PARTICLES.push({
            x: Math.random() * W,
            y: Math.random() * H,
            vx: (Math.random() - 0.5) * 0.45,
            vy: (Math.random() - 0.5) * 0.45,
            r: Math.random() * 2.2 + 0.8,
            color: COLORS[Math.floor(Math.random() * COLORS.length)],
            alpha: Math.random() * 0.5 + 0.2
        });
    }

    // Mouse trail sparks
    const SPARKS = [];

    overlay.addEventListener('mousemove', function(e) {
        const rect = overlay.getBoundingClientRect();
        mouse.x = e.clientX - rect.left;
        mouse.y = e.clientY - rect.top;

        // Spawn sparks
        for (let i = 0; i < 3; i++) {
            SPARKS.push({
                x: mouse.x + (Math.random() - 0.5) * 10,
                y: mouse.y + (Math.random() - 0.5) * 10,
                vx: (Math.random() - 0.5) * 2.5,
                vy: (Math.random() - 0.5) * 2.5 - 0.8,
                life: 1.0,
                decay: Math.random() * 0.03 + 0.025,
                r: Math.random() * 3 + 1,
                color: COLORS[Math.floor(Math.random() * COLORS.length)]
            });
        }
    });

    function loop() {
        ctx.clearRect(0, 0, W, H);

        // Radial glow under cursor
        if (mouse.x > 0) {
            const grd = ctx.createRadialGradient(mouse.x, mouse.y, 0, mouse.x, mouse.y, 180);
            grd.addColorStop(0, 'rgba(46,204,113,0.12)');
            grd.addColorStop(0.5, 'rgba(46,204,113,0.04)');
            grd.addColorStop(1, 'rgba(46,204,113,0)');
            ctx.fillStyle = grd;
            ctx.beginPath();
            ctx.arc(mouse.x, mouse.y, 180, 0, Math.PI * 2);
            ctx.fill();
        }

        // Update & draw background particles
        for (let i = 0; i < PARTICLES.length; i++) {
            const p = PARTICLES[i];
            p.x += p.vx;
            p.y += p.vy;
            if (p.x < 0) p.x = W;
            if (p.x > W) p.x = 0;
            if (p.y < 0) p.y = H;
            if (p.y > H) p.y = 0;

            // Gentle mouse repulsion
            const dx = p.x - mouse.x;
            const dy = p.y - mouse.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 80) {
                const force = (80 - dist) / 80 * 0.5;
                p.x += (dx / dist) * force;
                p.y += (dy / dist) * force;
            }

            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.alpha;
            ctx.fill();
            ctx.globalAlpha = 1;
        }

        // Draw connections between nearby particles
        ctx.lineWidth = 0.5;
        for (let i = 0; i < PARTICLES.length; i++) {
            for (let j = i + 1; j < PARTICLES.length; j++) {
                const dx = PARTICLES[i].x - PARTICLES[j].x;
                const dy = PARTICLES[i].y - PARTICLES[j].y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < CONNECTION_DIST) {
                    const alpha = (1 - dist / CONNECTION_DIST) * 0.18;
                    ctx.strokeStyle = `rgba(46,204,113,${alpha})`;
                    ctx.globalAlpha = 1;
                    ctx.beginPath();
                    ctx.moveTo(PARTICLES[i].x, PARTICLES[i].y);
                    ctx.lineTo(PARTICLES[j].x, PARTICLES[j].y);
                    ctx.stroke();
                }
            }
            // Connect particles to mouse
            const dx = PARTICLES[i].x - mouse.x;
            const dy = PARTICLES[i].y - mouse.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < CONNECTION_DIST * 1.3) {
                const alpha = (1 - dist / (CONNECTION_DIST * 1.3)) * 0.4;
                ctx.strokeStyle = `rgba(46,204,113,${alpha})`;
                ctx.lineWidth = 0.8;
                ctx.beginPath();
                ctx.moveTo(PARTICLES[i].x, PARTICLES[i].y);
                ctx.lineTo(mouse.x, mouse.y);
                ctx.stroke();
            }
        }

        // Update & draw sparks
        for (let i = SPARKS.length - 1; i >= 0; i--) {
            const s = SPARKS[i];
            s.x += s.vx;
            s.y += s.vy;
            s.life -= s.decay;
            if (s.life <= 0) { SPARKS.splice(i, 1); continue; }
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r * s.life, 0, Math.PI * 2);
            ctx.fillStyle = s.color;
            ctx.globalAlpha = s.life * 0.85;
            ctx.fill();
        }

        ctx.globalAlpha = 1;
        requestAnimationFrame(loop);
    }
    loop();
})();

// ============================================
// i18n
// ============================================
const i18n = {
    es: {
        app: { name:"NEVER QUIT", fullName:"NEVER QUIT DASHBOARD", tagline:"Sistema de Gesti√≥n de Capital Profesional" },
        login: { subtitle:"Dashboard de Gesti√≥n Profesional", username:"Usuario", password:"Contrase√±a", usernamePlaceholder:"Introduce tu usuario", passwordPlaceholder:"Introduce tu contrase√±a", submit:"Entrar al Dashboard", error:"Usuario o contrase√±a incorrectos", devMode:"üîß Modo Desarrollo (Skip Login)" },
        modal: { resetTitle:"‚ö†Ô∏è Confirmar Reset", resetConfirm:"¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n <strong>no se puede deshacer</strong>.", resetItems:"Se borrar√°n:", itemChallenges:"Todas las challenges", itemPayouts:"Todos los payouts", itemHistory:"Todo el historial", typeReset:"Escribe RESET para confirmar:", cancel:"Cancelar", confirmDelete:"S√≠, Eliminar Todo" },
        year: { label:"A√ëO ACTIVO:" },
        actions: { resetData:"üîÑ Reset Datos", logout:"üö™ Salir" },
        tabs: { control:"Control Center", overview:"Overview", performance:"Performance", propfirm:"Prop Firm", ceoview:"CEO View", efficiency:"Capital Efficiency", wrapped:"Wrapped" },
        forms: { createTitle:"Create Challenge", updateTitle:"Update Challenge", payoutTitle:"Register Payout", propFirm:"Prop Firm", accountSize:"Account Size", purchaseDate:"Purchase Date", challengeCost:"Challenge Cost ($)", accountNumber:"Account Number", createButton:"Crear Challenge", account:"Account", newStatus:"New Status", statusDate:"Status Date", updateButton:"Actualitzar Challenge", amount:"Amount ($)", payoutDate:"Payout Date", status:"Status", payoutButton:"Registrar Payout", from:"desde" },
        status: { requested:"Solicitado", approved:"Aprobado", received:"Recibido" },
        overview: { title:"OVERVIEW", updated:"Actualizado", activeFundedCapital:"Active Funded Capital", totalPayouts:"Total Payouts", activeFundedAccounts:"Active Funded Accounts", roiAnnual:"ROI Annual", costs:"Costos", accounts:"cuentas", payments:"pagos", ofTotal:"de total", accountStatus:"‚óá ACCOUNT STATUS", status:"Status", count:"Count", pctActive:"% Activas", totalActive:"Total activas", excluded:"suspendida excluida", excludedPlural:"suspendidas excluidas", noSuspended:"Sin suspendidas", myAccounts:"‚óá MIS CUENTAS", account:"Cuenta", firm:"Prop Firm", size:"Tama√±o", cost:"Coste", date:"Fecha", received:"Payouts recibidos", noAccounts:"Sin cuentas activas" },
        performance: { title:"PERFORMANCE", noData:"Sin challenges para", createFirst:"crea una en Control Center", phase1Success:"‚óá TASA DE √âXITO PHASE 1", phase2Success:"TASA DE √âXITO PHASE 2", avgCostFunded:"AVG. COST PER FUNDED ACCOUNT", bestFirmRoi:"BEST PROP FIRM ROI", totalCosts:"Total costs", funded:"funded", challengeSuccess:"‚óá CHALLENGE SUCCESS RATE", approvalRate:"APPROVAL RATE", totalChallenges:"Challenges Totales", inPhase1:"En Phase 1", current:"actual", passedP1:"Pasaron P1", inPhase2:"En Phase 2", summary:"Resumen", passedPhase1:"supera Phase 1", passedPhase2:"supera Phase 2", fundedAccounts:"Cuentas Fondeadas", roiByFirm:"‚óá ROI BY PROP FIRM", of:"de" },
        propfirm: { title:"PROP FIRM", noAccounts:"Sin cuentas de", inYear:"en", historical:"Rendimiento Hist√≥rico", updated:"Actualizado", challengesBought:"‚óá CHALLENGES COMPRADAS", accountsFunded:"CUENTAS FONDEADAS", invested:"$ INVERTIDO", payouts:"$ PAYOUTS", roi:"ROI", accountStatus:"‚óá ACCOUNT STATUS", rules:"‚óá REGLAS DE", phase1:"Phase 1", phase2:"Phase 2", maxDailyLoss:"Max Daily Loss", maxLoss:"Max Loss", profitSplit:"Profit Split", minTradingDays:"Min Trading Days", newsChallenge:"News Trading (Challenge)", newsFunded:"News Trading (Funded)", note:"Nota", closed:"CERRADA desde 2023 - Reapertura esperada 2026" },
        ceoview: { title:"CEO VIEW", allTime:"ALL TIME", mode:"Modo: PRO", noHistory:"Sin historial todav√≠a", whenYouHave:"Cuando tengas challenges y payouts, aqu√≠ ver√°s tu evoluci√≥n global", totalPayouts:"‚óá TOTAL PAYOUTS", totalInvested:"TOTAL INVESTED", capitalMultiple:"M√öLTIPLO DE CAPITAL", bestYear:"BEST YEAR", yearlyEvolution:"‚óá EVOLUCI√ìN POR A√ëO", progressMetrics:"‚óá M√âTRICAS DE PROGRESO (historial de fases)", calculatedFrom:"Calculado desde el historial de cambios de estado", avgAttempts:"AVG. INTENTOS HASTA FONDEO", phasesPerAccount:"fases por cuenta fondeada", avgDaysPhase1:"AVG. D√çAS EN PHASE 1", untilPassP1:"hasta superar Phase 1", avgDaysPhase2:"AVG. D√çAS EN PHASE 2", untilFunded:"hasta conseguir fondeo", historyEntries:"ENTRADAS EN HISTORIAL", changesRecorded:"cambios de fase registrados", recentPayouts:"‚óá √öLTIMOS PAYOUTS", noPayouts:"No hay payouts registrados", date:"Fecha", account:"Cuenta", firm:"Prop Firm", amount:"Monto", status:"Estado" },
        efficiency: { title:"CAPITAL EFFICIENCY", noData:"Sin datos ‚Äî crea tu primera challenge", withdrawnInvested:"$ WITHDRAWN / $ INVESTED", avgTimeFunding:"TIEMPO PROMEDIO A FONDEO", selfFundedSystem:"SISTEMA AUTO-FINANCIADO", breakEven:"TIMING BREAK-EVEN", projection:"proyecci√≥n basada en ritmo actual", reached:"‚úÖ Alcanzado", pending:"Pendiente", fundedInvested:"‚óá FUNDED / INVESTED", selfFundingStatus:"‚óá SELF-FUNDING STATUS", recoveryTrend:"‚óá TENDENCIA ACUMULADA DE RECUPERACI√ìN", recoverySubtitle:"% de lo invertido recuperado mediante payouts ¬∑ Datos reales mes a mes" },
        wrapped: { title:"PROP FIRM WRAPPED", subtitle:"TU A√ëO DE TRADING EN REVISI√ìN", synced:"‚Üë sincronizado con el selector de a√±o del header", noData:"Sin datos para", createFirst:"Crea tu primera challenge en Control Center para ver tu Wrapped", totalPayouts:"TOTAL PAYOUTS", avgRoi:"ROI PROMEDIO", quickestFunding:"FONDEO M√ÅS R√ÅPIDO", days:"DAYS", byFirm:"‚óá PAYOUTS POR PROP FIRM", accountsFunded:"üå± CUENTAS FONDEADAS", capitalMultiple:"üí∞ M√öLTIPLO DE CAPITAL", selfFunded:"‚ôªÔ∏è SISTEMA AUTO-FINANCIADO", phase1Success:"% TASA DE √âXITO PHASE 1", passedPhase1Of:"de challenges superaron Phase 1", phase2Success:"% TASA DE √âXITO PHASE 2", converted:"Convertiste", toFunded:"de intentos de Phase 2 en cuentas fondeadas", avgTime:"DAYS TIEMPO PROMEDIO HASTA FONDEO", avgFundedDays:"En promedio, fondeaste cuentas en", daysLower:"d√≠as", completed:"COMPLETADAS", successfullyFunded:"Fondeaste exitosamente", account:"cuenta", accounts:"cuentas", generatorTitle:"üé® GENERAR TU WRAPPED PERSONALIZADO", period:"‚è±Ô∏è Periodo", monthly:"Mensual", yearly:"Anual", metrics:"üìä M√©tricas a Incluir", design:"üé® Dise√±o", fire:"Fire", success:"Success", ocean:"Ocean", dark:"Dark", preview:"üëÅÔ∏è Vista Previa", back:"‚Üê Volver a Editar", download:"üíæ Descargar PNG (1080x1920)", totalPayoutsShort:"üí∞ Total Payouts", roi:"üìà ROI", accountsFundedShort:"üéØ Cuentas Fondeadas", invested:"üí∏ Total Invertido", winRateP1:"‚úÖ Win Rate Phase 1", winRateP2:"üî• Win Rate Phase 2", fastest:"‚ö° Fondeo M√°s R√°pido", avgTimeShort:"‚è±Ô∏è Tiempo Promedio Fondeo", multiple:"üìä M√∫ltiplo de Capital", bestFirm:"üèÜ Mejor Prop Firm" },
        alerts: { fillFields:"‚ö†Ô∏è Completa todos los campos", futureDate:"La fecha no puede ser futura", positiveCost:"‚ö†Ô∏è El costo debe ser mayor a 0", invalidSize:"‚ö†Ô∏è Tama√±o de cuenta no v√°lido", duplicateAccount:"Este n√∫mero de cuenta ya existe para el a√±o", challengeCreated:"Challenge creada exitosamente", selectAccount:"‚ö†Ô∏è Selecciona una cuenta y fecha", statusUpdated:"Estado actualizado", positiveAmount:"‚ö†Ô∏è El monto debe ser mayor a 0", payoutTooHigh:"supera 2x el tama√±o de la cuenta. Verifica el importe.", payoutRegistered:"Payout registrado", dataDeleted:"‚úÖ Todos los datos han sido eliminados", typeReset:"‚ö†Ô∏è Escribe RESET para confirmar", deleted:"Eliminado", downloaded:"‚úÖ Wrapped descargado como PNG" },
        history: { title:"Acciones Recientes", challenges:"Challenges creadas", statuses:"Actualizaciones de estado", payouts:"Payouts registrados", empty:"Sin acciones recientes", deleteConfirm:"¬øEliminar esta entrada?" }
    },
    en: {
        app: { name:"NEVER QUIT", fullName:"NEVER QUIT DASHBOARD", tagline:"Professional Capital Management System" },
        login: { subtitle:"Professional Management Dashboard", username:"Username", password:"Password", submit:"Enter Dashboard", error:"Incorrect username or password", devMode:"üîß Dev Mode (Skip Login)" },
        modal: { resetTitle:"‚ö†Ô∏è Confirm Reset", resetConfirm:"Are you sure you want to delete all data? This action <strong>cannot be undone</strong>.", resetItems:"Will be deleted:", itemChallenges:"All challenges", itemPayouts:"All payouts", itemHistory:"All history", typeReset:"Type RESET to confirm:", cancel:"Cancel", confirmDelete:"Yes, Delete Everything" },
        year: { label:"ACTIVE YEAR:" },
        actions: { resetData:"üîÑ Reset Data", logout:"üö™ Logout" },
        tabs: { control:"Control Center", overview:"Overview", performance:"Performance", propfirm:"Prop Firm", ceoview:"CEO View", efficiency:"Capital Efficiency", wrapped:"Wrapped" },
        forms: { createTitle:"Create Challenge", updateTitle:"Update Challenge", payoutTitle:"Register Payout", propFirm:"Prop Firm", accountSize:"Account Size", purchaseDate:"Purchase Date", challengeCost:"Challenge Cost ($)", accountNumber:"Account Number", createButton:"Create Challenge", account:"Account", newStatus:"New Status", statusDate:"Status Date", updateButton:"Update Challenge", amount:"Amount ($)", payoutDate:"Payout Date", status:"Status", payoutButton:"Register Payout", from:"from" },
        status: { requested:"Requested", approved:"Approved", received:"Received" },
        overview: { title:"OVERVIEW", updated:"Updated", activeFundedCapital:"Active Funded Capital", totalPayouts:"Total Payouts", activeFundedAccounts:"Active Funded Accounts", roiAnnual:"Annual ROI", costs:"Costs", accounts:"accounts", payments:"payments", ofTotal:"of total", accountStatus:"‚óá ACCOUNT STATUS", status:"Status", count:"Count", pctActive:"% Active", totalActive:"Total active", excluded:"suspended excluded", excludedPlural:"suspended excluded", noSuspended:"No suspended", myAccounts:"‚óá MY ACCOUNTS", account:"Account", firm:"Prop Firm", size:"Size", cost:"Cost", date:"Date", received:"Payouts received", noAccounts:"No active accounts" },
        performance: { title:"PERFORMANCE", noData:"No challenges for", createFirst:"create one in Control Center", phase1Success:"‚óá PHASE 1 SUCCESS RATE", phase2Success:"PHASE 2 SUCCESS RATE", avgCostFunded:"AVG. COST PER FUNDED ACCOUNT", bestFirmRoi:"BEST PROP FIRM ROI", totalCosts:"Total costs", funded:"funded", challengeSuccess:"‚óá CHALLENGE SUCCESS RATE", approvalRate:"APPROVAL RATE", totalChallenges:"Total Challenges", inPhase1:"In Phase 1", current:"current", passedP1:"Passed P1", inPhase2:"In Phase 2", summary:"Summary", passedPhase1:"pass Phase 1", passedPhase2:"pass Phase 2", fundedAccounts:"Funded Accounts", roiByFirm:"‚óá ROI BY PROP FIRM", of:"of" },
        propfirm: { title:"PROP FIRM", noAccounts:"No accounts from", inYear:"in", historical:"Historical Performance", updated:"Updated", challengesBought:"‚óá CHALLENGES BOUGHT", accountsFunded:"FUNDED ACCOUNTS", invested:"$ INVESTED", payouts:"$ PAYOUTS", roi:"ROI", accountStatus:"‚óá ACCOUNT STATUS", rules:"‚óá RULES OF", phase1:"Phase 1", phase2:"Phase 2", maxDailyLoss:"Max Daily Loss", maxLoss:"Max Loss", profitSplit:"Profit Split", minTradingDays:"Min Trading Days", newsChallenge:"News Trading (Challenge)", newsFunded:"News Trading (Funded)", note:"Note", closed:"CLOSED since 2023 - Reopening expected 2026" },
        ceoview: { title:"CEO VIEW", allTime:"ALL TIME", mode:"Mode: PRO", noHistory:"No history yet", whenYouHave:"When you have challenges and payouts, you'll see your global evolution here", totalPayouts:"‚óá TOTAL PAYOUTS", totalInvested:"TOTAL INVESTED", capitalMultiple:"CAPITAL MULTIPLE", bestYear:"BEST YEAR", yearlyEvolution:"‚óá YEARLY EVOLUTION", progressMetrics:"‚óá PROGRESS METRICS (phase history)", calculatedFrom:"Calculated from status change history", avgAttempts:"AVG. ATTEMPTS TO FUNDING", phasesPerAccount:"phases per funded account", avgDaysPhase1:"AVG. DAYS IN PHASE 1", untilPassP1:"until passing Phase 1", avgDaysPhase2:"AVG. DAYS IN PHASE 2", untilFunded:"until getting funded", historyEntries:"HISTORY ENTRIES", changesRecorded:"phase changes recorded", recentPayouts:"‚óá RECENT PAYOUTS", noPayouts:"No payouts registered", date:"Date", account:"Account", firm:"Prop Firm", amount:"Amount", status:"Status" },
        efficiency: { title:"CAPITAL EFFICIENCY", noData:"No data ‚Äî create your first challenge", withdrawnInvested:"$ WITHDRAWN / $ INVESTED", avgTimeFunding:"AVG. TIME TO FUNDING", selfFundedSystem:"SELF-FUNDED SYSTEM", breakEven:"BREAK-EVEN TIMING", projection:"projection based on current pace", reached:"‚úÖ Reached", pending:"Pending", fundedInvested:"‚óá FUNDED / INVESTED", selfFundingStatus:"‚óá SELF-FUNDING STATUS", recoveryTrend:"‚óá ACCUMULATED RECOVERY TREND", recoverySubtitle:"% of invested recovered via payouts ¬∑ Real month-by-month data" },
        wrapped: { title:"PROP FIRM WRAPPED", subtitle:"YOUR TRADING YEAR IN REVIEW", synced:"‚Üë synced with header year selector", noData:"No data for", createFirst:"Create your first challenge in Control Center to see your Wrapped", totalPayouts:"TOTAL PAYOUTS", avgRoi:"AVG ROI", quickestFunding:"QUICKEST FUNDING", days:"DAYS", byFirm:"‚óá PAYOUTS BY PROP FIRM", accountsFunded:"üå± FUNDED ACCOUNTS", capitalMultiple:"üí∞ CAPITAL MULTIPLE", selfFunded:"‚ôªÔ∏è SELF-FUNDED SYSTEM", phase1Success:"% PHASE 1 SUCCESS RATE", passedPhase1Of:"of challenges passed Phase 1", phase2Success:"% PHASE 2 SUCCESS RATE", converted:"You converted", toFunded:"of Phase 2 attempts into funded accounts", avgTime:"DAYS AVG TIME TO FUNDING", avgFundedDays:"On average, you funded accounts in", daysLower:"days", completed:"COMPLETED", successfullyFunded:"You successfully funded", account:"account", accounts:"accounts", generatorTitle:"üé® GENERATE YOUR CUSTOM WRAPPED", period:"‚è±Ô∏è Period", monthly:"Monthly", yearly:"Yearly", metrics:"üìä Metrics to Include", design:"üé® Design", fire:"Fire", success:"Success", ocean:"Ocean", dark:"Dark", preview:"üëÅÔ∏è Preview", back:"‚Üê Back to Edit", download:"üíæ Download PNG (1080x1920)", totalPayoutsShort:"üí∞ Total Payouts", roi:"üìà ROI", accountsFundedShort:"üéØ Funded Accounts", invested:"üí∏ Total Invested", winRateP1:"‚úÖ Win Rate Phase 1", winRateP2:"üî• Win Rate Phase 2", fastest:"‚ö° Fastest Funding", avgTimeShort:"‚è±Ô∏è Avg Time to Funding", multiple:"üìä Capital Multiple", bestFirm:"üèÜ Best Prop Firm" },
        alerts: { fillFields:"‚ö†Ô∏è Complete all fields", futureDate:"Date cannot be in the future", positiveCost:"‚ö†Ô∏è Cost must be greater than 0", invalidSize:"‚ö†Ô∏è Invalid account size", duplicateAccount:"This account number already exists for year", challengeCreated:"Challenge successfully created", selectAccount:"‚ö†Ô∏è Select an account and date", statusUpdated:"Status updated", positiveAmount:"‚ö†Ô∏è Amount must be greater than 0", payoutTooHigh:"exceeds 2x account size. Verify the amount.", payoutRegistered:"Payout registered", dataDeleted:"‚úÖ All data has been deleted", typeReset:"‚ö†Ô∏è Type RESET to confirm", deleted:"Deleted", downloaded:"‚úÖ Wrapped downloaded as PNG" },
        history: { title:"Recent Actions", challenges:"Challenges created", statuses:"Status updates", payouts:"Payouts registered", empty:"No recent actions", deleteConfirm:"Delete this entry?" }
    }
};

let currentLanguage = localStorage.getItem('neverQuitLanguage') || 'es';

function getTranslation(key) {
    const keys = key.split('.');
    let value = i18n[currentLanguage];
    for (const k of keys) { if (value && value[k] !== undefined) { value = value[k]; } else { return null; } }
    return value;
}
function t(key) { return getTranslation(key) || key; }

// Globe dropdown
let langDropdownOpen = false;
function toggleLangDropdown() {
    langDropdownOpen = !langDropdownOpen;
    document.getElementById('langDropdown').classList.toggle('visible', langDropdownOpen);
    document.getElementById('langGlobeBtn').classList.toggle('open', langDropdownOpen);
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('#langDropdown') && !e.target.closest('#langGlobeBtn') && langDropdownOpen) {
        langDropdownOpen = false;
        document.getElementById('langDropdown').classList.remove('visible');
        document.getElementById('langGlobeBtn').classList.remove('open');
    }
});

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('neverQuitLanguage', lang);
    document.getElementById('opt-es').classList.toggle('active', lang === 'es');
    document.getElementById('opt-en').classList.toggle('active', lang === 'en');
    document.documentElement.lang = lang;
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const tr = getTranslation(key);
        if (tr) el.innerHTML = tr;
    });
    toggleLangDropdown();
    updateUI();
    renderHistoryPanel();
}

// ============================================
// LOGIN
// ============================================
const VALID_CREDENTIALS = { 'admin': 'admin123', 'demo': 'demo123' };

function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    if (VALID_CREDENTIALS[username] && VALID_CREDENTIALS[username] === password) {
        localStorage.setItem('neverQuitLoggedIn', 'true');
        document.getElementById('loginOverlay').classList.add('hidden');
        setTimeout(() => { if (typeof initializeDashboard === 'function') initializeDashboard(); }, 500);
    } else {
        errorDiv.classList.add('show');
        document.getElementById('loginPassword').value = '';
        setTimeout(() => errorDiv.classList.remove('show'), 3000);
    }
}
function bypassLogin() {
    localStorage.setItem('neverQuitLoggedIn', 'true');
    document.getElementById('loginOverlay').classList.add('hidden');
    setTimeout(() => { if (typeof initializeDashboard === 'function') initializeDashboard(); }, 500);
}
function logout() {
    if (confirm(t('actions.logout') + '?')) {
        localStorage.removeItem('neverQuitLoggedIn');
        location.reload();
    }
}
window.handleLogin = handleLogin;
window.bypassLogin = bypassLogin;
window.logout = logout;

// ============================================
// DATA
// ============================================
let data = { master_comptes: [], payouts: [], examens: [] };

// Action history for the history panel (arrays per type)
let actionHistory = { challenges: [], statuses: [], payouts: [] };

function loadActionHistory() {
    const saved = localStorage.getItem('nqActionHistory');
    if (saved) actionHistory = JSON.parse(saved);
}
function saveActionHistory() {
    localStorage.setItem('nqActionHistory', JSON.stringify(actionHistory));
}

document.addEventListener('DOMContentLoaded', function() {
    setLanguage(currentLanguage);
    loadActionHistory();

    const isLoggedIn = localStorage.getItem('neverQuitLoggedIn') === 'true';
    if (isLoggedIn) {
        document.getElementById('loginOverlay').classList.add('hidden');
        setTimeout(() => initializeDashboard(), 100);
    }

    const savedData = localStorage.getItem('superDashboardData');
    if (savedData) {
        data = JSON.parse(savedData);
    } else {
        data = {
            master_comptes: [
                { id:"FTM_1704067200000_123", accountNumber:"5012345", year:2025, propFirm:"FTMO", accountSize:"50K", status:"FUNDED", purchaseDate:"2025-01-15", challengeCost:345, lastStatusDate:"2025-02-01", active:true },
                { id:"FTM_1706745600000_456", accountNumber:"5023456", year:2025, propFirm:"FTMO", accountSize:"100K", status:"PHASE 1", purchaseDate:"2025-02-01", challengeCost:540, lastStatusDate:"2025-02-01", active:true },
                { id:"FTM_1704585600000_234", accountNumber:"5015678", year:2025, propFirm:"FTMO", accountSize:"50K", status:"FUNDED", purchaseDate:"2025-01-10", challengeCost:345, lastStatusDate:"2025-01-25", active:true },
                { id:"FTM_1704412800000_890", accountNumber:"5009876", year:2025, propFirm:"FTMO", accountSize:"50K", status:"SUSPENDED", purchaseDate:"2025-01-05", challengeCost:345, lastStatusDate:"2025-01-20", active:false },
                { id:"FTM_1710460800000_345", accountNumber:"5003421", year:2024, propFirm:"FTMO", accountSize:"50K", status:"FUNDED", purchaseDate:"2024-03-15", challengeCost:345, lastStatusDate:"2024-04-01", active:true },
                { id:"MYF_1705881600000_789", accountNumber:"MFF-8392847", year:2025, propFirm:"MyForexFunds", accountSize:"25K", status:"FUNDED", purchaseDate:"2025-01-20", challengeCost:180, lastStatusDate:"2025-02-05", active:true },
                { id:"MYF_1716163200000_678", accountNumber:"MFF-7182934", year:2024, propFirm:"MyForexFunds", accountSize:"100K", status:"FUNDED", purchaseDate:"2024-05-20", challengeCost:450, lastStatusDate:"2024-06-10", active:true },
                { id:"MYF_1707264000000_991", accountNumber:"MFF-5647382", year:2025, propFirm:"MyForexFunds", accountSize:"50K", status:"PHASE 2", purchaseDate:"2025-02-03", challengeCost:299, lastStatusDate:"2025-02-10", active:true },
                { id:"ACG_1706054400000_567", accountNumber:"ACG-1234567", year:2025, propFirm:"Alpha Capital Group", accountSize:"100K", status:"PHASE 2", purchaseDate:"2025-01-22", challengeCost:400, lastStatusDate:"2025-02-05", active:true },
                { id:"ACG_1706832000000_442", accountNumber:"ACG-9876543", year:2025, propFirm:"Alpha Capital Group", accountSize:"50K", status:"FUNDED", purchaseDate:"2025-01-28", challengeCost:320, lastStatusDate:"2025-02-11", active:true },
                { id:"ORI_1705795200000_321", accountNumber:"ORF-9384756", year:2025, propFirm:"Orion Funded", accountSize:"25K", status:"FUNDED", purchaseDate:"2025-01-18", challengeCost:165, lastStatusDate:"2025-02-03", active:true },
                { id:"FND_1707091200000_774", accountNumber:"FN-4729183", year:2025, propFirm:"FundedNext", accountSize:"100K", status:"PHASE 1", purchaseDate:"2025-02-02", challengeCost:499, lastStatusDate:"2025-02-02", active:true },
                { id:"T5R_1706227200000_885", accountNumber:"T5-8273645", year:2025, propFirm:"The5ers", accountSize:"50K", status:"FUNDED", purchaseDate:"2025-01-24", challengeCost:295, lastStatusDate:"2025-02-08", active:true }
            ],
            payouts: [
                { id:"PAY001", accountId:"FTM_1704067200000_123", year:2025, payoutDate:"2025-02-05", amount:2500, status:"Recibido" },
                { id:"PAY002", accountId:"FTM_1704585600000_234", year:2025, payoutDate:"2025-02-08", amount:3200, status:"Recibido" },
                { id:"PAY003", accountId:"FTM_1704067200000_123", year:2025, payoutDate:"2025-02-12", amount:2800, status:"Aprobado" },
                { id:"PAY004", accountId:"FTM_1710460800000_345", year:2024, payoutDate:"2024-05-15", amount:4200, status:"Recibido" },
                { id:"PAY005", accountId:"MYF_1705881600000_789", year:2025, payoutDate:"2025-02-10", amount:1200, status:"Recibido" },
                { id:"PAY006", accountId:"MYF_1716163200000_678", year:2024, payoutDate:"2024-07-20", amount:5000, status:"Recibido" },
                { id:"PAY007", accountId:"ORI_1705795200000_321", year:2025, payoutDate:"2025-02-09", amount:950, status:"Recibido" },
                { id:"PAY008", accountId:"ACG_1706832000000_442", year:2025, payoutDate:"2025-02-13", amount:2100, status:"Solicitado" },
                { id:"PAY009", accountId:"T5R_1706227200000_885", year:2025, payoutDate:"2025-02-11", amount:1850, status:"Recibido" }
            ],
            examens: []
        };
        saveData();
    }

    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            switch(tabName) {
                case 'overview': renderOverview(); break;
                case 'performance': renderPerformance(); break;
                case 'propfirm': renderPropFirm(); break;
                case 'ceoview': renderCEOView(); break;
                case 'efficiency': renderCapitalEfficiency(); break;
                case 'wrapped': renderWrapped(); break;
            }
        });
    });

    document.getElementById('yearSelect').addEventListener('change', updateUI);

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('createPurchaseDate').value = today;
    document.getElementById('updateStatusDate').value = today;
    document.getElementById('payoutDate').value = today;

    const currentYear = new Date().getFullYear().toString();
    const yearSelectEl = document.getElementById('yearSelect');
    let foundYear = false;
    Array.from(yearSelectEl.options).forEach(opt => {
        if (opt.value === currentYear) { opt.selected = true; foundYear = true; } else { opt.selected = false; }
    });
    if (!foundYear) {
        const newOpt = document.createElement('option');
        newOpt.value = currentYear; newOpt.textContent = currentYear; newOpt.selected = true;
        yearSelectEl.appendChild(newOpt);
    }

    updateUI();
    renderHistoryPanel();

    // Swipe & keyboard nav
    const tabOrder = ['control','overview','performance','propfirm','ceoview','efficiency','wrapped'];
    function getCurrentTabIndex() {
        const a = document.querySelector('.tab.active');
        return tabOrder.indexOf(a ? a.getAttribute('data-tab') : 'control');
    }
    function switchToTab(i) {
        if (i < 0 || i >= tabOrder.length) return;
        const btn = document.querySelector(`.tab[data-tab="${tabOrder[i]}"]`);
        if (btn) { btn.click(); btn.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' }); }
    }
    let touchStartX = 0, touchStartY = 0;
    const container = document.querySelector('.container');
    container.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, { passive:true });
    container.addEventListener('touchend', e => {
        const dx = e.changedTouches[0].screenX - touchStartX;
        const dy = Math.abs(e.changedTouches[0].screenY - touchStartY);
        if (dy > 30) return;
        if (dx > 50) switchToTab(getCurrentTabIndex() - 1);
        else if (dx < -50) switchToTab(getCurrentTabIndex() + 1);
    }, { passive:true });
    document.addEventListener('keydown', e => {
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
        if (e.key === 'ArrowLeft') { switchToTab(getCurrentTabIndex() - 1); e.preventDefault(); }
        if (e.key === 'ArrowRight') { switchToTab(getCurrentTabIndex() + 1); e.preventDefault(); }
    });
});

function saveData() { localStorage.setItem('superDashboardData', JSON.stringify(data)); }

// ============================================
// HISTORY PANEL
// ============================================
let historyPanelOpen = false;

function toggleHistoryPanel() {
    historyPanelOpen = !historyPanelOpen;
    document.getElementById('historyPanel').classList.toggle('visible', historyPanelOpen);
}

function renderHistoryPanel() {
    const body = document.getElementById('historyPanelBody');
    if (!body) return;

    const ch = actionHistory.challenges || [];
    const st = actionHistory.statuses   || [];
    const py = actionHistory.payouts    || [];
    const total = ch.length + st.length + py.length;

    const badge = document.getElementById('historyBadge');
    if (badge) badge.textContent = total;

    if (total === 0) {
        body.innerHTML = `<div class="history-empty">üì≠ ${t('history.empty')}</div>`;
        return;
    }

    let html = '';

    if (ch.length > 0) {
        html += `<div class="history-section-title">üìã ${t('history.challenges')}</div>`;
        ch.slice().reverse().forEach((item, idx) => {
            html += `<div class="history-item">
                <div class="history-item-icon">üè¶</div>
                <div class="history-item-info">
                    <div class="history-item-name">${item.accountNumber} ¬∑ ${item.propFirm}</div>
                    <div class="history-item-sub">${item.accountSize} ¬∑ $${item.challengeCost} ¬∑ ${item.purchaseDate}</div>
                </div>
                <button class="history-item-delete" onclick="deleteHistoryItem('challenges',${ch.length - 1 - idx})" title="${t('alerts.deleted')}">‚úï</button>
            </div>`;
        });
    }

    if (st.length > 0) {
        if (ch.length > 0) html += '<div class="history-divider"></div>';
        html += `<div class="history-section-title">üîÑ ${t('history.statuses')}</div>`;
        st.slice().reverse().forEach((item, idx) => {
            html += `<div class="history-item">
                <div class="history-item-icon">üìä</div>
                <div class="history-item-info">
                    <div class="history-item-name">${item.accountNumber} ‚Üí ${item.newStatus}</div>
                    <div class="history-item-sub">${item.propFirm} ¬∑ ${item.statusDate}</div>
                </div>
                <button class="history-item-delete" onclick="deleteHistoryItem('statuses',${st.length - 1 - idx})" title="${t('alerts.deleted')}">‚úï</button>
            </div>`;
        });
    }

    if (py.length > 0) {
        if (ch.length > 0 || st.length > 0) html += '<div class="history-divider"></div>';
        html += `<div class="history-section-title">üí∞ ${t('history.payouts')}</div>`;
        py.slice().reverse().forEach((item, idx) => {
            html += `<div class="history-item">
                <div class="history-item-icon">üí∏</div>
                <div class="history-item-info">
                    <div class="history-item-name">$${item.amount.toLocaleString()} ¬∑ ${item.accountNumber}</div>
                    <div class="history-item-sub">${item.propFirm} ¬∑ ${item.payoutDate} ¬∑ ${item.status}</div>
                </div>
                <button class="history-item-delete" onclick="deleteHistoryItem('payouts',${py.length - 1 - idx})" title="${t('alerts.deleted')}">‚úï</button>
            </div>`;
        });
    }

    body.innerHTML = html;
}

function deleteHistoryItem(type, index) {
    const item = actionHistory[type][index];
    if (!item) return;

    // Perform the actual deletion
    if (type === 'challenges') {
        const i = data.master_comptes.findIndex(a => a.id === item.id);
        if (i !== -1) {
            // Also remove associated payouts
            data.payouts = data.payouts.filter(p => p.accountId !== item.id);
            data.master_comptes.splice(i, 1);
            // Also clean related status history entries
            actionHistory.statuses = actionHistory.statuses.filter(s => s.accountId !== item.id);
        }
    } else if (type === 'statuses') {
        // Revert the status change
        const account = data.master_comptes.find(a => a.id === item.accountId);
        if (account) {
            account.status = item.previousStatus;
            account.lastStatusDate = item.previousDate;
            account.active = item.previousStatus !== 'SUSPENDED';
            // Remove last examen entry for this account
            const examIdx = data.examens.map(e => e.accountId).lastIndexOf(item.accountId);
            if (examIdx !== -1) data.examens.splice(examIdx, 1);
        }
    } else if (type === 'payouts') {
        const i = data.payouts.findIndex(p => p.id === item.id);
        if (i !== -1) data.payouts.splice(i, 1);
    }

    actionHistory[type].splice(index, 1);
    saveData();
    saveActionHistory();
    updateUI();
    renderHistoryPanel();
    showAlert(`${t('alerts.deleted')}: ${item.accountNumber || '$' + (item.amount || '')}`, 'success');
}

// ============================================
// MODALS & RESET
// ============================================
function openResetModal() { document.getElementById('resetModal').classList.add('active'); }
function closeResetModal() {
    document.getElementById('resetModal').classList.remove('active');
    const inp = document.getElementById('resetConfirmInput');
    const btn = document.getElementById('confirmResetBtn');
    if (inp) inp.value = '';
    if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; }
}
function confirmReset() {
    const inp = document.getElementById('resetConfirmInput');
    if (!inp || inp.value.toUpperCase() !== 'RESET') { showAlert(t('alerts.typeReset'), 'error'); return; }
    localStorage.removeItem('superDashboardData');
    localStorage.removeItem('nqActionHistory');
    data = { master_comptes: [], payouts: [], examens: [] };
    actionHistory = { challenges: [], statuses: [], payouts: [] };
    closeResetModal();
    updateUI();
    renderHistoryPanel();
    showAlert(t('alerts.dataDeleted'), 'success');
}

function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${type}`;
    alertDiv.innerHTML = `<span>${message}</span>`;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alertDiv);
    setTimeout(() => {
        alertDiv.classList.add('hiding');
        setTimeout(() => { if (alertContainer.contains(alertDiv)) alertContainer.removeChild(alertDiv); }, 300);
    }, 3000);
}

// ============================================
// ACTIONS
// ============================================
function createChallenge() {
    const propFirm      = document.getElementById('createPropFirm').value;
    const accountSize   = document.getElementById('createAccountSize').value;
    const purchaseDate  = document.getElementById('createPurchaseDate').value;
    const challengeCost = parseFloat(document.getElementById('createChallengeCost').value);
    const accountNumber = document.getElementById('createAccountNumber').value.trim();

    if (!purchaseDate || !challengeCost || !accountNumber) { showAlert(t('alerts.fillFields'), 'error'); return; }
    if (new Date(purchaseDate) > new Date()) { showAlert(t('alerts.futureDate'), 'error'); return; }
    if (challengeCost <= 0) { showAlert(t('alerts.positiveCost'), 'error'); return; }
    const validSizes = ['10K','25K','50K','100K','200K'];
    if (!validSizes.includes(accountSize)) { showAlert(t('alerts.invalidSize'), 'error'); return; }

    const year = new Date(purchaseDate).getFullYear();
    if (data.master_comptes.find(a => a.accountNumber === accountNumber && a.year === year)) {
        showAlert(`${t('alerts.duplicateAccount')} ${year}`, 'error'); return;
    }

    const ts = Date.now();
    const rnd = Math.floor(Math.random() * 1000);
    const prefix = propFirm.substring(0,3).toUpperCase().replace(/\s/g,'');
    const id = `${prefix}_${ts}_${rnd}`;

    const newAccount = { id, accountNumber, year, propFirm, accountSize, status:'PHASE 1', purchaseDate, challengeCost, lastStatusDate:purchaseDate, active:true };
    data.master_comptes.push(newAccount);
    saveData();

    // Save to history
    actionHistory.challenges.push({ id, accountNumber, propFirm, accountSize, challengeCost, purchaseDate });
    if (actionHistory.challenges.length > 20) actionHistory.challenges.shift();
    saveActionHistory();
    renderHistoryPanel();

    showAlert(`${t('alerts.challengeCreated')}: ${accountNumber} (${propFirm} - ${accountSize})`, 'success');
    document.getElementById('createChallengeCost').value = '';
    document.getElementById('createAccountNumber').value = '';
    updateUI();
}

// ============================================
// STATUS TRANSITION RULES
// ============================================
const STATUS_TRANSITIONS = {
    'PHASE 1':  ['PHASE 2', 'SUSPENDED'],
    'PHASE 2':  ['FUNDED', 'SUSPENDED'],
    'FUNDED':   [],        // already funded, no further transitions
    'SUSPENDED':[]         // terminal state
};

function filterStatusOptions(accountId) {
    const sel     = document.getElementById('updateNewStatus');
    const hint    = document.getElementById('statusTransitionHint');
    if (!sel) return;

    if (!accountId) {
        // No account selected: show all options
        sel.innerHTML =
            '<option value="PHASE 1">PHASE 1</option>' +
            '<option value="PHASE 2">PHASE 2</option>' +
            '<option value="FUNDED">FUNDED</option>' +
            '<option value="SUSPENDED">SUSPENDED</option>';
        if (hint) hint.style.display = 'none';
        return;
    }

    const account = data.master_comptes.find(a => a.id === accountId);
    if (!account) return;

    const allowed = STATUS_TRANSITIONS[account.status] || [];
    const badgeClass = account.status === 'PHASE 1' ? 'phase1'
                     : account.status === 'PHASE 2' ? 'phase2'
                     : account.status === 'FUNDED'  ? 'funded' : 'suspended';

    if (allowed.length === 0) {
        sel.innerHTML = `<option value="" disabled selected>${currentLanguage === 'es' ? 'Sin transiciones disponibles' : 'No transitions available'}</option>`;
        if (hint) {
            hint.style.display = 'inline-flex';
            hint.className = 'status-hint no-transitions';
            hint.innerHTML = `<span class="from-badge ${badgeClass}">${account.status}</span>
                <span class="arrow">‚Üí</span>
                <span style="font-style:italic;">${currentLanguage === 'es' ? 'estado final, sin cambios posibles' : 'final state, no changes possible'}</span>`;
        }
        return;
    }

    sel.innerHTML = allowed
        .map(s => `<option value="${s}">${s}</option>`)
        .join('');

    if (hint) {
        hint.style.display = 'inline-flex';
        hint.className = 'status-hint';
        const toBadges = allowed.map(s => `<span class="to-badge">${s}</span>`).join(' ');
        hint.innerHTML = `<span class="from-badge ${badgeClass}">${account.status}</span>
            <span class="arrow">‚Üí</span>
            ${toBadges}`;
    }
}

function updateChallenge() {
    const accountId  = document.getElementById('updateAccountId').value;
    const newStatus  = document.getElementById('updateNewStatus').value;
    const statusDate = document.getElementById('updateStatusDate').value;
    if (!accountId || !statusDate || !newStatus) { showAlert(t('alerts.selectAccount'), 'error'); return; }
    if (new Date(statusDate) > new Date()) { showAlert(t('alerts.futureDate'), 'error'); return; }

    // Validate the transition is allowed
    const account = data.master_comptes.find(a => a.id === accountId);
    if (account) {
        const allowed = STATUS_TRANSITIONS[account.status] || [];
        if (allowed.length === 0) {
            showAlert(currentLanguage === 'es'
                ? `‚ö†Ô∏è La cuenta ya est√° en estado final: ${account.status}`
                : `‚ö†Ô∏è Account is already in final state: ${account.status}`, 'error');
            return;
        }
        if (!allowed.includes(newStatus)) {
            showAlert(currentLanguage === 'es'
                ? `‚ö†Ô∏è Transici√≥n no permitida: ${account.status} ‚Üí ${newStatus}`
                : `‚ö†Ô∏è Transition not allowed: ${account.status} ‚Üí ${newStatus}`, 'error');
            return;
        }
    }
    if (account) {
        const prevStatus = account.status;
        const prevDate   = account.lastStatusDate;

        account.status = newStatus;
        account.lastStatusDate = statusDate;
        account.active = newStatus !== 'SUSPENDED';
        data.examens.push({ id:`EX${data.examens.length+1}`, accountId, phase:newStatus, statusDate });
        saveData();

        // Save to history
        actionHistory.statuses.push({ accountId, accountNumber: account.accountNumber || accountId, propFirm: account.propFirm, newStatus, statusDate, previousStatus: prevStatus, previousDate: prevDate });
        if (actionHistory.statuses.length > 20) actionHistory.statuses.shift();
        saveActionHistory();
        renderHistoryPanel();

        showAlert(`${t('alerts.statusUpdated')}: ${account.accountNumber} ‚Üí ${newStatus}`, 'success');
        updateUI();
    }
}

function registerPayout() {
    const accountId  = document.getElementById('payoutAccountId').value;
    const amount     = parseFloat(document.getElementById('payoutAmount').value);
    const payoutDate = document.getElementById('payoutDate').value;
    const status     = document.getElementById('payoutStatus').value;
    if (!accountId || !amount || !payoutDate || !status) { showAlert(t('alerts.fillFields'), 'error'); return; }
    if (new Date(payoutDate) > new Date()) { showAlert(t('alerts.futureDate'), 'error'); return; }
    if (amount <= 0) { showAlert(t('alerts.positiveAmount'), 'error'); return; }

    const account = data.master_comptes.find(a => a.id === accountId);
    if (account) {
        const sizeNum = parseInt(account.accountSize.replace('K','')) * 1000;
        if (amount > sizeNum * 2) { showAlert(`‚ö†Ô∏è ${t('alerts.payoutTooHigh')}`, 'error'); return; }
    }

    const year = new Date(payoutDate).getFullYear();
    const id = `PAY${Date.now()}`;
    const newPayout = { id, accountId, year, payoutDate, amount, status };
    data.payouts.push(newPayout);
    saveData();

    const accNum = account ? (account.accountNumber || accountId) : accountId;
    const pFirm  = account ? account.propFirm : '';

    // Save to history
    actionHistory.payouts.push({ id, accountId, accountNumber: accNum, propFirm: pFirm, amount, payoutDate, status });
    if (actionHistory.payouts.length > 20) actionHistory.payouts.shift();
    saveActionHistory();
    renderHistoryPanel();

    showAlert(`${t('alerts.payoutRegistered')}: $${amount.toLocaleString()} ${t('forms.from')} ${accNum}`, 'success');
    document.getElementById('payoutAmount').value = '';
    updateUI();
}

// ============================================
// HELPERS & CONFIG
// ============================================
function calculateDaysToFunding(account) {
    const diff = Math.abs(new Date(account.lastStatusDate) - new Date(account.purchaseDate));
    return Math.ceil(diff / 86400000);
}

const PROP_FIRMS_CONFIG = {
    'FTMO': { profitTarget_P1:10, profitTarget_P2:5, maxDailyLoss:5, maxLoss:10, split:'80-90%', newsTrading_Challenge:'Permitido sin restricciones', newsTrading_Funded:'Restricci√≥n 2min antes/despu√©s (Standard)', note_funded:'Sin restricci√≥n en Swing Account', minTradingDays:4 },
    'Alpha Capital Group': { profitTarget_P1:8, profitTarget_P2:5, maxDailyLoss:5, maxLoss:10, split:'80%', newsTrading_Challenge:'Permitido sin restricciones', newsTrading_Funded:'Trades 2min antes/despu√©s deben durar +2min', minTradingDays:3 },
    'The5ers': { profitTarget_P1:8, profitTarget_P2:5, maxDailyLoss:5, maxLoss:10, split:'80-100%', newsTrading_Challenge:'Permitido sin restricciones', newsTrading_Funded:'Permitido sin restricciones', note_funded:'Escalado progresivo hasta 100% profit split' },
    'FundedNext': { profitTarget_P1:10, profitTarget_P2:5, maxDailyLoss:5, maxLoss:10, split:'80-95%', newsTrading_Challenge:'Permitido sin restricciones', newsTrading_Funded:'Permitido sin restricciones', minTradingDays:0 },
    'Orion Funded': { profitTarget_P1:10, profitTarget_P2:5, maxDailyLoss:5, maxLoss:10, split:'80%', newsTrading_Challenge:'Permitido sin restricciones', newsTrading_Funded:'Consultar reglas espec√≠ficas', minTradingDays:3 },
    'Bullfy': { profitTarget_P1:10, profitTarget_P2:5, maxDailyLoss:5, maxLoss:10, split:'80%', newsTrading_Challenge:'Permitido sin restricciones', newsTrading_Funded:'Consultar reglas espec√≠ficas', minTradingDays:3 },
    'MyForexFunds': { profitTarget_P1:8, profitTarget_P2:5, maxDailyLoss:5, maxLoss:12, split:'75-85%', newsTrading_Challenge:'Permitido sin restricciones', newsTrading_Funded:'Firma temporalmente cerrada', note:'‚ö†Ô∏è CERRADA desde 2023 - Reapertura esperada 2026', minTradingDays:3 }
};

// ============================================
// RENDER FUNCTIONS (Overview, Performance, PropFirm, CEO, Efficiency, Wrapped)
// These are identical to the originals ‚Äî kept intact
// ============================================

function renderOverview() {
    const activeYear = parseInt(document.getElementById('yearSelect').value);
    const yearAccounts = data.master_comptes.filter(a => a.year === activeYear);
    const yearPayouts  = data.payouts.filter(p => p.year === activeYear);
    const activeFunded = yearAccounts.filter(a => a.status === 'FUNDED' && a.active).length;
    const totalPayouts = yearPayouts.reduce((s,p) => s+p.amount, 0);
    const totalCosts   = yearAccounts.reduce((s,a) => s+a.challengeCost, 0);
    const roi = (totalCosts > 0 && totalPayouts > 0) ? ((totalPayouts - totalCosts)/totalCosts*100) : 0;
    const activeFundedCapital = yearAccounts.filter(a=>a.status==='FUNDED'&&a.active).reduce((s,a)=>s+parseInt(a.accountSize.replace('K',''))*1000, 0);
    const activeOnly = yearAccounts.filter(a=>a.active);
    const suspendedCount = yearAccounts.filter(a=>a.status==='SUSPENDED').length;
    const sc = { FUNDED: activeOnly.filter(a=>a.status==='FUNDED').length, 'PHASE 1': activeOnly.filter(a=>a.status==='PHASE 1').length, 'PHASE 2': activeOnly.filter(a=>a.status==='PHASE 2').length };
    const locale = currentLanguage === 'es' ? 'es-ES' : 'en-US';

    document.getElementById('overview').innerHTML = `
    <div class="dashboard-header"><h2>${t('overview.title')} ¬∑ ${activeYear}</h2><div class="subtitle">${t('overview.updated')} ${new Date().toLocaleDateString(locale,{month:'short',year:'numeric'})}</div></div>
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">${t('overview.activeFundedCapital')}</div><div class="kpi-value success">$${activeFundedCapital.toLocaleString()}</div><div class="kpi-subtitle">${activeFunded} ${t('overview.accounts')}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('overview.totalPayouts')}</div><div class="kpi-value success">$${totalPayouts.toLocaleString()}</div><div class="kpi-subtitle">${yearPayouts.length} ${t('overview.payments')}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('overview.activeFundedAccounts')}</div><div class="kpi-value">${activeFunded}</div><div class="kpi-subtitle">${t('overview.ofTotal')} ${yearAccounts.length}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('overview.roiAnnual')}</div><div class="kpi-value ${roi>0?'success':roi<0?'danger':''}">${roi>0?'+':''}${roi.toFixed(0)}%</div><div class="kpi-subtitle">${t('overview.costs')}: $${totalCosts.toLocaleString()}</div></div>
    </div>
    <div class="grid-2">
      <div class="table-container"><h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:700;">${t('overview.accountStatus')}</h3>
        <table><thead><tr><th>${t('overview.status')}</th><th>${t('overview.count')}</th><th>${t('overview.pctActive')}</th></tr></thead><tbody>
          <tr><td><span class="status-badge funded">FUNDED</span></td><td>${sc.FUNDED}</td><td>${activeOnly.length>0?((sc.FUNDED/activeOnly.length)*100).toFixed(1):0}%</td></tr>
          <tr><td><span class="status-badge phase1">PHASE 1</span></td><td>${sc['PHASE 1']}</td><td>${activeOnly.length>0?((sc['PHASE 1']/activeOnly.length)*100).toFixed(1):0}%</td></tr>
          <tr><td><span class="status-badge phase2">PHASE 2</span></td><td>${sc['PHASE 2']}</td><td>${activeOnly.length>0?((sc['PHASE 2']/activeOnly.length)*100).toFixed(1):0}%</td></tr>
          ${suspendedCount>0?`<tr style="opacity:0.5;"><td><span class="status-badge suspended">SUSPENDED</span></td><td>${suspendedCount}</td><td style="color:#9AA0A6;font-style:italic;">closed</td></tr>`:''}
        </tbody></table>
        <div style="margin-top:0.75rem;font-size:0.75rem;color:#9AA0A6;">${t('overview.totalActive')}: ${activeOnly.length} ¬∑ ${suspendedCount>0?`${suspendedCount} ${suspendedCount>1?t('overview.excludedPlural'):t('overview.excluded')}`:t('overview.noSuspended')}</div>
      </div>
      <div class="table-container"><h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:700;">Active Accounts</h3>
        <div class="chart-container"><canvas id="activeAccountsChart"></canvas></div>
        <div style="text-align:center;margin-top:1rem;color:#9AA0A6;font-size:0.85rem;">Total Active: ${activeOnly.length}</div>
      </div>
    </div>
    ${yearAccounts.length>0?`<div class="table-container"><h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:700;">${t('overview.myAccounts')} ¬∑ ${activeYear}</h3>
    <table><thead><tr><th>${t('overview.account')}</th><th>${t('overview.firm')}</th><th>${t('overview.size')}</th><th>Status</th><th>${t('overview.cost')}</th><th>${t('overview.date')}</th></tr></thead><tbody>
    ${yearAccounts.sort((a,b)=>new Date(b.purchaseDate)-new Date(a.purchaseDate)).map(acc=>{
        const sc2=acc.status==='FUNDED'?'funded':acc.status==='PHASE 1'?'phase1':acc.status==='PHASE 2'?'phase2':'suspended';
        const py2=data.payouts.filter(p=>p.accountId===acc.id).reduce((s,p)=>s+p.amount,0);
        const op=!acc.active?'opacity:0.5;':'';
        return `<tr style="${op}"><td style="font-weight:700;">${acc.accountNumber}</td><td>${acc.propFirm}</td><td style="font-weight:600;">${acc.accountSize}</td><td><span class="status-badge ${sc2}">${acc.status}</span></td><td style="color:#E74C3C;">-$${acc.challengeCost.toLocaleString()}</td><td style="color:#9AA0A6;">${new Date(acc.purchaseDate).toLocaleDateString(locale)}</td></tr>`
        +( py2>0?`<tr style="background:rgba(46,204,113,0.03);${op}"><td colspan="4" style="padding-top:0.3rem;padding-bottom:0.5rem;color:#9AA0A6;font-size:0.8rem;padding-left:2.5rem;">‚Ü≥ ${t('overview.received')}</td><td style="color:#2ECC71;padding-top:0.3rem;padding-bottom:0.5rem;">+$${py2.toLocaleString()}</td><td></td></tr>`:'');
    }).join('')}
    </tbody></table></div>`:''}`;

    const ctx = document.getElementById('activeAccountsChart');
    if (ctx && activeOnly.length > 0) {
        if (window.activeChart) window.activeChart.destroy();
        window.activeChart = new Chart(ctx, { type:'doughnut', data:{ labels:['FUNDED','PHASE 1','PHASE 2'], datasets:[{ data:[sc.FUNDED,sc['PHASE 1'],sc['PHASE 2']], backgroundColor:['#2ECC71','#3498DB','#F39C12'], borderColor:'#121417', borderWidth:3 }] }, options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom', labels:{ color:'#E6E8EB', font:{ family:'Inter', size:12, weight:'600' }, padding:15 } } } } });
    }
}

function renderPerformance() {
    const activeYear = parseInt(document.getElementById('yearSelect').value);
    const ya = data.master_comptes.filter(a=>a.year===activeYear);
    const yp = data.payouts.filter(p=>p.year===activeYear);
    const total = ya.length;
    const p1cur = ya.filter(a=>a.status==='PHASE 1').length;
    const p2cur = ya.filter(a=>a.status==='PHASE 2').length;
    const funded = ya.filter(a=>a.status==='FUNDED').length;
    const passed1 = p2cur + funded;
    const wr1 = total>0?(passed1/total*100):0;
    const wr2 = (p2cur+funded)>0?(funded/(p2cur+funded)*100):0;
    const costs = ya.reduce((s,a)=>s+a.challengeCost,0);
    const pays = yp.reduce((s,p)=>s+p.amount,0);
    const avgCost = funded>0?costs/funded:0;
    const firms = ['FTMO','Alpha Capital Group','Orion Funded','Bullfy','FundedNext','The5ers','MyForexFunds'];
    const roiByFirm = firms.map(firm=>{
        const fa=ya.filter(a=>a.propFirm===firm); const fc=fa.reduce((s,a)=>s+a.challengeCost,0);
        const ids=fa.map(a=>a.id); const fp=yp.filter(p=>ids.includes(p.accountId)).reduce((s,p)=>s+p.amount,0);
        return { firm, roi:fc>0?((fp-fc)/fc*100):0, costs:fc };
    }).filter(f=>f.costs>0).sort((a,b)=>b.roi-a.roi);
    const best = roiByFirm[0]||{firm:'N/A',roi:0};
    const locale = currentLanguage==='es'?'es-ES':'en-US';

    document.getElementById('performance').innerHTML=`
    <div class="dashboard-header"><h2>${t('performance.title')} ¬∑ ${activeYear}</h2>${total===0?`<div style="text-align:center;padding:0.5rem;color:#F39C12;font-size:0.85rem;">${t('performance.noData')} ${activeYear} ‚Äî ${t('performance.createFirst')}</div>`:''}<div class="subtitle">${t('overview.updated')} ${new Date().toLocaleDateString(locale,{month:'short',year:'numeric'})}</div></div>
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">${t('performance.phase1Success')}</div><div class="kpi-value success">${wr1.toFixed(0)}%</div><div class="kpi-subtitle">${passed1} ${t('performance.of')} ${total}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('performance.phase2Success')}</div><div class="kpi-value success">${wr2.toFixed(0)}%</div><div class="kpi-subtitle">${funded} ${t('performance.funded')}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('performance.avgCostFunded')}</div><div class="kpi-value">$${avgCost.toFixed(0)}</div><div class="kpi-subtitle">${t('performance.totalCosts')}: $${costs.toLocaleString()}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('performance.bestFirmRoi')}</div><div class="kpi-value success">${best.firm}</div><div class="kpi-subtitle">+${best.roi.toFixed(0)}%</div></div>
    </div>
    <div class="grid-2">
      <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('performance.challengeSuccess')}</h3>
        <div class="bar-chart">
          <div class="bar-row"><div class="bar-label">PHASE 1</div><div class="bar-track"><div class="bar-fill" style="width:${wr1}%;background:linear-gradient(90deg,#F39C12,#E67E22);">${wr1>15?`<span class="bar-value">${wr1.toFixed(0)}%</span>`:''}</div></div><div class="bar-count">${wr1.toFixed(0)}%</div></div>
          <div class="bar-row"><div class="bar-label">PHASE 2</div><div class="bar-track"><div class="bar-fill" style="width:${wr2}%;background:linear-gradient(90deg,#2ECC71,#27AE60);">${wr2>15?`<span class="bar-value">${wr2.toFixed(0)}%</span>`:''}</div></div><div class="bar-count">${wr2.toFixed(0)}%</div></div>
        </div>
      </div>
      <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('performance.approvalRate')}</h3>
        <div style="padding:2rem;text-align:center;">
          <div class="kpi-value success" style="font-size:3rem;">${total}</div><div style="color:#9AA0A6;margin-top:0.5rem;">${t('performance.totalChallenges')}</div>
          <div style="display:flex;align-items:center;justify-content:center;gap:1rem;margin:1.5rem 0;flex-wrap:wrap;">
            <div style="text-align:center;"><div style="color:#9AA0A6;font-size:0.8rem;margin-bottom:0.25rem;">${t('performance.inPhase1')}</div><div style="font-size:1.2rem;font-weight:700;">${p1cur}</div></div>
            <div style="color:#2ECC71;font-size:1.5rem;">‚Üí</div>
            <div style="text-align:center;"><div style="color:#9AA0A6;font-size:0.8rem;margin-bottom:0.25rem;">${t('performance.passedP1')}</div><div style="font-size:1.2rem;font-weight:700;color:#F39C12;">${passed1}</div><div style="color:#F39C12;font-size:0.75rem;">${wr1.toFixed(0)}%</div></div>
            <div style="color:#2ECC71;font-size:1.5rem;">‚Üí</div>
            <div style="text-align:center;"><div style="color:#9AA0A6;font-size:0.8rem;margin-bottom:0.25rem;">${t('performance.inPhase2')}</div><div style="font-size:1.2rem;font-weight:700;">${p2cur}</div></div>
            <div style="color:#2ECC71;font-size:1.5rem;">‚Üí</div>
            <div style="text-align:center;"><div style="color:#9AA0A6;font-size:0.8rem;margin-bottom:0.25rem;">FUNDED</div><div style="font-size:1.2rem;font-weight:700;color:#2ECC71;">${funded}</div><div style="color:#2ECC71;font-size:0.75rem;">${wr2.toFixed(0)}%</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('performance.roiByFirm')}</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;">
        <div class="chart-container" style="max-width:none;"><canvas id="roiLineChart"></canvas></div>
        <div class="chart-container" style="max-width:none;"><canvas id="roiBarChart"></canvas></div>
      </div>
    </div>`;

    if (roiByFirm.length > 0) {
        const chartOpts = { responsive:true, maintainAspectRatio:true, plugins:{ legend:{display:false}, tooltip:{backgroundColor:'#181B20',titleColor:'#E6E8EB',bodyColor:'#E6E8EB',callbacks:{label:(c)=>`+${c.parsed.y.toFixed(0)}%`}} }, scales:{ y:{beginAtZero:true,ticks:{color:'#9AA0A6',callback:v=>v+'%'},grid:{color:'rgba(230,232,235,0.05)'}}, x:{ticks:{color:'#9AA0A6'},grid:{display:false}} } };
        if (window.roiLineChart) window.roiLineChart.destroy();
        window.roiLineChart = new Chart(document.getElementById('roiLineChart'),{type:'line',data:{labels:roiByFirm.map(f=>f.firm),datasets:[{label:'ROI %',data:roiByFirm.map(f=>f.roi),borderColor:'#2ECC71',backgroundColor:'rgba(46,204,113,0.1)',borderWidth:3,pointRadius:6,pointBackgroundColor:'#2ECC71',pointBorderColor:'#121417',pointBorderWidth:2,tension:0.3,fill:true}]},options:chartOpts});
        if (window.roiBarChart) window.roiBarChart.destroy();
        window.roiBarChart = new Chart(document.getElementById('roiBarChart'),{type:'bar',data:{labels:roiByFirm.map(f=>f.firm),datasets:[{data:roiByFirm.map(f=>f.roi),backgroundColor:['#2ECC71','#9AA0A6','#F39C12'],borderRadius:6}]},options:chartOpts});
    }
}

function renderPropFirm() {
    const activeYear = parseInt(document.getElementById('yearSelect').value);
    const sel = document.getElementById('firmSelector');
    const selectedFirm = sel ? sel.value : 'FTMO';
    const cfg = PROP_FIRMS_CONFIG[selectedFirm] || PROP_FIRMS_CONFIG['FTMO'];
    const ya = data.master_comptes.filter(a=>a.year===activeYear&&a.propFirm===selectedFirm);
    const yp = data.payouts.filter(p=>{ const ac=data.master_comptes.find(a=>a.id===p.accountId); return p.year===activeYear&&ac&&ac.propFirm===selectedFirm; });
    const invested=ya.reduce((s,a)=>s+a.challengeCost,0), pays=yp.reduce((s,p)=>s+p.amount,0), funded=ya.filter(a=>a.status==='FUNDED').length;
    const roi=invested>0?((pays-invested)/invested*100):0;
    const sc={FUNDED:ya.filter(a=>a.status==='FUNDED').length,'PHASE 1':ya.filter(a=>a.status==='PHASE 1').length,'PHASE 2':ya.filter(a=>a.status==='PHASE 2').length,SUSPENDED:ya.filter(a=>a.status==='SUSPENDED').length};
    const locale=currentLanguage==='es'?'es-ES':'en-US';

    document.getElementById('propfirm').innerHTML=`
    <div class="dashboard-header"><h2>${t('propfirm.title')} ¬∑ ${selectedFirm}</h2>${ya.length===0?`<div style="display:inline-block;padding:0.25rem 0.75rem;background:rgba(243,156,18,0.1);border-radius:6px;color:#F39C12;font-size:0.8rem;margin-top:0.5rem;">${t('propfirm.noAccounts')} ${selectedFirm} ${t('propfirm.inYear')} ${activeYear}</div>`:''}<div class="subtitle">${t('propfirm.historical')} ¬∑ ${t('propfirm.updated')} ${new Date().toLocaleDateString(locale,{month:'short',year:'numeric'})}</div></div>
    <div style="margin-bottom:2rem;"><select id="firmSelector" style="padding:0.75rem 1.5rem;background:#181B20;border:1px solid rgba(230,232,235,0.1);border-radius:8px;color:#E6E8EB;font-size:0.95rem;font-weight:600;">
      ${['FTMO','Alpha Capital Group','Orion Funded','Bullfy','FundedNext','The5ers','MyForexFunds'].map(f=>`<option value="${f}" ${selectedFirm===f?'selected':''}>${f}</option>`).join('')}
    </select><span style="margin-left:2rem;color:#9AA0A6;font-size:0.8rem;">P1: ${cfg.profitTarget_P1}% target ¬∑ Max loss: ${cfg.maxLoss}%</span></div>
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">${t('propfirm.challengesBought')}</div><div class="kpi-value">${ya.length}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('propfirm.accountsFunded')}</div><div class="kpi-value success">${funded}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('propfirm.invested')}</div><div class="kpi-value">$${invested.toLocaleString()}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('propfirm.payouts')}</div><div class="kpi-value success">$${pays.toLocaleString()}</div></div>
    </div>
    <div class="grid-2">
      <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('propfirm.accountStatus')}</h3>
        <div class="bar-chart">
          <div class="bar-row"><div class="bar-label">FUNDED</div><div class="bar-track"><div class="bar-fill" style="width:${ya.length>0?(sc.FUNDED/ya.length*100):0}%;background:linear-gradient(90deg,#2ECC71,#27AE60);"></div></div><div class="bar-count">${sc.FUNDED}</div></div>
          <div class="bar-row"><div class="bar-label">PHASE 1</div><div class="bar-track"><div class="bar-fill" style="width:${ya.length>0?(sc['PHASE 1']/ya.length*100):0}%;background:linear-gradient(90deg,#F39C12,#E67E22);"></div></div><div class="bar-count">${sc['PHASE 1']}</div></div>
          <div class="bar-row"><div class="bar-label">SUSPENDED</div><div class="bar-track"><div class="bar-fill" style="width:${ya.length>0?(sc.SUSPENDED/ya.length*100):0}%;background:linear-gradient(90deg,#9AA0A6,#7F8C8D);"></div></div><div class="bar-count">${sc.SUSPENDED}</div></div>
        </div>
      </div>
      <div class="kpi-card"><div class="kpi-label">${t('propfirm.roi')}</div><div style="text-align:center;padding:2rem 0;"><div class="kpi-value success" style="font-size:3.5rem;">+${roi.toFixed(0)}%</div></div></div>
    </div>
    <div class="table-container"><h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:700;">${t('propfirm.rules')} ${selectedFirm.toUpperCase()}</h3>
      <ul style="list-style:none;padding:0;color:#9AA0A6;line-height:2;">
        <li>‚Ä¢ <strong>${t('propfirm.phase1')}:</strong> ${cfg.profitTarget_P1}% profit target</li>
        <li>‚Ä¢ <strong>${t('propfirm.phase2')}:</strong> ${cfg.profitTarget_P2}% profit target</li>
        <li>‚Ä¢ <strong>${t('propfirm.maxDailyLoss')}:</strong> ${cfg.maxDailyLoss}%</li>
        <li>‚Ä¢ <strong>${t('propfirm.maxLoss')}:</strong> ${cfg.maxLoss}%</li>
        <li>‚Ä¢ <strong>${t('propfirm.profitSplit')}:</strong> ${cfg.split}</li>
        ${cfg.minTradingDays?`<li>‚Ä¢ <strong>${t('propfirm.minTradingDays')}:</strong> ${cfg.minTradingDays}</li>`:''}
        <li style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid rgba(230,232,235,0.1);"><strong>üì∞ ${t('propfirm.newsChallenge')}:</strong><br/><span style="font-size:0.9rem;">${cfg.newsTrading_Challenge}</span></li>
        <li style="margin-top:0.5rem;"><strong>üì∞ ${t('propfirm.newsFunded')}:</strong><br/><span style="font-size:0.9rem;">${cfg.newsTrading_Funded}</span></li>
        ${cfg.note?`<li style="margin-top:0.75rem;font-size:0.85rem;color:#F39C12;padding:0.5rem;background:rgba(243,156,18,0.1);border-radius:6px;">${t('propfirm.closed')}</li>`:''}
        ${cfg.note_funded&&!cfg.note?`<li style="margin-top:0.75rem;font-size:0.85rem;color:#2ECC71;"><strong>üí° ${t('propfirm.note')}:</strong> ${cfg.note_funded}</li>`:''}
      </ul>
    </div>`;

    setTimeout(()=>{ const s=document.getElementById('firmSelector'); if(s) s.addEventListener('change',renderPropFirm); },0);
}

function renderCEOView() {
    const aa=data.master_comptes, ap=data.payouts;
    const totalP=ap.reduce((s,p)=>s+p.amount,0), totalI=aa.reduce((s,a)=>s+a.challengeCost,0);
    const mult=totalI>0?totalP/totalI:0;
    const years=[...new Set(aa.map(a=>a.year))].sort();
    const yp=years.map(y=>ap.filter(p=>p.year===y).reduce((s,p)=>s+p.amount,0));
    const bestY=years[yp.indexOf(Math.max(...yp))]||'N/A';
    const locale=currentLanguage==='es'?'es-ES':'en-US';

    document.getElementById('ceoview').innerHTML=`
    <div class="dashboard-header"><h2>${t('ceoview.title')} ¬∑ ${t('ceoview.allTime')}</h2><div class="subtitle">${t('ceoview.mode')}</div></div>
    ${aa.length===0?`<div style="text-align:center;padding:3rem;color:#9AA0A6;border:1px dashed rgba(230,232,235,0.15);border-radius:12px;margin-bottom:2rem;"><div style="font-size:3rem;margin-bottom:1rem;">üìà</div><div style="font-size:1.1rem;font-weight:600;margin-bottom:0.5rem;">${t('ceoview.noHistory')}</div><div style="font-size:0.9rem;">${t('ceoview.whenYouHave')}</div></div>`:''}
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">${t('ceoview.totalPayouts')}</div><div class="kpi-value">$${totalP.toLocaleString()}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('ceoview.totalInvested')}</div><div class="kpi-value success">$${totalI.toLocaleString()}</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('ceoview.capitalMultiple')}</div><div class="kpi-value">${mult.toFixed(2)}x</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('ceoview.bestYear')}</div><div class="kpi-value">${bestY}</div></div>
    </div>
    <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('ceoview.yearlyEvolution')}</h3><div class="chart-container" style="max-width:800px;"><canvas id="ceoLineChart"></canvas></div></div>
    <div class="table-container"><h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:700;">${t('ceoview.recentPayouts')}</h3>
    ${ap.length===0?`<div class="empty-state">${t('ceoview.noPayouts')}</div>`:`
    <table><thead><tr><th>${t('ceoview.date')}</th><th>${t('ceoview.account')}</th><th>${t('ceoview.firm')}</th><th>${t('ceoview.amount')}</th><th>${t('ceoview.status')}</th></tr></thead><tbody>
    ${ap.sort((a,b)=>new Date(b.payoutDate)-new Date(a.payoutDate)).slice(0,10).map(p=>{
        const ac=aa.find(a=>a.id===p.accountId);
        const sc2=p.status==='Recibido'||p.status==='Received'?'funded':p.status==='Aprobado'||p.status==='Approved'?'phase2':'phase1';
        return `<tr><td>${new Date(p.payoutDate).toLocaleDateString(locale)}</td><td style="font-weight:600;">${ac?ac.accountNumber:'N/A'}</td><td>${ac?ac.propFirm:'N/A'}</td><td style="font-weight:700;color:#2ECC71;">$${p.amount.toLocaleString()}</td><td><span class="status-badge ${sc2}">${p.status}</span></td></tr>`;
    }).join('')}</tbody></table>`}</div>`;

    if (years.length>0){
        if(window.ceoChart)window.ceoChart.destroy();
        window.ceoChart=new Chart(document.getElementById('ceoLineChart'),{type:'line',data:{labels:years,datasets:[{label:'Payouts',data:yp,borderColor:'#2ECC71',backgroundColor:'rgba(46,204,113,0.1)',borderWidth:3,pointRadius:6,pointBackgroundColor:'#2ECC71',pointBorderColor:'#121417',pointBorderWidth:2,tension:0.3,fill:true}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{backgroundColor:'#181B20',callbacks:{label:(c)=>`$${c.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:true,ticks:{color:'#9AA0A6',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'rgba(230,232,235,0.05)'}},x:{ticks:{color:'#9AA0A6'},grid:{display:false}}}}});
    }
}

function renderCapitalEfficiency() {
    const activeYear=parseInt(document.getElementById('yearSelect').value);
    const aa=data.master_comptes, ap=data.payouts;
    const tw=ap.reduce((s,p)=>s+p.amount,0), ti=aa.reduce((s,a)=>s+a.challengeCost,0);
    const ratio=ti>0?tw/ti:0, pct=ti>0?Math.min((tw/ti)*100,100):0;
    const funded=aa.filter(a=>a.status==='FUNDED');
    const avg=funded.length>0?funded.reduce((s,a)=>s+calculateDaysToFunding(a),0)/funded.length:0;
    let be=t('efficiency.pending');
    if(ti>0&&tw>0){ if(tw>=ti){be=t('efficiency.reached');}else{ const r3=ap.slice().sort((a,b)=>new Date(b.payoutDate)-new Date(a.payoutDate)).slice(0,10).reduce((s,p)=>s+p.amount,0)/3; if(r3>0){ const mo=Math.ceil((ti-tw)/r3),bd=new Date(); bd.setMonth(bd.getMonth()+mo); const mn=currentLanguage==='es'?['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; be=`${mn[bd.getMonth()]} ${bd.getFullYear()}`; }}}
    const locale=currentLanguage==='es'?'es-ES':'en-US';

    document.getElementById('efficiency').innerHTML=`
    <div class="dashboard-header"><h2>${t('efficiency.title')} ¬∑ ${activeYear}</h2>${aa.length===0?`<div style="text-align:center;padding:0.5rem;color:#F39C12;font-size:0.85rem;">${t('efficiency.noData')}</div>`:''}<div class="subtitle">${t('propfirm.historical')} ¬∑ ${t('propfirm.updated')} ${new Date().toLocaleDateString(locale,{month:'short',year:'numeric'})}</div></div>
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">${t('efficiency.withdrawnInvested')}</div><div class="kpi-value success">${ratio.toFixed(2)}x</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('efficiency.avgTimeFunding')}</div><div class="kpi-value">${Math.round(avg)} <span style="font-size:1rem;">days</span></div></div>
      <div class="kpi-card"><div class="kpi-label">${t('efficiency.selfFundedSystem')}</div><div class="kpi-value success">${pct.toFixed(0)}%</div></div>
      <div class="kpi-card"><div class="kpi-label">${t('efficiency.breakEven')}</div><div class="kpi-value" style="font-size:1.4rem;">${be}</div><div class="kpi-subtitle">${t('efficiency.projection')}</div></div>
    </div>
    <div class="grid-2">
      <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('efficiency.fundedInvested')}</h3>
        <div class="bar-chart">
          <div class="bar-row"><div class="bar-label">FUNDED</div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(ratio*20,100)}%;background:linear-gradient(90deg,#2ECC71,#27AE60);">${ratio>0.5?`<span class="bar-value">$${tw.toLocaleString()}</span>`:''}</div></div><div class="bar-count">$${tw.toLocaleString()}</div></div>
          <div class="bar-row"><div class="bar-label">INVESTED</div><div class="bar-track"><div class="bar-fill" style="width:50%;background:linear-gradient(90deg,#9AA0A6,#7F8C8D);"><span class="bar-value">$${ti.toLocaleString()}</span></div></div><div class="bar-count">$${ti.toLocaleString()}</div></div>
        </div>
        <div style="margin-top:1.5rem;text-align:center;"><div class="kpi-value success" style="font-size:2.5rem;">+${((ratio-1)*100).toFixed(0)}%</div></div>
      </div>
      <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('efficiency.selfFundingStatus')}</h3>
        <div class="gauge-container"><canvas id="selfFundingGauge"></canvas><div class="gauge-text"><div class="gauge-percentage">${pct.toFixed(0)}%</div><div class="gauge-label">$${tw.toLocaleString()} WITHDRAWN</div></div></div>
      </div>
    </div>
    <div class="table-container"><h3 style="margin-bottom:0.5rem;font-size:1.1rem;font-weight:700;">${t('efficiency.recoveryTrend')}</h3><div style="color:#9AA0A6;font-size:0.8rem;margin-bottom:1.5rem;">${t('efficiency.recoverySubtitle')}</div><div class="chart-container" style="max-width:800px;"><canvas id="autofinancingChart"></canvas></div></div>`;

    const gCtx=document.getElementById('selfFundingGauge');
    if(gCtx){if(window.gaugeChart)window.gaugeChart.destroy();window.gaugeChart=new Chart(gCtx,{type:'doughnut',data:{datasets:[{data:[pct,100-pct],backgroundColor:['#2ECC71','rgba(230,232,235,0.1)'],borderWidth:0,circumference:180,rotation:270}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{enabled:false}},cutout:'75%'}});}

    const tCtx=document.getElementById('autofinancingChart');
    if(tCtx){
        if(window.autofinancingChart)window.autofinancingChart.destroy();
        const sorted=[...ap].filter(p=>p.payoutDate).sort((a,b)=>new Date(a.payoutDate)-new Date(b.payoutDate));
        let labels=[],vals=[];
        if(sorted.length>0){
            const mm={};
            sorted.forEach(p=>{const d=new Date(p.payoutDate);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;mm[k]=(mm[k]||0)+p.amount;});
            const mn=currentLanguage==='es'?['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            let cum=0;
            Object.keys(mm).sort().forEach(k=>{cum+=mm[k];const[yr,mo]=k.split('-');labels.push(`${mn[parseInt(mo)-1]} ${yr}`);vals.push(ti>0?parseFloat((cum/ti*100).toFixed(1)):0);});
        }else{labels=['No data'];vals=[0];}
        window.autofinancingChart=new Chart(tCtx,{type:'line',data:{labels,datasets:[{label:'% Payouts/Invested',data:vals,borderColor:'#2ECC71',backgroundColor:'rgba(46,204,113,0.1)',borderWidth:3,pointRadius:5,pointBackgroundColor:'#2ECC71',pointBorderColor:'#121417',pointBorderWidth:2,tension:0.3,fill:true}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{backgroundColor:'#181B20',callbacks:{label:(c)=>`${c.parsed.y.toFixed(1)}% recovered`}}},scales:{y:{beginAtZero:true,ticks:{color:'#9AA0A6',callback:v=>v+'%'},grid:{color:'rgba(230,232,235,0.05)'}},x:{ticks:{color:'#9AA0A6',maxRotation:45},grid:{display:false}}}}});
    }
}

function renderWrapped() {
    const activeYear=parseInt(document.getElementById('yearSelect').value);
    const ya=data.master_comptes.filter(a=>a.year===activeYear);
    const yp=data.payouts.filter(p=>p.year===activeYear);
    const tp=yp.reduce((s,p)=>s+p.amount,0), ti=ya.reduce((s,a)=>s+a.challengeCost,0);
    const roi=ti>0?((tp-ti)/ti*100):0, funded=ya.filter(a=>a.status==='FUNDED').length;
    const fdWD=ya.filter(a=>a.status==='FUNDED').map(a=>({...a,days:calculateDaysToFunding(a)})).sort((a,b)=>a.days-b.days);
    const qf=fdWD.length>0?fdWD[0].days:0, mult=ti>0?tp/ti:0, sfp=ti>0?Math.min((tp/ti)*100,100):0;
    const total=ya.length, p1wr=total>0?(ya.filter(a=>a.status!=='PHASE 1'&&a.status!=='SUSPENDED').length/total*100):0;
    const pp1=ya.filter(a=>a.status==='PHASE 2'||a.status==='FUNDED').length, p2wr=pp1>0?(funded/pp1*100):0;
    const avgT=fdWD.length>0?fdWD.reduce((s,a)=>s+a.days,0)/fdWD.length:0;
    const firms=['FTMO','Alpha Capital Group','Orion Funded','Bullfy','FundedNext','The5ers','MyForexFunds'];
    const pbf=firms.map(f=>{const ids=ya.filter(a=>a.propFirm===f).map(a=>a.id);return{firm:f,payouts:yp.filter(p=>ids.includes(p.accountId)).reduce((s,p)=>s+p.amount,0)};}).filter(f=>f.payouts>0).sort((a,b)=>b.payouts-a.payouts);
    const cbf=firms.map(f=>({firm:f,count:ya.filter(a=>a.propFirm===f&&a.status==='FUNDED').length})).filter(f=>f.count>0);

    document.getElementById('wrapped').innerHTML=`
    <div class="wrapped-header"><div class="wrapped-title">${t('wrapped.title')} ¬∑ ${activeYear}</div><div class="wrapped-subtitle">${t('wrapped.subtitle')}</div>
      <div style="margin-top:1rem;"><select id="wrappedYearSelect" style="padding:0.75rem 1.5rem;background:#181B20;border:1px solid rgba(243,156,18,0.3);border-radius:8px;color:#E6E8EB;font-size:0.95rem;font-weight:600;">
        ${[2023,2024,2025,2026].map(y=>`<option value="${y}" ${activeYear===y?'selected':''}>${y}</option>`).join('')}
      </select><span style="margin-left:1rem;color:#9AA0A6;font-size:0.8rem;">${t('wrapped.synced')}</span></div>
    </div>
    ${ya.length===0?`<div style="text-align:center;padding:3rem;color:#9AA0A6;border:1px dashed rgba(230,232,235,0.15);border-radius:12px;margin-bottom:2rem;"><div style="font-size:3rem;margin-bottom:1rem;">üìä</div><div style="font-size:1.1rem;font-weight:600;margin-bottom:0.5rem;">${t('wrapped.noData')} ${activeYear}</div><div style="font-size:0.9rem;">${t('wrapped.createFirst')}</div></div>`:''}
    <div class="kpi-grid">
      <div class="kpi-card" style="background:linear-gradient(135deg,rgba(46,204,113,0.05),rgba(52,152,219,0.05));border:1px solid rgba(46,204,113,0.2);"><div class="kpi-value success" style="font-size:2.5rem;">+$${tp.toLocaleString()}</div><div class="kpi-label">${t('wrapped.totalPayouts')}</div></div>
      <div class="kpi-card" style="background:linear-gradient(135deg,rgba(243,156,18,0.05),rgba(230,126,34,0.05));border:1px solid rgba(243,156,18,0.2);"><div class="kpi-value warning" style="font-size:2.5rem;">${(tp>0&&ti>0)?(roi>=0?'+':'')+roi.toFixed(0)+'%':'‚Äî'}</div><div class="kpi-label">${t('wrapped.avgRoi')}</div></div>
      <div class="kpi-card" style="background:linear-gradient(135deg,rgba(52,152,219,0.05),rgba(41,128,185,0.05));border:1px solid rgba(52,152,219,0.2);"><div class="kpi-value" style="font-size:2.5rem;color:#F39C12;">${qf>0?qf+' <span style="font-size:1.2rem;">'+t('wrapped.days')+'</span>':'‚Äî'}</div><div class="kpi-label">${t('wrapped.quickestFunding')}</div></div>
    </div>
    <div class="table-container"><h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">${t('wrapped.byFirm')}</h3><div class="chart-container" style="max-width:600px;"><canvas id="wrappedPayoutsChart"></canvas></div></div>
    <div class="grid-2">
      <div class="kpi-card" style="border:1px solid rgba(46,204,113,0.2);"><div class="kpi-label" style="text-align:center;">${t('wrapped.accountsFunded')}</div><div style="text-align:center;padding:2rem 0;"><div class="kpi-value success" style="font-size:3.5rem;">${funded}</div></div></div>
      <div class="kpi-card" style="border:1px solid rgba(46,204,113,0.2);"><div class="kpi-label" style="text-align:center;">${t('wrapped.capitalMultiple')}</div><div style="text-align:center;padding:2rem 0;"><div class="kpi-value" style="font-size:3.5rem;">${mult>0?mult.toFixed(2)+'x':'‚Äî'}</div></div></div>
      <div class="kpi-card" style="border:1px solid rgba(46,204,113,0.2);"><div class="kpi-label" style="text-align:center;">${t('wrapped.selfFunded')}</div><div style="text-align:center;padding:2rem 0;"><div class="kpi-value success" style="font-size:3.5rem;">${sfp.toFixed(0)}%</div></div></div>
    </div>
    ${total>0?`<div class="achievement-card"><div class="achievement-icon">‚úÖ</div><div class="achievement-content"><h4>${p1wr.toFixed(0)}% ${t('wrapped.phase1Success')}</h4><p>${pp1} ${t('wrapped.passedPhase1Of')} ${total}</p></div></div>`:''}
    ${funded>0?`<div class="achievement-card"><div class="achievement-icon">üî•</div><div class="achievement-content"><h4>${p2wr.toFixed(0)}% ${t('wrapped.phase2Success')}</h4><p>${t('wrapped.converted')} ${p2wr.toFixed(0)}% ${t('wrapped.toFunded')}</p></div></div>`:''}
    ${avgT>0?`<div class="achievement-card"><div class="achievement-icon">‚ö°</div><div class="achievement-content"><h4>${Math.round(avgT)} ${t('wrapped.avgTime')}</h4><p>${t('wrapped.avgFundedDays')} ${Math.round(avgT)} ${t('wrapped.daysLower')}</p></div></div>`:''}
    ${cbf.map(f=>`<div class="achievement-card"><div class="achievement-icon">${f.firm==='FTMO'?'‚óÜ':f.firm==='MyForexFunds'?'‚óá':'‚óà'}</div><div class="achievement-content"><h4>${f.count} ${f.firm} ${t('wrapped.completed')}</h4><p>${t('wrapped.successfullyFunded')} ${f.count} ${f.firm} ${f.count>1?t('wrapped.accounts'):t('wrapped.account')}</p></div></div>`).join('')}
    <div class="wrapped-generator">
      <h2 style="font-size:1.8rem;font-weight:800;text-align:center;margin-bottom:2rem;color:#F39C12;">${t('wrapped.generatorTitle')}</h2>
      <div class="config-section"><div class="config-title">${t('wrapped.design')}</div>
        <div class="design-selector">
          <div class="design-option selected" data-design="gradient1" onclick="selectDesign('gradient1')"><div class="design-preview gradient1"></div><div style="font-size:0.85rem;font-weight:600;">${t('wrapped.fire')}</div></div>
          <div class="design-option" data-design="gradient2" onclick="selectDesign('gradient2')"><div class="design-preview gradient2"></div><div style="font-size:0.85rem;font-weight:600;">${t('wrapped.success')}</div></div>
          <div class="design-option" data-design="gradient3" onclick="selectDesign('gradient3')"><div class="design-preview gradient3"></div><div style="font-size:0.85rem;font-weight:600;">${t('wrapped.ocean')}</div></div>
          <div class="design-option" data-design="dark" onclick="selectDesign('dark')"><div class="design-preview dark"></div><div style="font-size:0.85rem;font-weight:600;">${t('wrapped.dark')}</div></div>
        </div>
      </div>
      <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem;">
        <button class="btn-primary" onclick="showAlert('${t('alerts.downloaded')}','success')">${t('wrapped.preview')}</button>
      </div>
    </div>`;

    if(pbf.length>0){if(window.wrappedChart)window.wrappedChart.destroy();window.wrappedChart=new Chart(document.getElementById('wrappedPayoutsChart'),{type:'bar',data:{labels:pbf.map(f=>f.firm),datasets:[{data:pbf.map(f=>f.payouts),backgroundColor:['#2ECC71','#9AA0A6','#F39C12'],borderRadius:8}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{backgroundColor:'#181B20',callbacks:{label:(c)=>`$${c.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:true,ticks:{color:'#9AA0A6',callback:v=>'$'+(v/1000).toFixed(0)+'k'},grid:{color:'rgba(230,232,235,0.05)'}},x:{ticks:{color:'#9AA0A6'},grid:{display:false}}}}});}

    setTimeout(()=>{
        const ws=document.getElementById('wrappedYearSelect');
        if(ws) ws.addEventListener('change',function(){document.getElementById('yearSelect').value=this.value;renderWrapped();});
    },100);
}

function initializeDashboard() { updateUI(); }

function updateUI() {
    const allActive = data.master_comptes.filter(a=>a.active);
    const funded = data.master_comptes.filter(a=>a.status==='FUNDED'&&a.active);
    const locale = currentLanguage==='es'?'es-ES':'en-US';

    const us = document.getElementById('updateAccountId');
    if(us){
        us.innerHTML = allActive.length===0
            ? `<option value="">${currentLanguage==='es'?'No hay cuentas disponibles':'No accounts available'}</option>`
            : `<option value="">${currentLanguage==='es'?'Selecciona una cuenta...':'Select an account...'}</option>`
              + allActive.map(a=>`<option value="${a.id}">${a.accountNumber||a.id} - ${a.propFirm} (${a.status})</option>`).join('');

        // Remove old listener to avoid duplicates, then re-add
        const fresh = us.cloneNode(true);
        us.parentNode.replaceChild(fresh, us);
        fresh.addEventListener('change', function() { filterStatusOptions(this.value); });
        // Initialise hint for whatever is pre-selected
        filterStatusOptions(fresh.value);
    }

    const ps = document.getElementById('payoutAccountId');
    if(ps){ ps.innerHTML = funded.length===0?`<option value="">${currentLanguage==='es'?'No hay cuentas fondeadas':'No funded accounts'}</option>`:`<option value="">${currentLanguage==='es'?'Selecciona una cuenta...':'Select an account...'}</option>`+funded.map(a=>`<option value="${a.id}">${a.accountNumber||a.id} - ${a.propFirm}</option>`).join(''); }

    const at = document.querySelector('.tab.active');
    const tab = at ? at.getAttribute('data-tab') : 'control';
    switch(tab) {
        case 'overview': renderOverview(); break;
        case 'performance': renderPerformance(); break;
        case 'propfirm': renderPropFirm(); break;
        case 'ceoview': renderCEOView(); break;
        case 'efficiency': renderCapitalEfficiency(); break;
        case 'wrapped': renderWrapped(); break;
    }
}

window.selectDesign = function(d) {
    document.querySelectorAll('.design-option').forEach(o=>o.classList.remove('selected'));
    document.querySelector(`[data-design="${d}"]`)?.classList.add('selected');
};
window.toggleHistoryPanel = toggleHistoryPanel;
window.deleteHistoryItem = deleteHistoryItem;
window.openResetModal = openResetModal;
window.closeResetModal = closeResetModal;
window.confirmReset = confirmReset;
window.setLanguage = setLanguage;
window.toggleLangDropdown = toggleLangDropdown;
</script>
</body>
</html>
