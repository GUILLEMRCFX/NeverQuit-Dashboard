<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEVER QUIT DASHBOARD</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #121417;
            color: #E6E8EB;
            line-height: 1.6;
            padding: 2rem;
        }

        /* Language Selector */
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            gap: 0.5rem;
            background: #181B20;
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid rgba(230, 232, 235, 0.1);
        }

        .lang-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid rgba(230, 232, 235, 0.1);
            border-radius: 6px;
            color: #9AA0A6;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .lang-btn:hover {
            border-color: #2ECC71;
            color: #E6E8EB;
        }

        .lang-btn.active {
            background: #2ECC71;
            color: #121417;
            border-color: #2ECC71;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #181B20;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(230, 232, 235, 0.1);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #E6E8EB;
            margin-bottom: 1rem;
        }

        .modal-body {
            color: #9AA0A6;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.cancel {
            background: #9AA0A6;
            color: #121417;
        }

        .modal-btn.cancel:hover {
            background: #7F8C8D;
        }

        .modal-btn.confirm {
            background: #E74C3C;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #C0392B;
        }

        .modal-btn.confirm:not(:disabled):hover {
            background: #C0392B;
        }

        #confirmResetBtn:not(:disabled) {
            opacity: 1 !important;
            cursor: pointer !important;
        }

        #resetConfirmInput:focus {
            outline: none;
            border-color: #E74C3C !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(230, 232, 235, 0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #E6E8EB 0%, #2ECC71 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #9AA0A6;
            font-size: 0.9rem;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .year-selector label {
            color: #9AA0A6;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
        }

        .year-selector select {
            padding: 0.5rem 1rem;
            background: #181B20;
            border: 1px solid rgba(230, 232, 235, 0.1);
            border-radius: 6px;
            color: #E6E8EB;
            font-family: 'Inter', sans-serif;
        }

        .btn-reset {
            padding: 0.5rem 1rem;
            background: #E74C3C;
            color: white;
            border: none;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-reset:hover {
            background: #C0392B;
            transform: translateY(-1px);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(230, 232, 235, 0.05);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #2ECC71 rgba(230, 232, 235, 0.05);
            padding-bottom: 0.5rem;
            position: relative;
        }

        .tabs::-webkit-scrollbar {
            height: 6px;
        }

        .tabs::-webkit-scrollbar-track {
            background: rgba(230, 232, 235, 0.05);
            border-radius: 3px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: #2ECC71;
            border-radius: 3px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: #27AE60;
        }

        .tab-container {
            position: relative;
            overflow: hidden;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #9AA0A6;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            color: #E6E8EB;
        }

        .tab.active {
            color: #2ECC71;
            border-bottom-color: #2ECC71;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: #181B20;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(230, 232, 235, 0.05);
        }

        .card-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #9AA0A6;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #9AA0A6;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #121417;
            border: 1px solid rgba(230, 232, 235, 0.1);
            border-radius: 8px;
            color: #E6E8EB;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2ECC71;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            background: #2ECC71;
            color: #121417;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #27AE60;
            transform: translateY(-1px);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: #181B20;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(230, 232, 235, 0.05);
        }

        .kpi-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #9AA0A6;
            margin-bottom: 0.75rem;
            letter-spacing: 0.05em;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'Inter', sans-serif;
            color: #E6E8EB;
            margin-bottom: 0.5rem;
        }

        .kpi-value.success { color: #2ECC71; }
        .kpi-value.warning { color: #F39C12; }
        .kpi-value.danger { color: #E74C3C; }

        .kpi-subtitle {
            font-size: 0.8rem;
            color: #9AA0A6;
        }

        .table-container {
            background: #181B20;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(230, 232, 235, 0.05);
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid rgba(230, 232, 235, 0.1);
            color: #9AA0A6;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(230, 232, 235, 0.05);
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(46, 204, 113, 0.05);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.funded {
            background: rgba(46, 204, 113, 0.15);
            color: #2ECC71;
        }

        .status-badge.phase1 {
            background: rgba(52, 152, 219, 0.15);
            color: #3498DB;
        }

        .status-badge.phase2 {
            background: rgba(243, 156, 18, 0.15);
            color: #F39C12;
        }

        .status-badge.suspended {
            background: rgba(231, 76, 60, 0.15);
            color: #E74C3C;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .alert.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        .alert.success {
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .alert.success::before {
            content: '‚úì';
            font-size: 1.5rem;
            font-weight: bold;
        }

        .alert.error {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .alert.error::before {
            content: '‚úï';
            font-size: 1.5rem;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #9AA0A6;
        }

        .chart-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 2rem;
            border-bottom: 1px solid rgba(230, 232, 235, 0.1);
        }

        .dashboard-header h2 {
            font-family: 'Inter', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: #E6E8EB;
            margin-bottom: 0.5rem;
            letter-spacing: 0.02em;
        }

        .dashboard-header .subtitle {
            color: #9AA0A6;
            font-size: 0.95rem;
        }

        .bar-chart {
            width: 100%;
            margin: 1rem 0;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bar-label {
            min-width: 100px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #E6E8EB;
        }

        .bar-track {
            flex: 1;
            height: 32px;
            background: rgba(230, 232, 235, 0.05);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ECC71, #27AE60);
            border-radius: 6px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
        }

        .bar-value {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: #121417;
        }

        .bar-count {
            min-width: 60px;
            text-align: right;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: #E6E8EB;
        }

        .gauge-container {
            position: relative;
            max-width: 300px;
            margin: 2rem auto;
        }

        .gauge-text {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .gauge-percentage {
            font-family: 'Inter', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            color: #2ECC71;
        }

        .gauge-label {
            font-size: 0.85rem;
            color: #9AA0A6;
            text-transform: uppercase;
            font-weight: 600;
        }

        .wrapped-header {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(46, 204, 113, 0.1));
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .wrapped-title {
            font-family: 'Inter', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #F39C12, #2ECC71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .wrapped-subtitle {
            color: #9AA0A6;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .metric-highlight {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(46, 204, 113, 0.15);
            border-radius: 6px;
            color: #2ECC71;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
        }

        .achievement-card {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(52, 152, 219, 0.05));
            border: 1px solid rgba(46, 204, 113, 0.2);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .achievement-icon {
            font-size: 2rem;
        }

        .achievement-content h4 {
            font-family: 'Inter', sans-serif;
            color: #E6E8EB;
            margin-bottom: 0.25rem;
        }

        .achievement-content p {
            color: #9AA0A6;
            font-size: 0.85rem;
        }

        .wrapped-generator {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(46, 204, 113, 0.1));
            border: 2px solid rgba(243, 156, 18, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .config-section {
            background: #181B20;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .config-title {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #F39C12;
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }

        .metric-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(230, 232, 235, 0.03);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .metric-checkbox:hover {
            background: rgba(46, 204, 113, 0.1);
        }

        .metric-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .metric-checkbox label {
            cursor: pointer;
            flex: 1;
            font-size: 0.9rem;
            color: #E6E8EB;
        }

        .preview-container {
            background: #121417;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-canvas {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .btn-primary {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #F39C12, #E67E22);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 0.05em;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: #9AA0A6;
            color: #121417;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #7F8C8D;
        }

        .design-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .design-option {
            padding: 1rem;
            background: rgba(230, 232, 235, 0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .design-option:hover {
            border-color: #F39C12;
        }

        .design-option.selected {
            border-color: #2ECC71;
            background: rgba(46, 204, 113, 0.1);
        }

        .design-preview {
            width: 100%;
            height: 100px;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #1a1d23, #252930);
        }

        .design-preview.gradient1 {
            background: linear-gradient(135deg, #F39C12, #E67E22);
        }

        .design-preview.gradient2 {
            background: linear-gradient(135deg, #2ECC71, #27AE60);
        }

        .design-preview.gradient3 {
            background: linear-gradient(135deg, #3498DB, #2980B9);
        }

        .design-preview.dark {
            background: #121417;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #121417 0%, #1a1d23 100%);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            background: #181B20;
            border-radius: 20px;
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(230, 232, 235, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: loginSlideIn 0.5s ease-out;
        }

        @keyframes loginSlideIn {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #E6E8EB 0%, #2ECC71 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #9AA0A6;
            font-size: 0.9rem;
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .login-form label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #9AA0A6;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .login-form input {
            width: 100%;
            padding: 1rem;
            background: #121417;
            border: 1px solid rgba(230, 232, 235, 0.1);
            border-radius: 10px;
            color: #E6E8EB;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: #2ECC71;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .dev-bypass {
            margin-top: 1rem;
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(230, 232, 235, 0.05);
        }

        .dev-bypass button {
            background: transparent;
            border: 1px solid rgba(230, 232, 235, 0.1);
            color: #9AA0A6;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dev-bypass button:hover {
            border-color: #2ECC71;
            color: #2ECC71;
        }

        .login-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #E74C3C;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }

        .login-error.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @media (max-width: 968px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .language-selector {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Language Selector -->
    <div class="language-selector">
        <button class="lang-btn active" onclick="setLanguage('es')" id="btn-es">ES</button>
        <button class="lang-btn" onclick="setLanguage('en')" id="btn-en">EN</button>
    </div>

    <!-- Login Screen -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div class="login-header">
                <h1 data-i18n="app.name">NEVER QUIT</h1>
                <p data-i18n="login.subtitle">Dashboard de Gesti√≥n Profesional</p>
            </div>
            
            <div id="loginError" class="login-error" data-i18n="login.error">
                Usuario o contrase√±a incorrectos
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label data-i18n="login.username">Usuario</label>
                    <input type="text" id="loginUsername" data-i18n-placeholder="login.usernamePlaceholder" placeholder="Introduce tu usuario" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label data-i18n="login.password">Contrase√±a</label>
                    <input type="password" id="loginPassword" data-i18n-placeholder="login.passwordPlaceholder" placeholder="Introduce tu contrase√±a" autocomplete="current-password">
                </div>
                
                <button type="submit" class="login-btn" data-i18n="login.submit">Entrar al Dashboard</button>
            </form>
            
            <div class="dev-bypass">
                <button onclick="bypassLogin()" title="Solo durante desarrollo" data-i18n="login.devMode">üîß Modo Desarrollo (Skip Login)</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Modal de confirmaci√≥n -->
        <div id="resetModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header" data-i18n="modal.resetTitle">‚ö†Ô∏è Confirmar Reset</div>
                <div class="modal-body">
                    <span data-i18n="modal.resetConfirm">¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n <strong>no se puede deshacer</strong>.</span>
                    <br><br>
                    <span data-i18n="modal.resetItems">Se borrar√°n:</span>
                    <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                        <li data-i18n="modal.itemChallenges">Todas las challenges</li>
                        <li data-i18n="modal.itemPayouts">Todos los payouts</li>
                        <li data-i18n="modal.itemHistory">Todo el historial</li>
                    </ul>
                    <br>
                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #E74C3C; margin-bottom: 0.5rem; text-transform: uppercase;" data-i18n="modal.typeReset">
                        Escribe RESET para confirmar:
                    </label>
                    <input type="text" id="resetConfirmInput" placeholder="RESET" 
                        style="width: 100%; padding: 0.75rem; background: #121417; border: 2px solid rgba(231, 76, 60, 0.3); border-radius: 8px; color: #E6E8EB; font-family: 'Inter', sans-serif; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.1em;"
                        oninput="document.getElementById('confirmResetBtn').disabled = this.value.toUpperCase() !== 'RESET'">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeResetModal()" data-i18n="modal.cancel">Cancelar</button>
                    <button id="confirmResetBtn" class="modal-btn confirm" onclick="confirmReset()" disabled style="opacity: 0.5; cursor: not-allowed;" data-i18n="modal.confirmDelete">S√≠, Eliminar Todo</button>
                </div>
            </div>
        </div>

        <div class="header">
            <h1 data-i18n="app.fullName">NEVER QUIT DASHBOARD</h1>
            <p data-i18n="app.tagline">Sistema de Gesti√≥n de Capital Profesional</p>
            <div class="year-selector">
                <label data-i18n="year.label">A√ëO ACTIVO:</label>
                <select id="yearSelect">
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                </select>
                <button class="btn-reset" onclick="openResetModal()" data-i18n="actions.resetData">üîÑ Reset Datos</button>
                <button class="btn-reset" onclick="logout()" style="background: #9AA0A6;" data-i18n="actions.logout">üö™ Salir</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="tabs">
            <button class="tab active" data-tab="control" data-i18n="tabs.control">Control Center</button>
            <button class="tab" data-tab="overview" data-i18n="tabs.overview">Overview</button>
            <button class="tab" data-tab="performance" data-i18n="tabs.performance">Performance</button>
            <button class="tab" data-tab="propfirm" data-i18n="tabs.propfirm">Prop Firm</button>
            <button class="tab" data-tab="ceoview" data-i18n="tabs.ceoview">CEO View</button>
            <button class="tab" data-tab="efficiency" data-i18n="tabs.efficiency">Capital Efficiency</button>
            <button class="tab" data-tab="wrapped" data-i18n="tabs.wrapped">Wrapped</button>
        </div>

        <!-- CONTROL CENTER -->
        <div id="control" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <div class="card-title" data-i18n="forms.createTitle">Create Challenge</div>
                    <div class="form-group">
                        <label data-i18n="forms.propFirm">Prop Firm</label>
                        <select id="createPropFirm">
                            <option>FTMO</option>
                            <option>Alpha Capital Group</option>
                            <option>Orion Funded</option>
                            <option>Bullfy</option>
                            <option>FundedNext</option>
                            <option>The5ers</option>
                            <option>MyForexFunds</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.accountSize">Account Size</label>
                        <select id="createAccountSize">
                            <option>10K</option>
                            <option>25K</option>
                            <option selected>50K</option>
                            <option>100K</option>
                            <option>200K</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.purchaseDate">Purchase Date</label>
                        <input type="date" id="createPurchaseDate">
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.challengeCost">Challenge Cost ($)</label>
                        <input type="number" id="createChallengeCost" placeholder="345.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.accountNumber">Account Number</label>
                        <input type="text" id="createAccountNumber" data-i18n-placeholder="forms.accountNumberPlaceholder" placeholder="N√∫mero de cuenta de la prop firm">
                    </div>
                    <button class="btn" onclick="createChallenge()" data-i18n="forms.createButton">Crear Challenge</button>
                </div>

                <div class="card">
                    <div class="card-title" data-i18n="forms.updateTitle">Update Challenge</div>
                    <div class="form-group">
                        <label data-i18n="forms.account">Account</label>
                        <select id="updateAccountId"></select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.newStatus">New Status</label>
                        <select id="updateNewStatus">
                            <option value="PHASE 1">PHASE 1</option>
                            <option value="PHASE 2">PHASE 2</option>
                            <option value="FUNDED">FUNDED</option>
                            <option value="SUSPENDED">SUSPENDED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.statusDate">Status Date</label>
                        <input type="date" id="updateStatusDate">
                    </div>
                    <button class="btn" onclick="updateChallenge()" data-i18n="forms.updateButton">Actualitzar Challenge</button>
                </div>

                <div class="card">
                    <div class="card-title" data-i18n="forms.payoutTitle">Register Payout</div>
                    <div class="form-group">
                        <label data-i18n="forms.account">Account</label>
                        <select id="payoutAccountId"></select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.amount">Amount ($)</label>
                        <input type="number" id="payoutAmount" placeholder="2500.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.payoutDate">Payout Date</label>
                        <input type="date" id="payoutDate">
                    </div>
                    <div class="form-group">
                        <label data-i18n="forms.status">Status</label>
                        <select id="payoutStatus">
                            <option value="Solicitado" data-i18n="status.requested">Solicitado</option>
                            <option value="Aprobado" data-i18n="status.approved">Aprobado</option>
                            <option value="Recibido" selected data-i18n="status.received">Recibido</option>
                        </select>
                    </div>
                    <button class="btn" onclick="registerPayout()" data-i18n="forms.payoutButton">Registrar Payout</button>
                </div>
            </div>
        </div>

        <!-- OVERVIEW -->
        <div id="overview" class="tab-content"></div>

        <!-- PERFORMANCE -->
        <div id="performance" class="tab-content"></div>

        <!-- PROP FIRM -->
        <div id="propfirm" class="tab-content"></div>

        <!-- CEO VIEW -->
        <div id="ceoview" class="tab-content"></div>

        <!-- CAPITAL EFFICIENCY -->
        <div id="efficiency" class="tab-content"></div>

        <!-- WRAPPED -->
        <div id="wrapped" class="tab-content"></div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE INTERNACIONALIZACI√ìN (i18n)
        // ============================================
        
        const i18n = {
            es: {
                app: {
                    name: "NEVER QUIT",
                    fullName: "NEVER QUIT DASHBOARD",
                    tagline: "Sistema de Gesti√≥n de Capital Profesional"
                },
                login: {
                    subtitle: "Dashboard de Gesti√≥n Profesional",
                    username: "Usuario",
                    password: "Contrase√±a",
                    usernamePlaceholder: "Introduce tu usuario",
                    passwordPlaceholder: "Introduce tu contrase√±a",
                    submit: "Entrar al Dashboard",
                    error: "Usuario o contrase√±a incorrectos",
                    devMode: "üîß Modo Desarrollo (Skip Login)"
                },
                modal: {
                    resetTitle: "‚ö†Ô∏è Confirmar Reset",
                    resetConfirm: "¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n <strong>no se puede deshacer</strong>.",
                    resetItems: "Se borrar√°n:",
                    itemChallenges: "Todas las challenges",
                    itemPayouts: "Todos los payouts",
                    itemHistory: "Todo el historial",
                    typeReset: "Escribe RESET para confirmar:",
                    cancel: "Cancelar",
                    confirmDelete: "S√≠, Eliminar Todo"
                },
                year: {
                    label: "A√ëO ACTIVO:"
                },
                actions: {
                    resetData: "üîÑ Reset Datos",
                    logout: "üö™ Salir"
                },
                tabs: {
                    control: "Control Center",
                    overview: "Overview",
                    performance: "Performance",
                    propfirm: "Prop Firm",
                    ceoview: "CEO View",
                    efficiency: "Capital Efficiency",
                    wrapped: "Wrapped"
                },
                forms: {
                    createTitle: "Create Challenge",
                    updateTitle: "Update Challenge",
                    payoutTitle: "Register Payout",
                    propFirm: "Prop Firm",
                    accountSize: "Account Size",
                    purchaseDate: "Purchase Date",
                    challengeCost: "Challenge Cost ($)",
                    accountNumber: "Account Number",
                    accountNumberPlaceholder: "N√∫mero de cuenta de la prop firm",
                    createButton: "Crear Challenge",
                    account: "Account",
                    newStatus: "New Status",
                    statusDate: "Status Date",
                    updateButton: "Actualitzar Challenge",
                    amount: "Amount ($)",
                    payoutDate: "Payout Date",
                    status: "Status",
                    payoutButton: "Registrar Payout",
                    from: "desde"
                },
                status: {
                    requested: "Solicitado",
                    approved: "Aprobado",
                    received: "Recibido",
                    phase1: "PHASE 1",
                    phase2: "PHASE 2",
                    funded: "FUNDED",
                    suspended: "SUSPENDED"
                },
                overview: {
                    title: "OVERVIEW",
                    updated: "Actualizado",
                    activeFundedCapital: "Active Funded Capital",
                    totalPayouts: "Total Payouts",
                    activeFundedAccounts: "Active Funded Accounts",
                    roiAnnual: "ROI Annual",
                    costs: "Costos",
                    accounts: "cuentas",
                    payments: "pagos",
                    ofTotal: "de total",
                    accountStatus: "‚óá ACCOUNT STATUS",
                    status: "Status",
                    count: "Count",
                    pctActive: "% Activas",
                    totalActive: "Total activas",
                    excluded: "suspendida excluida",
                    excludedPlural: "suspendidas excluidas",
                    noSuspended: "Sin suspendidas",
                    myAccounts: "‚óá MIS CUENTAS",
                    account: "Cuenta",
                    firm: "Prop Firm",
                    size: "Tama√±o",
                    cost: "Coste",
                    date: "Fecha",
                    received: "Payouts recibidos",
                    noAccounts: "Sin cuentas activas"
                },
                performance: {
                    title: "PERFORMANCE",
                    noData: "Sin challenges para",
                    createFirst: "crea una en Control Center",
                    phase1Success: "‚óá TASA DE √âXITO PHASE 1",
                    phase2Success: "TASA DE √âXITO PHASE 2",
                    avgCostFunded: "AVG. COST PER FUNDED ACCOUNT",
                    bestFirmRoi: "BEST PROP FIRM ROI",
                    totalCosts: "Total costs",
                    funded: "funded",
                    challengeSuccess: "‚óá CHALLENGE SUCCESS RATE",
                    approvalRate: "APPROVAL RATE",
                    totalChallenges: "Challenges Totales",
                    inPhase1: "En Phase 1",
                    current: "actual",
                    passedP1: "Pasaron P1",
                    inPhase2: "En Phase 2",
                    summary: "Resumen",
                    passedPhase1: "supera Phase 1",
                    passedPhase2: "supera Phase 2",
                    fundedAccounts: "Cuentas Fondeadas",
                    roiByFirm: "‚óá ROI BY PROP FIRM",
                    of: "de"
                },
                propfirm: {
                    title: "PROP FIRM",
                    noAccounts: "Sin cuentas de",
                    inYear: "en",
                    historical: "Rendimiento Hist√≥rico",
                    updated: "Actualizado",
                    challengesBought: "‚óá CHALLENGES COMPRADAS",
                    accountsFunded: "CUENTAS FONDEADAS",
                    invested: "$ INVERTIDO",
                    payouts: "$ PAYOUTS",
                    roi: "ROI",
                    accountStatus: "‚óá ACCOUNT STATUS",
                    rules: "‚óá REGLAS DE",
                    phase1: "Phase 1",
                    phase2: "Phase 2",
                    maxDailyLoss: "Max Daily Loss",
                    maxLoss: "Max Loss",
                    profitSplit: "Profit Split",
                    minTradingDays: "Min Trading Days",
                    newsChallenge: "News Trading (Challenge)",
                    newsFunded: "News Trading (Funded)",
                    note: "Nota",
                    closed: "CERRADA desde 2023 - Reapertura esperada 2026"
                },
                ceoview: {
                    title: "CEO VIEW",
                    allTime: "ALL TIME",
                    mode: "Modo: PRO",
                    noHistory: "Sin historial todav√≠a",
                    whenYouHave: "Cuando tengas challenges y payouts, aqu√≠ ver√°s tu evoluci√≥n global",
                    totalPayouts: "‚óá TOTAL PAYOUTS",
                    totalInvested: "TOTAL INVESTED",
                    capitalMultiple: "M√öLTIPLO DE CAPITAL",
                    bestYear: "BEST YEAR",
                    yearlyEvolution: "‚óá EVOLUCI√ìN POR A√ëO",
                    progressMetrics: "‚óá M√âTRICAS DE PROGRESO (historial de fases)",
                    calculatedFrom: "Calculado desde el historial de cambios de estado",
                    avgAttempts: "AVG. INTENTOS HASTA FONDEO",
                    phasesPerAccount: "fases por cuenta fondeada",
                    avgDaysPhase1: "AVG. D√çAS EN PHASE 1",
                    untilPassP1: "hasta superar Phase 1",
                    avgDaysPhase2: "AVG. D√çAS EN PHASE 2",
                    untilFunded: "hasta conseguir fondeo",
                    historyEntries: "ENTRADAS EN HISTORIAL",
                    changesRecorded: "cambios de fase registrados",
                    recentPayouts: "‚óá √öLTIMOS PAYOUTS",
                    noPayouts: "No hay payouts registrados",
                    date: "Fecha",
                    account: "Cuenta",
                    firm: "Prop Firm",
                    amount: "Monto",
                    status: "Estado"
                },
                efficiency: {
                    title: "CAPITAL EFFICIENCY",
                    noData: "Sin datos ‚Äî crea tu primera challenge",
                    withdrawnInvested: "$ WITHDRAWN / $ INVESTED",
                    avgTimeFunding: "TIEMPO PROMEDIO A FONDEO",
                    selfFundedSystem: "SISTEMA AUTO-FINANCIADO",
                    breakEven: "TIMING BREAK-EVEN",
                    projection: "proyecci√≥n basada en ritmo actual",
                    reached: "‚úÖ Alcanzado",
                    pending: "Pendiente",
                    fundedInvested: "‚óá FUNDED / INVESTED",
                    selfFundingStatus: "‚óá SELF-FUNDING STATUS",
                    recoveryTrend: "‚óá TENDENCIA ACUMULADA DE RECUPERACI√ìN",
                    recoverySubtitle: "% de lo invertido recuperado mediante payouts ¬∑ Datos reales mes a mes",
                    noData2026: "Sin datos para 2026",
                    createFirst: "Crea tu primera challenge en Control Center para ver tu Wrapped",
                    selfFunding: "‚ôªÔ∏è SISTEMA AUTO-FINANCIADO"
                },
                wrapped: {
                    title: "PROP FIRM WRAPPED",
                    subtitle: "TU A√ëO DE TRADING EN REVISI√ìN",
                    synced: "‚Üë sincronizado con el selector de a√±o del header",
                    noData: "Sin datos para",
                    createFirst: "Crea tu primera challenge en Control Center para ver tu Wrapped",
                    totalPayouts: "TOTAL PAYOUTS",
                    avgRoi: "ROI PROMEDIO",
                    quickestFunding: "FONDEO M√ÅS R√ÅPIDO",
                    days: "DAYS",
                    byFirm: "‚óá PAYOUTS POR PROP FIRM",
                    accountsFunded: "üå± CUENTAS FONDEADAS",
                    capitalMultiple: "üí∞ M√öLTIPLO DE CAPITAL",
                    selfFunded: "‚ôªÔ∏è SISTEMA AUTO-FINANCIADO",
                    phase1Success: "% TASA DE √âXITO PHASE 1",
                    passedPhase1Of: "de challenges superaron Phase 1",
                    phase2Success: "% TASA DE √âXITO PHASE 2",
                    converted: "Convertiste",
                    toFunded: "de intentos de Phase 2 en cuentas fondeadas",
                    avgTime: "DAYS TIEMPO PROMEDIO HASTA FONDEO",
                    avgFundedDays: "En promedio, fondeaste cuentas en",
                    daysLower: "d√≠as",
                    completed: "COMPLETADAS",
                    successfullyFunded: "Fondeaste exitosamente",
                    account: "cuenta",
                    accounts: "cuentas",
                    generatorTitle: "üé® GENERAR TU WRAPPED PERSONALIZADO",
                    period: "‚è±Ô∏è Periodo",
                    monthly: "Mensual",
                    yearly: "Anual",
                    metrics: "üìä M√©tricas a Incluir",
                    design: "üé® Dise√±o",
                    fire: "Fire",
                    success: "Success",
                    ocean: "Ocean",
                    dark: "Dark",
                    preview: "üëÅÔ∏è Vista Previa",
                    back: "‚Üê Volver a Editar",
                    download: "üíæ Descargar PNG (1080x1920)",
                    totalPayoutsShort: "üí∞ Total Payouts",
                    roi: "üìà ROI",
                    accountsFundedShort: "üéØ Cuentas Fondeadas",
                    invested: "üí∏ Total Invertido",
                    winRateP1: "‚úÖ Win Rate Phase 1",
                    winRateP2: "üî• Win Rate Phase 2",
                    fastest: "‚ö° Fondeo M√°s R√°pido",
                    avgTimeShort: "‚è±Ô∏è Tiempo Promedio Fondeo",
                    multiple: "üìä M√∫ltiplo de Capital",
                    bestFirm: "üèÜ Mejor Prop Firm"
                },
                alerts: {
                    fillFields: "‚ö†Ô∏è Completa todos los campos",
                    futureDate: "La fecha no puede ser futura",
                    positiveCost: "‚ö†Ô∏è El costo debe ser mayor a 0",
                    invalidSize: "‚ö†Ô∏è Tama√±o de cuenta no v√°lido",
                    duplicateAccount: "Este n√∫mero de cuenta ya existe para el a√±o",
                    challengeCreated: "Challenge creada exitosamente",
                    selectAccount: "‚ö†Ô∏è Selecciona una cuenta y fecha",
                    statusUpdated: "Estado actualizado",
                    positiveAmount: "‚ö†Ô∏è El monto debe ser mayor a 0",
                    payoutTooHigh: "supera 2x el tama√±o de la cuenta. Verifica el importe.",
                    payoutRegistered: "Payout registrado",
                    dataDeleted: "‚úÖ Todos los datos han sido eliminados",
                    typeReset: "‚ö†Ô∏è Escribe RESET para confirmar",
                    undoChallenge: "Challenge eliminada",
                    undoStatus: "Estado restaurado a",
                    undoPayout: "Payout eliminado",
                    downloaded: "‚úÖ Wrapped descargado como PNG"
                },
                undo: {
                    button: "‚Ü∂ Deshacer √∫ltima acci√≥n"
                }
            },
            en: {
                app: {
                    name: "NEVER QUIT",
                    fullName: "NEVER QUIT DASHBOARD",
                    tagline: "Professional Capital Management System"
                },
                login: {
                    subtitle: "Professional Management Dashboard",
                    username: "Username",
                    password: "Password",
                    usernamePlaceholder: "Enter your username",
                    passwordPlaceholder: "Enter your password",
                    submit: "Enter Dashboard",
                    error: "Incorrect username or password",
                    devMode: "üîß Dev Mode (Skip Login)"
                },
                modal: {
                    resetTitle: "‚ö†Ô∏è Confirm Reset",
                    resetConfirm: "Are you sure you want to delete all data? This action <strong>cannot be undone</strong>.",
                    resetItems: "Will be deleted:",
                    itemChallenges: "All challenges",
                    itemPayouts: "All payouts",
                    itemHistory: "All history",
                    typeReset: "Type RESET to confirm:",
                    cancel: "Cancel",
                    confirmDelete: "Yes, Delete Everything"
                },
                year: {
                    label: "ACTIVE YEAR:"
                },
                actions: {
                    resetData: "üîÑ Reset Data",
                    logout: "üö™ Logout"
                },
                tabs: {
                    control: "Control Center",
                    overview: "Overview",
                    performance: "Performance",
                    propfirm: "Prop Firm",
                    ceoview: "CEO View",
                    efficiency: "Capital Efficiency",
                    wrapped: "Wrapped"
                },
                forms: {
                    createTitle: "Create Challenge",
                    updateTitle: "Update Challenge",
                    payoutTitle: "Register Payout",
                    propFirm: "Prop Firm",
                    accountSize: "Account Size",
                    purchaseDate: "Purchase Date",
                    challengeCost: "Challenge Cost ($)",
                    accountNumber: "Account Number",
                    accountNumberPlaceholder: "Prop firm account number",
                    createButton: "Create Challenge",
                    account: "Account",
                    newStatus: "New Status",
                    statusDate: "Status Date",
                    updateButton: "Update Challenge",
                    amount: "Amount ($)",
                    payoutDate: "Payout Date",
                    status: "Status",
                    payoutButton: "Register Payout",
                    from: "from"
                },
                status: {
                    requested: "Requested",
                    approved: "Approved",
                    received: "Received",
                    phase1: "PHASE 1",
                    phase2: "PHASE 2",
                    funded: "FUNDED",
                    suspended: "SUSPENDED"
                },
                overview: {
                    title: "OVERVIEW",
                    updated: "Updated",
                    activeFundedCapital: "Active Funded Capital",
                    totalPayouts: "Total Payouts",
                    activeFundedAccounts: "Active Funded Accounts",
                    roiAnnual: "Annual ROI",
                    costs: "Costs",
                    accounts: "accounts",
                    payments: "payments",
                    ofTotal: "of total",
                    accountStatus: "‚óá ACCOUNT STATUS",
                    status: "Status",
                    count: "Count",
                    pctActive: "% Active",
                    totalActive: "Total active",
                    excluded: "suspended excluded",
                    excludedPlural: "suspended excluded",
                    noSuspended: "No suspended",
                    myAccounts: "‚óá MY ACCOUNTS",
                    account: "Account",
                    firm: "Prop Firm",
                    size: "Size",
                    cost: "Cost",
                    date: "Date",
                    received: "Payouts received",
                    noAccounts: "No active accounts"
                },
                performance: {
                    title: "PERFORMANCE",
                    noData: "No challenges for",
                    createFirst: "create one in Control Center",
                    phase1Success: "‚óá PHASE 1 SUCCESS RATE",
                    phase2Success: "PHASE 2 SUCCESS RATE",
                    avgCostFunded: "AVG. COST PER FUNDED ACCOUNT",
                    bestFirmRoi: "BEST PROP FIRM ROI",
                    totalCosts: "Total costs",
                    funded: "funded",
                    challengeSuccess: "‚óá CHALLENGE SUCCESS RATE",
                    approvalRate: "APPROVAL RATE",
                    totalChallenges: "Total Challenges",
                    inPhase1: "In Phase 1",
                    current: "current",
                    passedP1: "Passed P1",
                    inPhase2: "In Phase 2",
                    summary: "Summary",
                    passedPhase1: "pass Phase 1",
                    passedPhase2: "pass Phase 2",
                    fundedAccounts: "Funded Accounts",
                    roiByFirm: "‚óá ROI BY PROP FIRM",
                    of: "of"
                },
                propfirm: {
                    title: "PROP FIRM",
                    noAccounts: "No accounts from",
                    inYear: "in",
                    historical: "Historical Performance",
                    updated: "Updated",
                    challengesBought: "‚óá CHALLENGES BOUGHT",
                    accountsFunded: "FUNDED ACCOUNTS",
                    invested: "$ INVESTED",
                    payouts: "$ PAYOUTS",
                    roi: "ROI",
                    accountStatus: "‚óá ACCOUNT STATUS",
                    rules: "‚óá RULES OF",
                    phase1: "Phase 1",
                    phase2: "Phase 2",
                    maxDailyLoss: "Max Daily Loss",
                    maxLoss: "Max Loss",
                    profitSplit: "Profit Split",
                    minTradingDays: "Min Trading Days",
                    newsChallenge: "News Trading (Challenge)",
                    newsFunded: "News Trading (Funded)",
                    note: "Note",
                    closed: "CLOSED since 2023 - Reopening expected 2026"
                },
                ceoview: {
                    title: "CEO VIEW",
                    allTime: "ALL TIME",
                    mode: "Mode: PRO",
                    noHistory: "No history yet",
                    whenYouHave: "When you have challenges and payouts, you'll see your global evolution here",
                    totalPayouts: "‚óá TOTAL PAYOUTS",
                    totalInvested: "TOTAL INVESTED",
                    capitalMultiple: "CAPITAL MULTIPLE",
                    bestYear: "BEST YEAR",
                    yearlyEvolution: "‚óá YEARLY EVOLUTION",
                    progressMetrics: "‚óá PROGRESS METRICS (phase history)",
                    calculatedFrom: "Calculated from status change history",
                    avgAttempts: "AVG. ATTEMPTS TO FUNDING",
                    phasesPerAccount: "phases per funded account",
                    avgDaysPhase1: "AVG. DAYS IN PHASE 1",
                    untilPassP1: "until passing Phase 1",
                    avgDaysPhase2: "AVG. DAYS IN PHASE 2",
                    untilFunded: "until getting funded",
                    historyEntries: "HISTORY ENTRIES",
                    changesRecorded: "phase changes recorded",
                    recentPayouts: "‚óá RECENT PAYOUTS",
                    noPayouts: "No payouts registered",
                    date: "Date",
                    account: "Account",
                    firm: "Prop Firm",
                    amount: "Amount",
                    status: "Status"
                },
                efficiency: {
                    title: "CAPITAL EFFICIENCY",
                    noData: "No data ‚Äî create your first challenge",
                    withdrawnInvested: "$ WITHDRAWN / $ INVESTED",
                    avgTimeFunding: "AVG. TIME TO FUNDING",
                    selfFundedSystem: "SELF-FUNDED SYSTEM",
                    breakEven: "BREAK-EVEN TIMING",
                    projection: "projection based on current pace",
                    reached: "‚úÖ Reached",
                    pending: "Pending",
                    fundedInvested: "‚óá FUNDED / INVESTED",
                    selfFundingStatus: "‚óá SELF-FUNDING STATUS",
                    recoveryTrend: "‚óá ACCUMULATED RECOVERY TREND",
                    recoverySubtitle: "% of invested recovered via payouts ¬∑ Real month-by-month data",
                    noData2026: "No data for 2026",
                    createFirst: "Create your first challenge in Control Center to see your Wrapped",
                    selfFunding: "‚ôªÔ∏è SELF-FUNDED SYSTEM"
                },
                wrapped: {
                    title: "PROP FIRM WRAPPED",
                    subtitle: "YOUR TRADING YEAR IN REVIEW",
                    synced: "‚Üë synced with header year selector",
                    noData: "No data for",
                    createFirst: "Create your first challenge in Control Center to see your Wrapped",
                    totalPayouts: "TOTAL PAYOUTS",
                    avgRoi: "AVG ROI",
                    quickestFunding: "QUICKEST FUNDING",
                    days: "DAYS",
                    byFirm: "‚óá PAYOUTS BY PROP FIRM",
                    accountsFunded: "üå± FUNDED ACCOUNTS",
                    capitalMultiple: "üí∞ CAPITAL MULTIPLE",
                    selfFunded: "‚ôªÔ∏è SELF-FUNDED SYSTEM",
                    phase1Success: "% PHASE 1 SUCCESS RATE",
                    passedPhase1Of: "of challenges passed Phase 1",
                    phase2Success: "% PHASE 2 SUCCESS RATE",
                    converted: "You converted",
                    toFunded: "of Phase 2 attempts into funded accounts",
                    avgTime: "DAYS AVG TIME TO FUNDING",
                    avgFundedDays: "On average, you funded accounts in",
                    daysLower: "days",
                    completed: "COMPLETED",
                    successfullyFunded: "You successfully funded",
                    account: "account",
                    accounts: "accounts",
                    generatorTitle: "üé® GENERATE YOUR CUSTOM WRAPPED",
                    period: "‚è±Ô∏è Period",
                    monthly: "Monthly",
                    yearly: "Yearly",
                    metrics: "üìä Metrics to Include",
                    design: "üé® Design",
                    fire: "Fire",
                    success: "Success",
                    ocean: "Ocean",
                    dark: "Dark",
                    preview: "üëÅÔ∏è Preview",
                    back: "‚Üê Back to Edit",
                    download: "üíæ Download PNG (1080x1920)",
                    totalPayoutsShort: "üí∞ Total Payouts",
                    roi: "üìà ROI",
                    accountsFundedShort: "üéØ Funded Accounts",
                    invested: "üí∏ Total Invested",
                    winRateP1: "‚úÖ Win Rate Phase 1",
                    winRateP2: "üî• Win Rate Phase 2",
                    fastest: "‚ö° Fastest Funding",
                    avgTimeShort: "‚è±Ô∏è Avg Time to Funding",
                    multiple: "üìä Capital Multiple",
                    bestFirm: "üèÜ Best Prop Firm"
                },
                alerts: {
                    fillFields: "‚ö†Ô∏è Complete all fields",
                    futureDate: "Date cannot be in the future",
                    positiveCost: "‚ö†Ô∏è Cost must be greater than 0",
                    invalidSize: "‚ö†Ô∏è Invalid account size",
                    duplicateAccount: "This account number already exists for year",
                    challengeCreated: "Challenge successfully created",
                    selectAccount: "‚ö†Ô∏è Select an account and date",
                    statusUpdated: "Status updated",
                    positiveAmount: "‚ö†Ô∏è Amount must be greater than 0",
                    payoutTooHigh: "exceeds 2x account size. Verify the amount.",
                    payoutRegistered: "Payout registered",
                    dataDeleted: "‚úÖ All data has been deleted",
                    typeReset: "‚ö†Ô∏è Type RESET to confirm",
                    undoChallenge: "Challenge deleted",
                    undoStatus: "Status restored to",
                    undoPayout: "Payout deleted",
                    downloaded: "‚úÖ Wrapped downloaded as PNG"
                },
                undo: {
                    button: "‚Ü∂ Undo last action"
                }
            }
        };

        let currentLanguage = localStorage.getItem('neverQuitLanguage') || 'es';

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('neverQuitLanguage', lang);
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${lang}`).classList.add('active');
            
            document.documentElement.lang = lang;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const translation = getTranslation(key);
                if (translation) {
                    el.innerHTML = translation;
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const translation = getTranslation(key);
                if (translation) {
                    el.placeholder = translation;
                }
            });
            
            updateUI();
        }

        function getTranslation(key) {
            const keys = key.split('.');
            let value = i18n[currentLanguage];
            for (const k of keys) {
                if (value && value[k] !== undefined) {
                    value = value[k];
                } else {
                    return null;
                }
            }
            return value;
        }

        function t(key, replacements = {}) {
            let text = getTranslation(key) || key;
            Object.keys(replacements).forEach(placeholder => {
                text = text.replace(`{${placeholder}}`, replacements[placeholder]);
            });
            return text;
        }

        // ============================================
        // LOGIN SYSTEM
        // ============================================
        
        const VALID_CREDENTIALS = {
            'admin': 'admin123',
            'demo': 'demo123'
        };

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (VALID_CREDENTIALS[username] && VALID_CREDENTIALS[username] === password) {
                localStorage.setItem('neverQuitLoggedIn', 'true');
                localStorage.setItem('neverQuitUsername', username);
                
                document.getElementById('loginOverlay').classList.add('hidden');
                
                setTimeout(() => {
                    if (typeof initializeDashboard === 'function') {
                        initializeDashboard();
                    }
                }, 500);
                
            } else {
                errorDiv.classList.add('show');
                document.getElementById('loginPassword').value = '';
                
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 3000);
            }
        }

        function bypassLogin() {
            localStorage.setItem('neverQuitLoggedIn', 'true');
            localStorage.setItem('neverQuitUsername', 'dev-mode');
            
            document.getElementById('loginOverlay').classList.add('hidden');
            
            setTimeout(() => {
                if (typeof initializeDashboard === 'function') {
                    initializeDashboard();
                }
            }, 500);
        }

        function logout() {
            if (confirm(t('actions.logout') + '?')) {
                localStorage.removeItem('neverQuitLoggedIn');
                localStorage.removeItem('neverQuitUsername');
                location.reload();
            }
        }

        window.handleLogin = handleLogin;
        window.bypassLogin = bypassLogin;
        window.logout = logout;
        window.setLanguage = setLanguage;

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        
        let data = {
            master_comptes: [],
            payouts: [],
            examens: []
        };

        document.addEventListener('DOMContentLoaded', function() {
            setLanguage(currentLanguage);
            
            const isLoggedIn = localStorage.getItem('neverQuitLoggedIn') === 'true';
            
            if (isLoggedIn) {
                document.getElementById('loginOverlay').classList.add('hidden');
                setTimeout(() => {
                    initializeDashboard();
                }, 100);
            }

            const savedData = localStorage.getItem('superDashboardData');
            if (savedData) {
                data = JSON.parse(savedData);
            } else {
                // Sample data with DOLLARS
                data = {
                    master_comptes: [
                        { id: "FTM_1704067200000_123", accountNumber: "5012345", year: 2025, propFirm: "FTMO", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-15", challengeCost: 345, lastStatusDate: "2025-02-01", active: true },
                        { id: "FTM_1706745600000_456", accountNumber: "5023456", year: 2025, propFirm: "FTMO", accountSize: "100K", status: "PHASE 1", purchaseDate: "2025-02-01", challengeCost: 540, lastStatusDate: "2025-02-01", active: true },
                        { id: "FTM_1704585600000_234", accountNumber: "5015678", year: 2025, propFirm: "FTMO", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-10", challengeCost: 345, lastStatusDate: "2025-01-25", active: true },
                        { id: "FTM_1704412800000_890", accountNumber: "5009876", year: 2025, propFirm: "FTMO", accountSize: "50K", status: "SUSPENDED", purchaseDate: "2025-01-05", challengeCost: 345, lastStatusDate: "2025-01-20", active: false },
                        { id: "FTM_1710460800000_345", accountNumber: "5003421", year: 2024, propFirm: "FTMO", accountSize: "50K", status: "FUNDED", purchaseDate: "2024-03-15", challengeCost: 345, lastStatusDate: "2024-04-01", active: true },
                        { id: "MYF_1705881600000_789", accountNumber: "MFF-8392847", year: 2025, propFirm: "MyForexFunds", accountSize: "25K", status: "FUNDED", purchaseDate: "2025-01-20", challengeCost: 180, lastStatusDate: "2025-02-05", active: true },
                        { id: "MYF_1716163200000_678", accountNumber: "MFF-7182934", year: 2024, propFirm: "MyForexFunds", accountSize: "100K", status: "FUNDED", purchaseDate: "2024-05-20", challengeCost: 450, lastStatusDate: "2024-06-10", active: true },
                        { id: "MYF_1707264000000_991", accountNumber: "MFF-5647382", year: 2025, propFirm: "MyForexFunds", accountSize: "50K", status: "PHASE 2", purchaseDate: "2025-02-03", challengeCost: 299, lastStatusDate: "2025-02-10", active: true },
                        { id: "ACG_1706054400000_567", accountNumber: "ACG-1234567", year: 2025, propFirm: "Alpha Capital Group", accountSize: "100K", status: "PHASE 2", purchaseDate: "2025-01-22", challengeCost: 400, lastStatusDate: "2025-02-05", active: true },
                        { id: "ACG_1706832000000_442", accountNumber: "ACG-9876543", year: 2025, propFirm: "Alpha Capital Group", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-28", challengeCost: 320, lastStatusDate: "2025-02-11", active: true },
                        { id: "ORI_1705795200000_321", accountNumber: "ORF-9384756", year: 2025, propFirm: "Orion Funded", accountSize: "25K", status: "FUNDED", purchaseDate: "2025-01-18", challengeCost: 165, lastStatusDate: "2025-02-03", active: true },
                        { id: "FND_1707091200000_774", accountNumber: "FN-4729183", year: 2025, propFirm: "FundedNext", accountSize: "100K", status: "PHASE 1", purchaseDate: "2025-02-02", challengeCost: 499, lastStatusDate: "2025-02-02", active: true },
                        { id: "T5R_1706227200000_885", accountNumber: "T5-8273645", year: 2025, propFirm: "The5ers", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-24", challengeCost: 295, lastStatusDate: "2025-02-08", active: true }
                    ],
                    payouts: [
                        { id: "PAY001", accountId: "FTM_1704067200000_123", year: 2025, payoutDate: "2025-02-05", amount: 2500, status: "Recibido" },
                        { id: "PAY002", accountId: "FTM_1704585600000_234", year: 2025, payoutDate: "2025-02-08", amount: 3200, status: "Recibido" },
                        { id: "PAY003", accountId: "FTM_1704067200000_123", year: 2025, payoutDate: "2025-02-12", amount: 2800, status: "Aprobado" },
                        { id: "PAY004", accountId: "FTM_1710460800000_345", year: 2024, payoutDate: "2024-05-15", amount: 4200, status: "Recibido" },
                        { id: "PAY005", accountId: "MYF_1705881600000_789", year: 2025, payoutDate: "2025-02-10", amount: 1200, status: "Recibido" },
                        { id: "PAY006", accountId: "MYF_1716163200000_678", year: 2024, payoutDate: "2024-07-20", amount: 5000, status: "Recibido" },
                        { id: "PAY007", accountId: "ORI_1705795200000_321", year: 2025, payoutDate: "2025-02-09", amount: 950, status: "Recibido" },
                        { id: "PAY008", accountId: "ACG_1706832000000_442", year: 2025, payoutDate: "2025-02-13", amount: 2100, status: "Solicitado" },
                        { id: "PAY009", accountId: "T5R_1706227200000_885", year: 2025, payoutDate: "2025-02-11", amount: 1850, status: "Recibido" }
                    ],
                    examens: []
                };
                saveData();
            }

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                    
                    switch(tabName) {
                        case 'overview': renderOverview(); break;
                        case 'performance': renderPerformance(); break;
                        case 'propfirm': renderPropFirm(); break;
                        case 'ceoview': renderCEOView(); break;
                        case 'efficiency': renderCapitalEfficiency(); break;
                        case 'wrapped': renderWrapped(); break;
                    }
                });
            });

            document.getElementById('yearSelect').addEventListener('change', updateUI);

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('createPurchaseDate').value = today;
            document.getElementById('updateStatusDate').value = today;
            document.getElementById('payoutDate').value = today;

            const currentYear = new Date().getFullYear().toString();
            const yearSelectEl = document.getElementById('yearSelect');
            let foundYear = false;
            Array.from(yearSelectEl.options).forEach(opt => {
                if (opt.value === currentYear) { opt.selected = true; foundYear = true; }
                else { opt.selected = false; }
            });
            if (!foundYear) {
                const newOpt = document.createElement('option');
                newOpt.value = currentYear;
                newOpt.textContent = currentYear;
                newOpt.selected = true;
                yearSelectEl.appendChild(newOpt);
            }

            updateUI();

            // Swipe functionality
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            const minSwipeDistance = 50;
            const tabOrder = ['control', 'overview', 'performance', 'propfirm', 'ceoview', 'efficiency', 'wrapped'];

            function getCurrentTabIndex() {
                const activeTab = document.querySelector('.tab.active');
                const tabName = activeTab ? activeTab.getAttribute('data-tab') : 'control';
                return tabOrder.indexOf(tabName);
            }

            function switchToTab(index) {
                if (index < 0 || index >= tabOrder.length) return;
                const tabName = tabOrder[index];
                const tabButton = document.querySelector(`.tab[data-tab="${tabName}"]`);
                if (tabButton) {
                    tabButton.click();
                    tabButton.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }

            function handleSwipe() {
                const horizontalDiff = touchEndX - touchStartX;
                const verticalDiff = Math.abs(touchEndY - touchStartY);
                if (verticalDiff > 30) return;
                const currentIndex = getCurrentTabIndex();
                if (horizontalDiff > minSwipeDistance) {
                    switchToTab(currentIndex - 1);
                } else if (horizontalDiff < -minSwipeDistance) {
                    switchToTab(currentIndex + 1);
                }
            }

            const tabContents = document.querySelector('.container');
            
            tabContents.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            tabContents.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });

            let mouseStartX = 0;
            let isDragging = false;

            tabContents.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT') return;
                isDragging = true;
                mouseStartX = e.screenX;
            });

            tabContents.addEventListener('mouseup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                const horizontalDiff = e.screenX - mouseStartX;
                const currentIndex = getCurrentTabIndex();
                if (horizontalDiff > minSwipeDistance) {
                    switchToTab(currentIndex - 1);
                } else if (horizontalDiff < -minSwipeDistance) {
                    switchToTab(currentIndex + 1);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
                    const currentIndex = getCurrentTabIndex();
                    if (e.key === 'ArrowLeft') {
                        switchToTab(currentIndex - 1);
                    } else if (e.key === 'ArrowRight') {
                        switchToTab(currentIndex + 1);
                    }
                    e.preventDefault();
                }
            });
        });

        function saveData() {
            localStorage.setItem('superDashboardData', JSON.stringify(data));
        }

        let lastAction = null;
        let undoTimeout = null;

        function saveLastAction(type, actionData) {
            lastAction = {
                type: type,
                data: actionData,
                timestamp: Date.now()
            };
            showUndoButton();
        }

        function showUndoButton() {
            if (undoTimeout) clearTimeout(undoTimeout);
            
            const undoDiv = document.createElement('div');
            undoDiv.id = 'undoButton';
            undoDiv.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3498DB, #2980B9);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                z-index: 9998;
                animation: slideInRight 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            `;
            undoDiv.innerHTML = `<span style="font-size: 1.2rem;">‚Ü∂</span><span>${t('undo.button')}</span>`;
            undoDiv.onclick = undoLastAction;
            
            const existing = document.getElementById('undoButton');
            if (existing) existing.remove();
            
            document.body.appendChild(undoDiv);
            
            undoTimeout = setTimeout(() => {
                const btn = document.getElementById('undoButton');
                if (btn) {
                    btn.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => btn.remove(), 300);
                }
                lastAction = null;
            }, 8000);
        }

        function undoLastAction() {
            if (!lastAction) return;
            
            const action = lastAction;
            lastAction = null;
            
            const btn = document.getElementById('undoButton');
            if (btn) btn.remove();
            
            switch(action.type) {
                case 'CREATE_CHALLENGE':
                    const accountIndex = data.master_comptes.findIndex(a => a.id === action.data.id);
                    if (accountIndex !== -1) {
                        const account = data.master_comptes[accountIndex];
                        data.master_comptes.splice(accountIndex, 1);
                        saveData();
                        updateUI();
                        showAlert(`${t('alerts.undoChallenge')}: ${account.accountNumber || account.id}`, 'success');
                    }
                    break;
                    
                case 'UPDATE_CHALLENGE':
                    const updateAccount = data.master_comptes.find(a => a.id === action.data.accountId);
                    if (updateAccount) {
                        updateAccount.status = action.data.previousStatus;
                        updateAccount.lastStatusDate = action.data.previousDate;
                        updateAccount.active = action.data.previousActive;
                        
                        if (data.examens.length > 0) {
                            data.examens.pop();
                        }
                        
                        saveData();
                        updateUI();
                        showAlert(`${t('alerts.undoStatus')}: ${action.data.previousStatus}`, 'success');
                    }
                    break;
                    
                case 'REGISTER_PAYOUT':
                    const payoutIndex = data.payouts.findIndex(p => p.id === action.data.id);
                    if (payoutIndex !== -1) {
                        data.payouts.splice(payoutIndex, 1);
                        saveData();
                        updateUI();
                        showAlert(`${t('alerts.undoPayout')}: $${action.data.amount.toLocaleString()}`, 'success');
                    }
                    break;
            }
        }

        function openResetModal() {
            document.getElementById('resetModal').classList.add('active');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('active');
            const input = document.getElementById('resetConfirmInput');
            const btn = document.getElementById('confirmResetBtn');
            if (input) input.value = '';
            if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; }
        }

        function confirmReset() {
            const input = document.getElementById('resetConfirmInput');
            if (!input || input.value.toUpperCase() !== 'RESET') {
                showAlert(t('alerts.typeReset'), 'error');
                return;
            }

            localStorage.removeItem('superDashboardData');
            
            data = {
                master_comptes: [],
                payouts: [],
                examens: []
            };
            
            closeResetModal();
            updateUI();
            
            showAlert(t('alerts.dataDeleted'), 'success');
        }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = `<span>${message}</span>`;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.add('hiding');
                setTimeout(() => {
                    if (alertContainer.contains(alertDiv)) {
                        alertContainer.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }

        function createChallenge() {
            const propFirm = document.getElementById('createPropFirm').value;
            const accountSize = document.getElementById('createAccountSize').value;
            const purchaseDate = document.getElementById('createPurchaseDate').value;
            const challengeCost = parseFloat(document.getElementById('createChallengeCost').value);
            const accountNumber = document.getElementById('createAccountNumber').value.trim();

            if (!purchaseDate || !challengeCost || !accountNumber) {
                showAlert(t('alerts.fillFields'), 'error');
                return;
            }

            if (new Date(purchaseDate) > new Date()) {
                showAlert(t('alerts.futureDate'), 'error');
                return;
            }

            if (challengeCost <= 0) {
                showAlert(t('alerts.positiveCost'), 'error');
                return;
            }

            const validSizes = ['10K', '25K', '50K', '100K', '200K'];
            if (!validSizes.includes(accountSize)) {
                showAlert(t('alerts.invalidSize'), 'error');
                return;
            }

            const year = new Date(purchaseDate).getFullYear();

            if (data.master_comptes.find(a => a.accountNumber === accountNumber && a.year === year)) {
                showAlert(`${t('alerts.duplicateAccount')} ${year}`, 'error');
                return;
            }

            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            const firmPrefix = propFirm.substring(0, 3).toUpperCase().replace(/\s/g, '');
            const internalId = `${firmPrefix}_${timestamp}_${random}`;

            const newAccount = {
                id: internalId,
                accountNumber: accountNumber,
                year: year,
                propFirm: propFirm,
                accountSize: accountSize,
                status: 'PHASE 1',
                purchaseDate: purchaseDate,
                challengeCost: challengeCost,
                lastStatusDate: purchaseDate,
                active: true
            };

            data.master_comptes.push(newAccount);
            saveData();
            
            saveLastAction('CREATE_CHALLENGE', {
                id: internalId,
                accountNumber: accountNumber
            });
            
            showAlert(`${t('alerts.challengeCreated')}: ${accountNumber} (${propFirm} - ${accountSize})`, 'success');
            
            document.getElementById('createChallengeCost').value = '';
            document.getElementById('createAccountNumber').value = '';
            
            updateUI();
        }

        function updateChallenge() {
            const accountId = document.getElementById('updateAccountId').value;
            const newStatus = document.getElementById('updateNewStatus').value;
            const statusDate = document.getElementById('updateStatusDate').value;

            if (!accountId || !statusDate) {
                showAlert(t('alerts.selectAccount'), 'error');
                return;
            }

            if (new Date(statusDate) > new Date()) {
                showAlert(t('alerts.futureDate'), 'error');
                return;
            }

            const account = data.master_comptes.find(a => a.id === accountId);
            if (account) {
                const previousStatus = account.status;
                const previousDate = account.lastStatusDate;
                const previousActive = account.active;
                
                account.status = newStatus;
                account.lastStatusDate = statusDate;
                account.active = newStatus !== 'SUSPENDED';
                
                data.examens.push({
                    id: `EX${data.examens.length + 1}`,
                    accountId: accountId,
                    phase: newStatus,
                    statusDate: statusDate
                });
                
                saveData();
                
                saveLastAction('UPDATE_CHALLENGE', {
                    accountId: accountId,
                    previousStatus: previousStatus,
                    previousDate: previousDate,
                    previousActive: previousActive,
                    newStatus: newStatus
                });
                
                const displayNumber = account.accountNumber || account.id;
                showAlert(`${t('alerts.statusUpdated')}: ${displayNumber} ‚Üí ${newStatus}`, 'success');
                updateUI();
            }
        }

        function registerPayout() {
            const accountId = document.getElementById('payoutAccountId').value;
            const amount = parseFloat(document.getElementById('payoutAmount').value);
            const payoutDate = document.getElementById('payoutDate').value;
            const status = document.getElementById('payoutStatus').value;

            if (!accountId || !amount || !payoutDate || !status) {
                showAlert(t('alerts.fillFields'), 'error');
                return;
            }

            if (new Date(payoutDate) > new Date()) {
                showAlert(t('alerts.futureDate'), 'error');
                return;
            }

            if (amount <= 0) {
                showAlert(t('alerts.positiveAmount'), 'error');
                return;
            }

            const account = data.master_comptes.find(a => a.id === accountId);
            if (account) {
                const accountSizeNum = parseInt(account.accountSize.replace('K', '')) * 1000;
                if (amount > accountSizeNum * 2) {
                    showAlert(`‚ö†Ô∏è ${t('alerts.payoutTooHigh')}`, 'error');
                    return;
                }
            }

            const year = new Date(payoutDate).getFullYear();
            const newPayout = {
                id: `PAY${Date.now()}`,
                accountId: accountId,
                year: year,
                payoutDate: payoutDate,
                amount: amount,
                status: status
            };

            data.payouts.push(newPayout);
            saveData();
            
            saveLastAction('REGISTER_PAYOUT', {
                id: newPayout.id,
                amount: amount,
                accountId: accountId
            });
            
            const accountDisplay = account ? (account.accountNumber || account.id) : accountId;
            showAlert(`${t('alerts.payoutRegistered')}: $${amount.toLocaleString()} ${t('forms.from')} ${accountDisplay}`, 'success');
            
            document.getElementById('payoutAmount').value = '';
            updateUI();
        }

        function calculateDaysToFunding(account) {
            const startDate = new Date(account.purchaseDate);
            const fundedDate = new Date(account.lastStatusDate);
            const diffTime = Math.abs(fundedDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        const PROP_FIRMS_CONFIG = {
            'FTMO': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80-90%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Restricci√≥n 2min antes/despu√©s (Standard)',
                note_funded: 'Sin restricci√≥n en Swing Account',
                minTradingDays: 4
            },
            'Alpha Capital Group': {
                profitTarget_P1: 8,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Trades 2min antes/despu√©s deben durar +2min',
                minTradingDays: 3
            },
            'The5ers': {
                profitTarget_P1: 8,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80-100%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Permitido sin restricciones',
                note_funded: 'Escalado progresivo hasta 100% profit split'
            },
            'FundedNext': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80-95%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Permitido sin restricciones',
                minTradingDays: 0
            },
            'Orion Funded': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Consultar reglas espec√≠ficas',
                minTradingDays: 3
            },
            'Bullfy': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Consultar reglas espec√≠ficas',
                minTradingDays: 3
            },
            'MyForexFunds': {
                profitTarget_P1: 8,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 12,
                split: '75-85%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Firma temporalmente cerrada',
                note: '‚ö†Ô∏è CERRADA desde 2023 - Reapertura esperada 2026',
                minTradingDays: 3
            }
        };

        function renderOverview() {
            const activeYear = parseInt(document.getElementById('yearSelect').value);
            const yearAccounts = data.master_comptes.filter(a => a.year === activeYear);
            const yearPayouts = data.payouts.filter(p => p.year === activeYear);

            const activeFunded = yearAccounts.filter(a => a.status === 'FUNDED' && a.active).length;
            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalCosts = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const roi = (totalCosts > 0 && totalPayouts > 0) ? ((totalPayouts - totalCosts) / totalCosts * 100) : 0;

            const activeFundedCapital = yearAccounts
                .filter(a => a.status === 'FUNDED' && a.active)
                .reduce((sum, a) => {
                    const sizeNum = parseInt(a.accountSize.replace('K', '')) * 1000;
                    return sum + sizeNum;
                }, 0);

            const activeAccountsOnly = yearAccounts.filter(a => a.active);
            const suspendedCount = yearAccounts.filter(a => a.status === 'SUSPENDED').length;
            const statusCounts = {
                'FUNDED': activeAccountsOnly.filter(a => a.status === 'FUNDED').length,
                'PHASE 1': activeAccountsOnly.filter(a => a.status === 'PHASE 1').length,
                'PHASE 2': activeAccountsOnly.filter(a => a.status === 'PHASE 2').length
            };

            const overviewHtml = `
                <div class="dashboard-header">
                    <h2>${t('overview.title')} ¬∑ ${activeYear}</h2>
                    <div class="subtitle">${t('overview.updated')} ${new Date().toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { month: 'short', year: 'numeric' })}</div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">${t('overview.activeFundedCapital')}</div>
                        <div class="kpi-value success">$${(activeFundedCapital).toLocaleString()}</div>
                        <div class="kpi-subtitle">${activeFunded} ${t('overview.accounts')}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('overview.totalPayouts')}</div>
                        <div class="kpi-value success">$${totalPayouts.toLocaleString()}</div>
                        <div class="kpi-subtitle">${yearPayouts.length} ${t('overview.payments')}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('overview.activeFundedAccounts')}</div>
                        <div class="kpi-value">${activeFunded}</div>
                        <div class="kpi-subtitle">${t('overview.ofTotal')} ${yearAccounts.length}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('overview.roiAnnual')}</div>
                        <div class="kpi-value ${roi > 0 ? 'success' : roi < 0 ? 'danger' : ''}">${roi > 0 ? '+' : ''}${roi.toFixed(0)}%</div>
                        <div class="kpi-subtitle">${t('overview.costs')}: $${totalCosts.toLocaleString()}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">${t('overview.accountStatus')}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('overview.status')}</th>
                                    <th>${t('overview.count')}</th>
                                    <th>${t('overview.pctActive')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="status-badge funded">FUNDED</span></td>
                                    <td>${statusCounts.FUNDED}</td>
                                    <td>${activeAccountsOnly.length > 0 ? ((statusCounts.FUNDED / activeAccountsOnly.length) * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr>
                                    <td><span class="status-badge phase1">PHASE 1</span></td>
                                    <td>${statusCounts['PHASE 1']}</td>
                                    <td>${activeAccountsOnly.length > 0 ? ((statusCounts['PHASE 1'] / activeAccountsOnly.length) * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr>
                                    <td><span class="status-badge phase2">PHASE 2</span></td>
                                    <td>${statusCounts['PHASE 2']}</td>
                                    <td>${activeAccountsOnly.length > 0 ? ((statusCounts['PHASE 2'] / activeAccountsOnly.length) * 100).toFixed(1) : 0}%</td>
                                </tr>
                                ${suspendedCount > 0 ? `
                                <tr style="opacity: 0.5;">
                                    <td><span class="status-badge suspended">SUSPENDED</span></td>
                                    <td>${suspendedCount}</td>
                                    <td style="color: #9AA0A6; font-style: italic;">closed</td>
                                </tr>` : ''}
                            </tbody>
                        </table>
                        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #9AA0A6;">
                            ${t('overview.totalActive')}: ${activeAccountsOnly.length} ¬∑ ${suspendedCount > 0 ? `${suspendedCount} ${suspendedCount > 1 ? t('overview.excludedPlural') : t('overview.excluded')}` : t('overview.noSuspended')}
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">Active Accounts</h3>
                        <div class="chart-container">
                            <canvas id="activeAccountsChart"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 1rem; color: #9AA0A6; font-size: 0.85rem;">
                            Total Active: ${activeAccountsOnly.length}
                        </div>
                    </div>
                </div>
            `;

            let accountsTableHtml = '';
            if (yearAccounts.length > 0) {
                const rows = yearAccounts
                    .sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate))
                    .map(acc => {
                        const statusClass = acc.status === 'FUNDED' ? 'funded'
                            : acc.status === 'PHASE 1' ? 'phase1'
                            : acc.status === 'PHASE 2' ? 'phase2' : 'suspended';
                        const payoutsForAcc = data.payouts
                            .filter(p => p.accountId === acc.id)
                            .reduce((s, p) => s + p.amount, 0);
                        const rowStyle = !acc.active ? 'opacity:0.5;' : '';
                        let row = '<tr style="' + rowStyle + '">'
                            + '<td style="font-weight:700;">' + acc.accountNumber + '</td>'
                            + '<td>' + acc.propFirm + '</td>'
                            + '<td style="font-weight:600;">' + acc.accountSize + '</td>'
                            + '<td><span class="status-badge ' + statusClass + '">' + acc.status + '</span></td>'
                            + '<td style="color:#E74C3C;">-$' + acc.challengeCost.toLocaleString() + '</td>'
                            + '<td style="color:#9AA0A6;">' + new Date(acc.purchaseDate).toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US') + '</td>'
                            + '</tr>';
                        if (payoutsForAcc > 0) {
                            row += '<tr style="background:rgba(46,204,113,0.03);' + rowStyle + '">'
                                + '<td colspan="4" style="padding-top:0.3rem;padding-bottom:0.5rem;color:#9AA0A6;font-size:0.8rem;padding-left:2.5rem;">‚Ü≥ ' + t('overview.received') + '</td>'
                                + '<td style="color:#2ECC71;padding-top:0.3rem;padding-bottom:0.5rem;">+$' + payoutsForAcc.toLocaleString() + '</td>'
                                + '<td></td></tr>';
                        }
                        return row;
                    }).join('');

                accountsTableHtml = '<div class="table-container" style="margin-top:1.5rem;">'
                    + '<h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:700;">' + t('overview.myAccounts') + ' ¬∑ ' + activeYear + '</h3>'
                    + '<table><thead><tr>'
                    + '<th>' + t('overview.account') + '</th><th>' + t('overview.firm') + '</th><th>' + t('overview.size') + '</th><th>Status</th><th>' + t('overview.cost') + '</th><th>' + t('overview.date') + '</th>'
                    + '</tr></thead><tbody>' + rows + '</tbody></table></div>';
            }

            document.getElementById('overview').innerHTML = overviewHtml + accountsTableHtml;

            const ctx = document.getElementById('activeAccountsChart');
            if (ctx && activeAccountsOnly.length === 0) {
                ctx.closest('.table-container').querySelector('.chart-container').innerHTML =
                    '<div style="text-align:center;padding:2rem;color:#9AA0A6;"><div style="font-size:2rem;margin-bottom:0.5rem;">üìã</div><div>' + t('overview.noAccounts') + '</div></div>';
            } else if (ctx && activeAccountsOnly.length > 0) {
                if (window.activeChart && typeof window.activeChart.destroy === 'function') {
                    window.activeChart.destroy();
                }

                window.activeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['FUNDED', 'PHASE 1', 'PHASE 2'],
                        datasets: [{
                            data: [
                                statusCounts.FUNDED,
                                statusCounts['PHASE 1'],
                                statusCounts['PHASE 2']
                            ],
                            backgroundColor: ['#2ECC71', '#3498DB', '#F39C12'],
                            borderColor: '#121417',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#E6E8EB',
                                    font: { family: 'Inter', size: 12, weight: '600' },
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderPerformance() {
            const activeYear = parseInt(document.getElementById('yearSelect').value);
            const yearAccounts = data.master_comptes.filter(a => a.year === activeYear);
            const yearPayouts = data.payouts.filter(p => p.year === activeYear);
            
            const totalChallenges = yearAccounts.length;
            const phase1CurrentCount = yearAccounts.filter(a => a.status === 'PHASE 1').length;
            const phase2CurrentCount = yearAccounts.filter(a => a.status === 'PHASE 2').length;
            const fundedCount = yearAccounts.filter(a => a.status === 'FUNDED').length;
            
            const passedPhase1 = phase2CurrentCount + fundedCount;
            const phase1WinRate = totalChallenges > 0 ? (passedPhase1 / totalChallenges * 100) : 0;
            
            const reachedPhase2 = phase2CurrentCount + fundedCount;
            const phase2WinRate = reachedPhase2 > 0 ? (fundedCount / reachedPhase2 * 100) : 0;
            
            const totalCosts = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const avgCostPerFunded = fundedCount > 0 ? totalCosts / fundedCount : 0;
            const performanceRoi = (totalCosts > 0 && totalPayouts > 0) ? ((totalPayouts - totalCosts) / totalCosts * 100) : 0;
            
            const propFirms = ['FTMO', 'Alpha Capital Group', 'Orion Funded', 'Bullfy', 'FundedNext', 'The5ers', 'MyForexFunds'];
            const roiByFirm = propFirms.map(firm => {
                const firmAccounts = yearAccounts.filter(a => a.propFirm === firm);
                const firmCosts = firmAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
                const firmAccountIds = firmAccounts.map(a => a.id);
                const firmPayouts = yearPayouts.filter(p => firmAccountIds.includes(p.accountId))
                    .reduce((sum, p) => sum + p.amount, 0);
                const roi = firmCosts > 0 ? ((firmPayouts - firmCosts) / firmCosts * 100) : 0;
                return { firm, roi, payouts: firmPayouts, costs: firmCosts };
            }).filter(f => f.costs > 0).sort((a, b) => b.roi - a.roi);

            const bestFirm = roiByFirm[0] || { firm: 'N/A', roi: 0 };

            const performanceHtml = `
                <div class="dashboard-header">
                    <h2>${t('performance.title')} ¬∑ ${activeYear}</h2>
                    ${totalChallenges === 0 ? `<div style="text-align:center;padding:0.5rem;color:#F39C12;font-size:0.85rem;">${t('performance.noData')} ${activeYear} ‚Äî ${t('performance.createFirst')}</div>` : ''}
                    <div class="subtitle">${t('overview.updated')} ${new Date().toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { month: 'short', year: 'numeric' })}</div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">${t('performance.phase1Success')}</div>
                        <div class="kpi-value success">${phase1WinRate.toFixed(0)}%</div>
                        <div class="kpi-subtitle">${passedPhase1} ${t('performance.of')} ${totalChallenges}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('performance.phase2Success')}</div>
                        <div class="kpi-value success">${phase2WinRate.toFixed(0)}%</div>
                        <div class="kpi-subtitle">${fundedCount} ${t('performance.funded')}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('performance.avgCostFunded')}</div>
                        <div class="kpi-value">$${avgCostPerFunded.toFixed(0)}</div>
                        <div class="kpi-subtitle">${t('performance.totalCosts')}: $${totalCosts.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('performance.bestFirmRoi')}</div>
                        <div class="kpi-value success">${bestFirm.firm}</div>
                        <div class="kpi-subtitle">+${bestFirm.roi.toFixed(0)}%</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('performance.challengeSuccess')}</h3>
                        
                        <div class="bar-chart">
                            <div class="bar-row">
                                <div class="bar-label">PHASE 1</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${phase1WinRate}%; background: linear-gradient(90deg, #F39C12, #E67E22);">
                                        ${phase1WinRate > 15 ? '<span class="bar-value">' + phase1WinRate.toFixed(0) + '%</span>' : ''}
                                    </div>
                                </div>
                                <div class="bar-count">${phase1WinRate.toFixed(0)}%</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">PHASE 2</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${phase2WinRate}%; background: linear-gradient(90deg, #2ECC71, #27AE60);">
                                        ${phase2WinRate > 15 ? '<span class="bar-value">' + phase2WinRate.toFixed(0) + '%</span>' : ''}
                                    </div>
                                </div>
                                <div class="bar-count">${phase2WinRate.toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('performance.approvalRate')}</h3>
                        
                        <div style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 1rem;">
                                <div class="kpi-value success" style="font-size: 3rem;">${totalChallenges}</div>
                                <div style="color: #9AA0A6; margin-top: 0.5rem;">${t('performance.totalChallenges')}</div>
                            </div>
                            
                            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1.5rem 0;">
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">${t('performance.inPhase1')}</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700;">${phase1CurrentCount}</div>
                                    <div style="color: #9AA0A6; font-size: 0.75rem;">${t('performance.current')}</div>
                                </div>
                                
                                <div style="color: #2ECC71; font-size: 1.5rem;">‚Üí</div>
                                
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">${t('performance.passedP1')}</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700; color: #F39C12;">${passedPhase1}</div>
                                    <div style="color: #F39C12; font-size: 0.75rem;">${phase1WinRate.toFixed(0)}%</div>
                                </div>
                                
                                <div style="color: #2ECC71; font-size: 1.5rem;">‚Üí</div>
                                
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">${t('performance.inPhase2')}</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700;">${phase2CurrentCount}</div>
                                    <div style="color: #9AA0A6; font-size: 0.75rem;">${t('performance.current')}</div>
                                </div>
                                
                                <div style="color: #2ECC71; font-size: 1.5rem;">‚Üí</div>
                                
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">FUNDED</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700; color: #2ECC71;">${fundedCount}</div>
                                    <div style="color: #2ECC71; font-size: 0.75rem;">${phase2WinRate.toFixed(0)}%</div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(230, 232, 235, 0.1);">
                                <div style="color: #9AA0A6; font-size: 0.85rem; margin-bottom: 0.5rem;">${t('performance.summary')}:</div>
                                <div style="color: #9AA0A6; font-size: 0.8rem;">
                                    ${phase1WinRate.toFixed(0)}% ${t('performance.passedPhase1')} ¬∑ ${phase2WinRate.toFixed(0)}% ${t('performance.passedPhase2')} ¬∑ ${fundedCount} ${t('performance.fundedAccounts')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('performance.roiByFirm')}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div class="chart-container" style="max-width: none;">
                            <canvas id="roiLineChart"></canvas>
                        </div>
                        <div class="chart-container" style="max-width: none;">
                            <canvas id="roiBarChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('performance').innerHTML = performanceHtml;

            const lineCtx = document.getElementById('roiLineChart');
            if (lineCtx && roiByFirm.length > 0) {
                if (window.roiLineChart && typeof window.roiLineChart.destroy === 'function') {
                    window.roiLineChart.destroy();
                }

                window.roiLineChart = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: roiByFirm.map(f => f.firm),
                        datasets: [{
                            label: 'ROI %',
                            data: roiByFirm.map(f => f.roi),
                            borderColor: '#2ECC71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#2ECC71',
                            pointBorderColor: '#121417',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                titleColor: '#E6E8EB',
                                bodyColor: '#E6E8EB',
                                callbacks: {
                                    label: (context) => `+${context.parsed.y.toFixed(0)}%`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => value + '%'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            const barCtx = document.getElementById('roiBarChart');
            if (barCtx && roiByFirm.length > 0) {
                if (window.roiBarChart && typeof window.roiBarChart.destroy === 'function') {
                    window.roiBarChart.destroy();
                }

                window.roiBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: roiByFirm.map(f => f.firm),
                        datasets: [{
                            data: roiByFirm.map(f => f.roi),
                            backgroundColor: ['#2ECC71', '#9AA0A6', '#F39C12'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (context) => `+${context.parsed.y.toFixed(0)}%`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => value + '%'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function renderPropFirm() {
            const activeYear = parseInt(document.getElementById('yearSelect').value);
            const firmSelector = document.getElementById('firmSelector');
            const selectedFirm = firmSelector ? firmSelector.value : 'FTMO';
            
            const firmConfig = PROP_FIRMS_CONFIG[selectedFirm] || PROP_FIRMS_CONFIG['FTMO'];
            
            const yearAccounts = data.master_comptes.filter(a => a.year === activeYear && a.propFirm === selectedFirm);
            const yearPayouts = data.payouts.filter(p => {
                const account = data.master_comptes.find(a => a.id === p.accountId);
                return p.year === activeYear && account && account.propFirm === selectedFirm;
            });

            const totalInvested = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const challengesBought = yearAccounts.length;
            const cuentasFunded = yearAccounts.filter(a => a.status === 'FUNDED').length;
            const roi = totalInvested > 0 ? ((totalPayouts - totalInvested) / totalInvested * 100) : 0;

            const statusCounts = {
                'FUNDED': yearAccounts.filter(a => a.status === 'FUNDED').length,
                'PHASE 1': yearAccounts.filter(a => a.status === 'PHASE 1').length,
                'PHASE 2': yearAccounts.filter(a => a.status === 'PHASE 2').length,
                'SUSPENDED': yearAccounts.filter(a => a.status === 'SUSPENDED').length
            };

            const propFirmHtml = `
                <div class="dashboard-header">
                    <h2>${t('propfirm.title')} ¬∑ ${selectedFirm}</h2>
                    ${yearAccounts.length === 0 ? `<div style="display:inline-block;padding:0.25rem 0.75rem;background:rgba(243,156,18,0.1);border-radius:6px;color:#F39C12;font-size:0.8rem;margin-top:0.5rem;">${t('propfirm.noAccounts')} ${selectedFirm} ${t('propfirm.inYear')} ${activeYear}</div>` : ''}
                    <div class="subtitle">${t('propfirm.historical')} ¬∑ ${t('propfirm.updated')} ${new Date().toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { month: 'short', year: 'numeric' })}</div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <select id="firmSelector" style="padding: 0.75rem 1.5rem; background: #181B20; border: 1px solid rgba(230, 232, 235, 0.1); border-radius: 8px; color: #E6E8EB; font-size: 0.95rem; font-weight: 600;">
                        <option value="FTMO" ${selectedFirm === 'FTMO' ? 'selected' : ''}>FTMO</option>
                        <option value="Alpha Capital Group" ${selectedFirm === 'Alpha Capital Group' ? 'selected' : ''}>Alpha Capital Group</option>
                        <option value="Orion Funded" ${selectedFirm === 'Orion Funded' ? 'selected' : ''}>Orion Funded</option>
                        <option value="Bullfy" ${selectedFirm === 'Bullfy' ? 'selected' : ''}>Bullfy</option>
                        <option value="FundedNext" ${selectedFirm === 'FundedNext' ? 'selected' : ''}>FundedNext</option>
                        <option value="The5ers" ${selectedFirm === 'The5ers' ? 'selected' : ''}>The5ers</option>
                        <option value="MyForexFunds" ${selectedFirm === 'MyForexFunds' ? 'selected' : ''}>MyForexFunds</option>
                    </select>
                    <span style="margin-left: 2rem; color: #9AA0A6; font-size: 0.8rem;">P1: ${firmConfig.profitTarget_P1}% target ¬∑ Max loss: ${firmConfig.maxLoss}%</span>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">${t('propfirm.challengesBought')}</div>
                        <div class="kpi-value">${challengesBought}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('propfirm.accountsFunded')}</div>
                        <div class="kpi-value success">${cuentasFunded}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('propfirm.invested')}</div>
                        <div class="kpi-value">$${totalInvested.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('propfirm.payouts')}</div>
                        <div class="kpi-value success">$${totalPayouts.toLocaleString()}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('propfirm.accountStatus')}</h3>
                        
                        <div class="bar-chart">
                            <div class="bar-row">
                                <div class="bar-label">FUNDED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${challengesBought > 0 ? (statusCounts.FUNDED / challengesBought * 100) : 0}%; background: linear-gradient(90deg, #2ECC71, #27AE60);"></div>
                                </div>
                                <div class="bar-count">${statusCounts.FUNDED}</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">PHASE 1</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${challengesBought > 0 ? (statusCounts['PHASE 1'] / challengesBought * 100) : 0}%; background: linear-gradient(90deg, #F39C12, #E67E22);"></div>
                                </div>
                                <div class="bar-count">${statusCounts['PHASE 1']}</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">SUSPENDED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${challengesBought > 0 ? (statusCounts.SUSPENDED / challengesBought * 100) : 0}%; background: linear-gradient(90deg, #9AA0A6, #7F8C8D);"></div>
                                </div>
                                <div class="bar-count">${statusCounts.SUSPENDED}</div>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">${t('propfirm.roi')}</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value success" style="font-size: 3.5rem;">+${roi.toFixed(0)}%</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">${t('propfirm.rules')} ${selectedFirm.toUpperCase()}</h3>
                    <ul style="list-style: none; padding: 0; color: #9AA0A6; line-height: 2;">
                        <li>‚Ä¢ <strong>${t('propfirm.phase1')}:</strong> ${firmConfig.profitTarget_P1}% profit target</li>
                        <li>‚Ä¢ <strong>${t('propfirm.phase2')}:</strong> ${firmConfig.profitTarget_P2}% profit target</li>
                        <li>‚Ä¢ <strong>${t('propfirm.maxDailyLoss')}:</strong> ${firmConfig.maxDailyLoss}%</li>
                        <li>‚Ä¢ <strong>${t('propfirm.maxLoss')}:</strong> ${firmConfig.maxLoss}%</li>
                        <li>‚Ä¢ <strong>${t('propfirm.profitSplit')}:</strong> ${firmConfig.split}</li>
                        ${firmConfig.minTradingDays ? `<li>‚Ä¢ <strong>${t('propfirm.minTradingDays')}:</strong> ${firmConfig.minTradingDays}</li>` : ''}
                        <li style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(230,232,235,0.1);">
                            <strong>üì∞ ${t('propfirm.newsChallenge')}:</strong><br/>
                            <span style="font-size: 0.9rem;">${firmConfig.newsTrading_Challenge}</span>
                        </li>
                        <li style="margin-top: 0.5rem;">
                            <strong>üì∞ ${t('propfirm.newsFunded')}:</strong><br/>
                            <span style="font-size: 0.9rem;">${firmConfig.newsTrading_Funded}</span>
                        </li>
                        ${firmConfig.note ? 
                            `<li style="margin-top: 0.75rem; font-size: 0.85rem; color: #F39C12; padding: 0.5rem; background: rgba(243,156,18,0.1); border-radius: 6px;">
                                ${t('propfirm.closed')}
                            </li>` : ''}
                        ${firmConfig.note_funded && !firmConfig.note ? 
                            `<li style="margin-top: 0.75rem; font-size: 0.85rem; color: #2ECC71;">
                                <strong>üí° ${t('propfirm.note')}:</strong> ${firmConfig.note_funded}
                            </li>` : ''}
                    </ul>
                </div>
            `;

            document.getElementById('propfirm').innerHTML = propFirmHtml;

            setTimeout(() => {
                const newSelector = document.getElementById('firmSelector');
                if (newSelector) {
                    newSelector.addEventListener('change', renderPropFirm);
                }
            }, 0);
        }

        function renderCEOView() {
            const allAccounts = data.master_comptes;
            const allPayouts = data.payouts;

            const totalPayouts = allPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalInvested = allAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const capitalMultiple = totalInvested > 0 ? totalPayouts / totalInvested : 0;

            const years = [...new Set(allAccounts.map(a => a.year))].sort();
            const yearlyPayouts = years.map(year => {
                return allPayouts.filter(p => p.year === year).reduce((sum, p) => sum + p.amount, 0);
            });

            const bestYear = years[yearlyPayouts.indexOf(Math.max(...yearlyPayouts))] || 'N/A';

            const fundedAccountsAll = allAccounts.filter(a => a.status === 'FUNDED');
            let avgAttemptsToFund = 0;
            if (fundedAccountsAll.length > 0 && data.examens.length > 0) {
                const attemptsPerAccount = fundedAccountsAll.map(acc => {
                    return data.examens.filter(e => e.accountId === acc.id).length || 1;
                });
                avgAttemptsToFund = attemptsPerAccount.reduce((s, v) => s + v, 0) / fundedAccountsAll.length;
            }

            let avgDaysPhase1 = 0;
            let avgDaysPhase2 = 0;
            if (data.examens.length > 0) {
                const phase2Events = data.examens.filter(e => e.phase === 'PHASE 2');
                const fundedEvents = data.examens.filter(e => e.phase === 'FUNDED');

                const p1Durations = [];
                phase2Events.forEach(ev2 => {
                    const account = allAccounts.find(a => a.id === ev2.accountId);
                    if (account && account.purchaseDate) {
                        const days = Math.round((new Date(ev2.statusDate) - new Date(account.purchaseDate)) / 86400000);
                        if (days > 0 && days < 365) p1Durations.push(days);
                    }
                });
                if (p1Durations.length > 0) avgDaysPhase1 = p1Durations.reduce((s, v) => s + v, 0) / p1Durations.length;

                const p2Durations = [];
                fundedEvents.forEach(evF => {
                    const lastP2 = [...data.examens]
                        .filter(e => e.accountId === evF.accountId && e.phase === 'PHASE 2')
                        .sort((a, b) => new Date(b.statusDate) - new Date(a.statusDate))[0];
                    if (lastP2) {
                        const days = Math.round((new Date(evF.statusDate) - new Date(lastP2.statusDate)) / 86400000);
                        if (days > 0 && days < 365) p2Durations.push(days);
                    }
                });
                if (p2Durations.length > 0) avgDaysPhase2 = p2Durations.reduce((s, v) => s + v, 0) / p2Durations.length;
            }

            const hasExamenData = data.examens.length > 0;

            const ceoViewHtml = `
                <div class="dashboard-header">
                    <h2>${t('ceoview.title')} ¬∑ ${t('ceoview.allTime')}</h2>
                    <div class="subtitle">${t('ceoview.mode')}</div>
                </div>
                ${allAccounts.length === 0 ? `
                <div style="text-align:center;padding:3rem;color:#9AA0A6;border:1px dashed rgba(230,232,235,0.15);border-radius:12px;margin-bottom:2rem;">
                    <div style="font-size:3rem;margin-bottom:1rem;">üìà</div>
                    <div style="font-size:1.1rem;font-weight:600;margin-bottom:0.5rem;">${t('ceoview.noHistory')}</div>
                    <div style="font-size:0.9rem;">${t('ceoview.whenYouHave')}</div>
                </div>` : ''}

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">${t('ceoview.totalPayouts')}</div>
                        <div class="kpi-value">$${totalPayouts.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('ceoview.totalInvested')}</div>
                        <div class="kpi-value success">$${totalInvested.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('ceoview.capitalMultiple')}</div>
                        <div class="kpi-value">${capitalMultiple.toFixed(2)}x</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('ceoview.bestYear')}</div>
                        <div class="kpi-value">${bestYear}</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('ceoview.yearlyEvolution')}</h3>
                    <div class="chart-container" style="max-width: 800px;">
                        <canvas id="ceoLineChart"></canvas>
                    </div>
                </div>

                ${hasExamenData ? `
                <div class="table-container">
                    <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 700;">${t('ceoview.progressMetrics')}</h3>
                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 1.5rem;">${t('ceoview.calculatedFrom')}</div>
                    <div class="kpi-grid" style="margin-bottom: 0;">
                        <div class="kpi-card">
                            <div class="kpi-label">${t('ceoview.avgAttempts')}</div>
                            <div class="kpi-value">${avgAttemptsToFund > 0 ? avgAttemptsToFund.toFixed(1) : '‚Äî'}</div>
                            <div class="kpi-subtitle">${t('ceoview.phasesPerAccount')}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">${t('ceoview.avgDaysPhase1')}</div>
                            <div class="kpi-value">${avgDaysPhase1 > 0 ? Math.round(avgDaysPhase1) : '‚Äî'} <span style="font-size: 1rem;">days</span></div>
                            <div class="kpi-subtitle">${t('ceoview.untilPassP1')}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">${t('ceoview.avgDaysPhase2')}</div>
                            <div class="kpi-value">${avgDaysPhase2 > 0 ? Math.round(avgDaysPhase2) : '‚Äî'} <span style="font-size: 1rem;">days</span></div>
                            <div class="kpi-subtitle">${t('ceoview.untilFunded')}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">${t('ceoview.historyEntries')}</div>
                            <div class="kpi-value">${data.examens.length}</div>
                            <div class="kpi-subtitle">${t('ceoview.changesRecorded')}</div>
                        </div>
                    </div>
                </div>` : ''}

                <div class="table-container">
                    <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">${t('ceoview.recentPayouts')}</h3>
                    ${allPayouts.length === 0 ? '<div class="empty-state">' + t('ceoview.noPayouts') + '</div>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('ceoview.date')}</th>
                                    <th>${t('ceoview.account')}</th>
                                    <th>${t('ceoview.firm')}</th>
                                    <th>${t('ceoview.amount')}</th>
                                    <th>${t('ceoview.status')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allPayouts
                                    .sort((a, b) => new Date(b.payoutDate) - new Date(a.payoutDate))
                                    .slice(0, 10)
                                    .map(payout => {
                                        const account = allAccounts.find(a => a.id === payout.accountId);
                                        const accountNumber = account ? (account.accountNumber || account.id) : 'N/A';
                                        const propFirm = account ? account.propFirm : 'N/A';
                                        const statusClass = payout.status === 'Recibido' || payout.status === 'Received' ? 'funded' : payout.status === 'Aprobado' || payout.status === 'Approved' ? 'phase2' : 'phase1';
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(payout.payoutDate).toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US')}</td>
                                                <td style="font-weight: 600;">${accountNumber}</td>
                                                <td>${propFirm}</td>
                                                <td style="font-weight: 700; color: #2ECC71;">$${payout.amount.toLocaleString()}</td>
                                                <td><span class="status-badge ${statusClass}">${payout.status}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            `;

            document.getElementById('ceoview').innerHTML = ceoViewHtml;

            const ctx = document.getElementById('ceoLineChart');
            if (ctx && years.length > 0) {
                if (window.ceoChart && typeof window.ceoChart.destroy === 'function') {
                    window.ceoChart.destroy();
                }

                window.ceoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Payouts',
                            data: yearlyPayouts,
                            borderColor: '#2ECC71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#2ECC71',
                            pointBorderColor: '#121417',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (context) => `$${context.parsed.y.toLocaleString()}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => '$' + (value / 1000).toFixed(0) + 'k'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function renderCapitalEfficiency() {
            const activeYear = parseInt(document.getElementById('yearSelect').value);
            
            const allAccounts = data.master_comptes;
            const allPayouts = data.payouts;
            const totalWithdrawn = allPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalInvested = allAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const withdrawnToInvestedRatio = totalInvested > 0 ? totalWithdrawn / totalInvested : 0;

            const fundedAccounts = allAccounts.filter(a => a.status === 'FUNDED');
            const avgTimeToFunding = fundedAccounts.length > 0 
                ? fundedAccounts.reduce((sum, a) => sum + calculateDaysToFunding(a), 0) / fundedAccounts.length 
                : 0;

            const selfFundedPercentage = totalInvested > 0 ? Math.min((totalWithdrawn / totalInvested) * 100, 100) : 0;

            let breakEvenMonth = t('efficiency.pending');
            if (totalInvested > 0 && totalWithdrawn > 0) {
                if (totalWithdrawn >= totalInvested) {
                    breakEvenMonth = t('efficiency.reached');
                } else {
                    const last3Months = data.payouts
                        .filter(p => p.payoutDate)
                        .sort((a, b) => new Date(b.payoutDate) - new Date(a.payoutDate))
                        .slice(0, 10);
                    const recentMonthlyRate = last3Months.length > 0 
                        ? last3Months.reduce((s, p) => s + p.amount, 0) / 3 
                        : 0;
                    if (recentMonthlyRate > 0) {
                        const monthsRemaining = Math.ceil((totalInvested - totalWithdrawn) / recentMonthlyRate);
                        const breakDate = new Date();
                        breakDate.setMonth(breakDate.getMonth() + monthsRemaining);
                        const monthNames = currentLanguage === 'es' 
                            ? ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']
                            : ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        breakEvenMonth = `${monthNames[breakDate.getMonth()]} ${breakDate.getFullYear()}`;
                    }
                }
            }

            const efficiencyHtml = `
                <div class="dashboard-header">
                    <h2>${t('efficiency.title')} ¬∑ ${activeYear}</h2>
                    ${allAccounts.length === 0 ? `<div style="text-align:center;padding:0.5rem;color:#F39C12;font-size:0.85rem;">${t('efficiency.noData')}</div>` : ''}
                    <div class="subtitle">${t('propfirm.historical')} ¬∑ ${t('propfirm.updated')} ${new Date().toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { month: 'short', year: 'numeric' })}</div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">${t('efficiency.withdrawnInvested')}</div>
                        <div class="kpi-value success">${withdrawnToInvestedRatio.toFixed(2)}x</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('efficiency.avgTimeFunding')}</div>
                        <div class="kpi-value">${Math.round(avgTimeToFunding)} <span style="font-size: 1rem;">days</span></div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('efficiency.selfFundedSystem')}</div>
                        <div class="kpi-value success">${selfFundedPercentage.toFixed(0)}%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('efficiency.breakEven')}</div>
                        <div class="kpi-value" style="font-size: 1.4rem;">${breakEvenMonth}</div>
                        <div class="kpi-subtitle">${t('efficiency.projection')}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('efficiency.fundedInvested')}</h3>
                        
                        <div class="bar-chart">
                            <div class="bar-row">
                                <div class="bar-label">FUNDED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${Math.min(withdrawnToInvestedRatio * 20, 100)}%; background: linear-gradient(90deg, #2ECC71, #27AE60);">
                                        ${withdrawnToInvestedRatio > 0.5 ? '<span class="bar-value">$' + totalWithdrawn.toLocaleString() + '</span>' : ''}
                                    </div>
                                </div>
                                <div class="bar-count">$${totalWithdrawn.toLocaleString()}</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">INVESTED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: 50%; background: linear-gradient(90deg, #9AA0A6, #7F8C8D);">
                                        <span class="bar-value">$${totalInvested.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="bar-count">$${totalInvested.toLocaleString()}</div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; text-align: center;">
                            <div class="kpi-value success" style="font-size: 2.5rem;">+${((withdrawnToInvestedRatio - 1) * 100).toFixed(0)}%</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('efficiency.selfFundingStatus')}</h3>
                        
                        <div class="gauge-container">
                            <canvas id="selfFundingGauge"></canvas>
                            <div class="gauge-text">
                                <div class="gauge-percentage">${selfFundedPercentage.toFixed(0)}%</div>
                                <div class="gauge-label">$${totalWithdrawn.toLocaleString()} WITHDRAWN</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 700;">${t('efficiency.recoveryTrend')}</h3>
                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 1.5rem;">${t('efficiency.recoverySubtitle')}</div>
                    <div class="chart-container" style="max-width: 800px;">
                        <canvas id="autofinancingChart"></canvas>
                    </div>
                </div>
            `;

            document.getElementById('efficiency').innerHTML = efficiencyHtml;

            const gaugeCtx = document.getElementById('selfFundingGauge');
            if (gaugeCtx) {
                if (window.gaugeChart && typeof window.gaugeChart.destroy === 'function') {
                    window.gaugeChart.destroy();
                }

                window.gaugeChart = new Chart(gaugeCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [selfFundedPercentage, 100 - selfFundedPercentage],
                            backgroundColor: ['#2ECC71', 'rgba(230, 232, 235, 0.1)'],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        cutout: '75%'
                    }
                });
            }

            const trendCtx = document.getElementById('autofinancingChart');
            if (trendCtx) {
                if (window.autofinancingChart && typeof window.autofinancingChart.destroy === 'function') {
                    window.autofinancingChart.destroy();
                }

                const allSortedPayouts = [...data.payouts]
                    .filter(p => p.payoutDate)
                    .sort((a, b) => new Date(a.payoutDate) - new Date(b.payoutDate));

                const totalInvestedAll = data.master_comptes.reduce((sum, a) => sum + a.challengeCost, 0);

                let monthLabels = [];
                let monthData = [];

                if (allSortedPayouts.length > 0) {
                    const monthMap = {};
                    allSortedPayouts.forEach(p => {
                        const d = new Date(p.payoutDate);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        monthMap[key] = (monthMap[key] || 0) + p.amount;
                    });

                    const sortedKeys = Object.keys(monthMap).sort();
                    let cumulative = 0;
                    const monthNames = currentLanguage === 'es'
                        ? ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic']
                        : ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    sortedKeys.forEach(key => {
                        cumulative += monthMap[key];
                        const [yr, mo] = key.split('-');
                        monthLabels.push(`${monthNames[parseInt(mo)-1]} ${yr}`);
                        monthData.push(totalInvestedAll > 0 ? parseFloat(((cumulative / totalInvestedAll) * 100).toFixed(1)) : 0);
                    });
                } else {
                    monthLabels = ['No data'];
                    monthData = [0];
                }

                window.autofinancingChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: '% Payouts / Invested',
                            data: monthData,
                            borderColor: '#2ECC71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#2ECC71',
                            pointBorderColor: '#121417',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (ctx) => `${ctx.parsed.y.toFixed(1)}% recovered`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (v) => v + '%'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6', maxRotation: 45 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        function renderWrapped() {
            const activeYear = parseInt(document.getElementById('yearSelect').value);
            const yearAccounts = data.master_comptes.filter(a => a.year === activeYear);
            const yearPayouts = data.payouts.filter(p => p.year === activeYear);

            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalInvested = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const avgROI = totalInvested > 0 ? ((totalPayouts - totalInvested) / totalInvested * 100) : 0;
            const fundedAccounts = yearAccounts.filter(a => a.status === 'FUNDED').length;
            
            const fundedAccountsWithDays = yearAccounts
                .filter(a => a.status === 'FUNDED')
                .map(a => ({ ...a, days: calculateDaysToFunding(a) }))
                .sort((a, b) => a.days - b.days);
            const quickestFunding = fundedAccountsWithDays.length > 0 ? fundedAccountsWithDays[0].days : 0;

            const capitalMultiple = totalInvested > 0 ? totalPayouts / totalInvested : 0;
            const selfFundedPercentage = totalInvested > 0 ? Math.min((totalPayouts / totalInvested) * 100, 100) : 0;

            const totalChallenges = yearAccounts.length;
            const phase1WinRate = totalChallenges > 0 ? 
                (yearAccounts.filter(a => a.status !== 'PHASE 1' && a.status !== 'SUSPENDED').length / totalChallenges * 100) : 0;
            const passedPhase1 = yearAccounts.filter(a => a.status === 'PHASE 2' || a.status === 'FUNDED').length;
            const phase2WinRate = passedPhase1 > 0 ? (fundedAccounts / passedPhase1 * 100) : 0;

            const avgTimeToFunding = fundedAccountsWithDays.length > 0 
                ? fundedAccountsWithDays.reduce((sum, a) => sum + a.days, 0) / fundedAccountsWithDays.length 
                : 0;

            const propFirms = ['FTMO', 'Alpha Capital Group', 'Orion Funded', 'Bullfy', 'FundedNext', 'The5ers', 'MyForexFunds'];
            const payoutsByFirm = propFirms.map(firm => {
                const firmAccountIds = yearAccounts.filter(a => a.propFirm === firm).map(a => a.id);
                const firmPayouts = yearPayouts.filter(p => firmAccountIds.includes(p.accountId))
                    .reduce((sum, p) => sum + p.amount, 0);
                return { firm, payouts: firmPayouts };
            }).filter(f => f.payouts > 0).sort((a, b) => b.payouts - a.payouts);

            const completedByFirm = propFirms.map(firm => {
                const count = yearAccounts.filter(a => a.propFirm === firm && a.status === 'FUNDED').length;
                return { firm, count };
            }).filter(f => f.count > 0);

            const wrappedHtml = `
                <div class="wrapped-header">
                    <div class="wrapped-title">${t('wrapped.title')} ¬∑ ${activeYear}</div>
                    <div class="wrapped-subtitle">${t('wrapped.subtitle')}</div>
                    <div style="margin-top: 1rem;">
                        <select id="wrappedYearSelect" style="padding: 0.75rem 1.5rem; background: #181B20; border: 1px solid rgba(243, 156, 18, 0.3); border-radius: 8px; color: #E6E8EB; font-size: 0.95rem; font-weight: 600;">
                            <option value="2023" ${activeYear === 2023 ? 'selected' : ''}>2023</option>
                            <option value="2024" ${activeYear === 2024 ? 'selected' : ''}>2024</option>
                            <option value="2025" ${activeYear === 2025 ? 'selected' : ''}>2025</option>
                            <option value="2026" ${activeYear === 2026 ? 'selected' : ''}>2026</option>
                        </select>
                        <span style="margin-left: 1rem; color: #9AA0A6; font-size: 0.8rem;">${t('wrapped.synced')}</span>
                    </div>
                </div>

                ${yearAccounts.length === 0 ? `
                <div style="text-align:center; padding: 3rem; color: #9AA0A6; border: 1px dashed rgba(230,232,235,0.15); border-radius: 12px; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${t('wrapped.noData')} ${activeYear}</div>
                    <div style="font-size: 0.9rem;">${t('wrapped.createFirst')}</div>
                </div>` : ''}

                <div class="kpi-grid">
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(52, 152, 219, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-value success" style="font-size: 2.5rem;">+$${totalPayouts.toLocaleString()}</div>
                        <div class="kpi-label">${t('wrapped.totalPayouts')}</div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.05), rgba(230, 126, 34, 0.05)); border: 1px solid rgba(243, 156, 18, 0.2);">
                        <div class="kpi-value warning" style="font-size: 2.5rem;">${(totalPayouts > 0 && totalInvested > 0) ? (avgROI >= 0 ? "+" : "") + avgROI.toFixed(0) + "%" : "‚Äî"}</div>
                        <div class="kpi-label">${t('wrapped.avgRoi')}</div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(41, 128, 185, 0.05)); border: 1px solid rgba(52, 152, 219, 0.2);">
                        <div class="kpi-value" style="font-size: 2.5rem; color: #F39C12;">${quickestFunding > 0 ? quickestFunding + ' <span style="font-size: 1.2rem;">' + t('wrapped.days') + '</span>' : '‚Äî'}</div>
                        <div class="kpi-label">${t('wrapped.quickestFunding')}</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('wrapped.byFirm')}</h3>
                    <div class="chart-container" style="max-width: 600px;">
                        <canvas id="wrappedPayoutsChart"></canvas>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(39, 174, 96, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-label" style="text-align: center;">${t('wrapped.accountsFunded')}</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value success" style="font-size: 3.5rem;">${fundedAccounts}</div>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(39, 174, 96, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-label" style="text-align: center;">${t('wrapped.capitalMultiple')}</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value" style="font-size: 3.5rem;">${capitalMultiple > 0 ? capitalMultiple.toFixed(2) + "x" : "‚Äî"}</div>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(39, 174, 96, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-label" style="text-align: center;">${t('wrapped.selfFunded')}</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value success" style="font-size: 3.5rem;">${selfFundedPercentage.toFixed(0)}%</div>
                        </div>
                    </div>
                </div>

                ${totalChallenges > 0 ? `
                <div class="achievement-card">
                    <div class="achievement-icon">‚úÖ</div>
                    <div class="achievement-content">
                        <h4>${phase1WinRate.toFixed(0)}% ${t('wrapped.phase1Success')}</h4>
                        <p>${passedPhase1} ${t('wrapped.passedPhase1Of')} ${totalChallenges}</p>
                    </div>
                </div>` : ''}

                ${fundedAccounts > 0 ? `
                <div class="achievement-card">
                    <div class="achievement-icon">üî•</div>
                    <div class="achievement-content">
                        <h4>${phase2WinRate.toFixed(0)}% ${t('wrapped.phase2Success')}</h4>
                        <p>${t('wrapped.converted')} ${phase2WinRate.toFixed(0)}% ${t('wrapped.toFunded')}</p>
                    </div>
                </div>` : ''}

                ${avgTimeToFunding > 0 ? `
                <div class="achievement-card">
                    <div class="achievement-icon">‚ö°</div>
                    <div class="achievement-content">
                        <h4>${Math.round(avgTimeToFunding)} ${t('wrapped.avgTime')}</h4>
                        <p>${t('wrapped.avgFundedDays')} ${Math.round(avgTimeToFunding)} ${t('wrapped.daysLower')}</p>
                    </div>
                </div>` : ''}

                ${completedByFirm.map(f => `
                    <div class="achievement-card">
                        <div class="achievement-icon">${f.firm === 'FTMO' ? '‚óÜ' : f.firm === 'MyForexFunds' ? '‚óá' : '‚óà'}</div>
                        <div class="achievement-content">
                            <h4>${f.count} ${f.firm} ${t('wrapped.completed')}</h4>
                            <p>${t('wrapped.successfullyFunded')} ${f.count} ${f.firm} ${f.count > 1 ? t('wrapped.accounts') : t('wrapped.account')}</p>
                        </div>
                    </div>
                `).join('')}

                <div class="wrapped-generator">
                    <h2 style="font-size: 1.8rem; font-weight: 800; text-align: center; margin-bottom: 2rem; color: #F39C12;">
                        ${t('wrapped.generatorTitle')}
                    </h2>

                    <div class="config-section">
                        <div class="config-title">${t('wrapped.period')}</div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="wrappedPeriod" value="monthly" style="width: 18px; height: 18px; cursor: pointer;">
                                <span>${t('wrapped.monthly')}</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="wrappedPeriod" value="yearly" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <span>${t('wrapped.yearly')}</span>
                            </label>
                        </div>
                        <div id="monthSelector" style="margin-top: 1rem; display: none;">
                            <select id="wrappedMonth" style="padding: 0.5rem 1rem; background: #121417; border: 1px solid rgba(230, 232, 235, 0.1); border-radius: 6px; color: #E6E8EB;">
                                ${currentLanguage === 'es' ? `
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                                ` : `
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                                `}
                            </select>
                        </div>
                    </div>

                    <div class="config-section">
                        <div class="config-title">${t('wrapped.metrics')}</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.5rem;">
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_payouts" checked>
                                <label for="metric_payouts">${t('wrapped.totalPayoutsShort')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_roi" checked>
                                <label for="metric_roi">${t('wrapped.roi')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_funded" checked>
                                <label for="metric_funded">${t('wrapped.accountsFundedShort')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_invested" checked>
                                <label for="metric_invested">${t('wrapped.invested')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_winrate" checked>
                                <label for="metric_winrate">${t('wrapped.winRateP1')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_winrate2">
                                <label for="metric_winrate2">${t('wrapped.winRateP2')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_fastest">
                                <label for="metric_fastest">${t('wrapped.fastest')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_avgtime">
                                <label for="metric_avgtime">${t('wrapped.avgTimeShort')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_multiple">
                                <label for="metric_multiple">${t('wrapped.multiple')}</label>
                            </div>
                            <div class="metric-checkbox">
                                <input type="checkbox" id="metric_bestfirm">
                                <label for="metric_bestfirm">${t('wrapped.bestFirm')}</label>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <div class="config-title">${t('wrapped.design')}</div>
                        <div class="design-selector">
                            <div class="design-option selected" data-design="gradient1" onclick="selectDesign('gradient1')">
                                <div class="design-preview gradient1"></div>
                                <div style="font-size: 0.85rem; font-weight: 600;">${t('wrapped.fire')}</div>
                            </div>
                            <div class="design-option" data-design="gradient2" onclick="selectDesign('gradient2')">
                                <div class="design-preview gradient2"></div>
                                <div style="font-size: 0.85rem; font-weight: 600;">${t('wrapped.success')}</div>
                            </div>
                            <div class="design-option" data-design="gradient3" onclick="selectDesign('gradient3')">
                                <div class="design-preview gradient3"></div>
                                <div style="font-size: 0.85rem; font-weight: 600;">${t('wrapped.ocean')}</div>
                            </div>
                            <div class="design-option" data-design="dark" onclick="selectDesign('dark')">
                                <div class="design-preview dark"></div>
                                <div style="font-size: 0.85rem; font-weight: 600;">${t('wrapped.dark')}</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="generateWrappedPreview()">
                            ${t('wrapped.preview')}
                        </button>
                    </div>

                    <div id="wrappedPreview" style="display: none;">
                        <div class="preview-container">
                            <canvas id="wrappedCanvas" width="1080" height="1920" class="preview-canvas"></canvas>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn-secondary" onclick="closePreview()">
                                ${t('wrapped.back')}
                            </button>
                            <button class="btn-primary" onclick="downloadWrapped('png')">
                                ${t('wrapped.download')}
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('wrapped').innerHTML = wrappedHtml;

            const chartCtx = document.getElementById('wrappedPayoutsChart');
            if (chartCtx && payoutsByFirm.length > 0) {
                if (window.wrappedChart && typeof window.wrappedChart.destroy === 'function') {
                    window.wrappedChart.destroy();
                }

                window.wrappedChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: payoutsByFirm.map(f => f.firm),
                        datasets: [{
                            data: payoutsByFirm.map(f => f.payouts),
                            backgroundColor: ['#2ECC71', '#9AA0A6', '#F39C12'],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (context) => `$${context.parsed.y.toLocaleString()}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => '$' + (value / 1000).toFixed(0) + 'k'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            setTimeout(initWrappedListeners, 100);
        }

        function initWrappedListeners() {
            const wrappedYearSel = document.getElementById('wrappedYearSelect');
            if (wrappedYearSel) {
                wrappedYearSel.addEventListener('change', function() {
                    document.getElementById('yearSelect').value = this.value;
                    renderWrapped();
                });
            }

            const monthlyRadio = document.querySelector('input[name="wrappedPeriod"][value="monthly"]');
            const yearlyRadio = document.querySelector('input[name="wrappedPeriod"][value="yearly"]');
            
            if (monthlyRadio) {
                monthlyRadio.addEventListener('change', function() {
                    const monthSelector = document.getElementById('monthSelector');
                    if (monthSelector) monthSelector.style.display = 'block';
                });
            }
            
            if (yearlyRadio) {
                yearlyRadio.addEventListener('change', function() {
                    const monthSelector = document.getElementById('monthSelector');
                    if (monthSelector) monthSelector.style.display = 'none';
                });
            }
        }

        function initializeDashboard() {
            updateUI();
        }

        function updateUI() {
            const allActiveAccounts = data.master_comptes.filter(a => a.active);
            const fundedAccounts = data.master_comptes.filter(a => a.status === 'FUNDED' && a.active);

            const updateSelect = document.getElementById('updateAccountId');
            if (updateSelect) {
                if (allActiveAccounts.length === 0) {
                    updateSelect.innerHTML = `<option value="">${currentLanguage === 'es' ? 'No hay cuentas disponibles' : 'No accounts available'}</option>`;
                } else {
                    updateSelect.innerHTML = `<option value="">${currentLanguage === 'es' ? 'Selecciona una cuenta...' : 'Select an account...'}</option>` +
                        allActiveAccounts.map(a => {
                            const displayNumber = a.accountNumber || a.id;
                            return `<option value="${a.id}">${displayNumber} - ${a.propFirm} (${a.status})</option>`;
                        }).join('');
                }
            }

            const payoutSelect = document.getElementById('payoutAccountId');
            if (payoutSelect) {
                if (fundedAccounts.length === 0) {
                    payoutSelect.innerHTML = `<option value="">${currentLanguage === 'es' ? 'No hay cuentas fondeadas' : 'No funded accounts'}</option>`;
                } else {
                    payoutSelect.innerHTML = `<option value="">${currentLanguage === 'es' ? 'Selecciona una cuenta...' : 'Select an account...'}</option>` +
                        fundedAccounts.map(a => {
                            const displayNumber = a.accountNumber || a.id;
                            return `<option value="${a.id}">${displayNumber} - ${a.propFirm}</option>`;
                        }).join('');
                }
            }

            renderOverview();
            renderPerformance();
            renderPropFirm();
            renderCEOView();
            renderCapitalEfficiency();
            renderWrapped();
        }

        window.createChallenge = createChallenge;
        window.updateChallenge = updateChallenge;
        window.registerPayout = registerPayout;
        window.openResetModal = openResetModal;
        window.closeResetModal = closeResetModal;
        window.confirmReset = confirmReset;
        window.selectDesign = function(design) {
            document.querySelectorAll('.design-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-design="${design}"]`)?.classList.add('selected');
        };
        window.generateWrappedPreview = function() {
            showAlert(t('alerts.downloaded'), 'success');
        };
        window.closePreview = function() {
            document.getElementById('wrappedPreview').style.display = 'none';
        };
        window.downloadWrapped = function(format) {
            showAlert(t('alerts.downloaded'), 'success');
        };

    </script>
</body>
</html>
