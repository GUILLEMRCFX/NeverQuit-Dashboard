<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEVER QUIT DASHBOARD</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #121417;
            color: #E6E8EB;
            line-height: 1.6;
            padding: 2rem;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #181B20;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(230, 232, 235, 0.1);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #E6E8EB;
            margin-bottom: 1rem;
        }

        .modal-body {
            color: #9AA0A6;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.cancel {
            background: #9AA0A6;
            color: #121417;
        }

        .modal-btn.cancel:hover {
            background: #7F8C8D;
        }

        .modal-btn.confirm {
            background: #E74C3C;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #C0392B;
        }

        .modal-btn.confirm:not(:disabled):hover {
            background: #C0392B;
        }

        #confirmResetBtn:not(:disabled) {
            opacity: 1 !important;
            cursor: pointer !important;
        }

        #resetConfirmInput:focus {
            outline: none;
            border-color: #E74C3C !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(230, 232, 235, 0.1);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #E6E8EB 0%, #2ECC71 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #9AA0A6;
            font-size: 0.9rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ‚îÄ‚îÄ‚îÄ PER-VIEW TIME FILTER ‚îÄ‚îÄ‚îÄ */
        .view-header {
            position: relative;
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 2rem;
            border-bottom: 1px solid rgba(230, 232, 235, 0.1);
        }
        .view-header h2 {
            font-family: 'Inter', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: #E6E8EB;
            margin-bottom: 0.5rem;
            letter-spacing: 0.02em;
        }
        .view-header .subtitle { color: #9AA0A6; font-size: 0.95rem; }
        .time-filter {
            position: absolute;
            top: 2rem;
            right: 2rem;
        }
        .time-filter select {
            padding: 0.45rem 0.9rem;
            background: #181B20;
            border: 1px solid rgba(230, 232, 235, 0.12);
            border-radius: 6px;
            color: #E6E8EB;
            font-family: 'Inter', sans-serif;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
        }
        .time-filter select:focus { outline: none; border-color: rgba(46,204,113,0.4); }
        .view-label {
            display: inline-block;
            margin-top: 0.5rem;
            padding: 0.2rem 0.75rem;
            background: rgba(46,204,113,0.08);
            border: 1px solid rgba(46,204,113,0.2);
            border-radius: 20px;
            color: #2ECC71;
            font-size: 0.78rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .btn-reset {
            padding: 0.5rem 1rem;
            background: #E74C3C;
            color: white;
            border: none;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-reset:hover {
            background: #C0392B;
            transform: translateY(-1px);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(230, 232, 235, 0.05);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #2ECC71 rgba(230, 232, 235, 0.05);
            padding-bottom: 0.5rem;
            position: relative;
        }

        .tabs::-webkit-scrollbar {
            height: 6px;
        }

        .tabs::-webkit-scrollbar-track {
            background: rgba(230, 232, 235, 0.05);
            border-radius: 3px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: #2ECC71;
            border-radius: 3px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: #27AE60;
        }

        .tab-container {
            position: relative;
            overflow: hidden;
        }

        .tab {
            padding: 0.65rem 1.25rem;
            background: transparent;
            border: none;
            color: #6B7280;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
            position: relative;
        }

        .tab:hover {
            color: #C0C7D0;
        }

        .tab.active {
            color: #2ECC71;
            border-bottom-color: #2ECC71;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: #181B20;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(230, 232, 235, 0.05);
        }

        .card-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #9AA0A6;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #9AA0A6;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #121417;
            border: 1px solid rgba(230, 232, 235, 0.1);
            border-radius: 8px;
            color: #E6E8EB;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2ECC71;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            background: #2ECC71;
            color: #121417;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #27AE60;
            transform: translateY(-1px);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: #181B20;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(230, 232, 235, 0.05);
        }

        .kpi-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #9AA0A6;
            margin-bottom: 0.75rem;
            letter-spacing: 0.05em;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'Inter', sans-serif;
            color: #E6E8EB;
            margin-bottom: 0.5rem;
        }

        .kpi-value.success { color: #2ECC71; }
        .kpi-value.warning { color: #F39C12; }
        .kpi-value.danger { color: #E74C3C; }

        .kpi-subtitle {
            font-size: 0.8rem;
            color: #9AA0A6;
        }

        .table-container {
            background: #181B20;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(230, 232, 235, 0.05);
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid rgba(230, 232, 235, 0.1);
            color: #9AA0A6;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(230, 232, 235, 0.05);
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(46, 204, 113, 0.05);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.funded {
            background: rgba(46, 204, 113, 0.15);
            color: #2ECC71;
        }

        .status-badge.phase1 {
            background: rgba(52, 152, 219, 0.15);
            color: #3498DB;
        }

        .status-badge.phase2 {
            background: rgba(243, 156, 18, 0.15);
            color: #F39C12;
        }

        .status-badge.suspended {
            background: rgba(231, 76, 60, 0.15);
            color: #E74C3C;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            z-index: 10001; /* above lang-switch (9999) and login overlay (10000) */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .alert.hiding {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        .alert.success {
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .alert.success::before {
            content: '‚úì';
            font-size: 1.5rem;
            font-weight: bold;
        }

        .alert.error {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .alert.error::before {
            content: '‚úï';
            font-size: 1.5rem;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #9AA0A6;
        }

        .chart-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding: 2rem;
            border-bottom: 1px solid rgba(230, 232, 235, 0.1);
        }

        .dashboard-header h2 {
            font-family: 'Inter', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: #E6E8EB;
            margin-bottom: 0.5rem;
            letter-spacing: 0.02em;
        }

        .dashboard-header .subtitle {
            color: #9AA0A6;
            font-size: 0.95rem;
        }

        /* Horizontal bar styles */
        .bar-chart {
            width: 100%;
            margin: 1rem 0;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bar-label {
            min-width: 100px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #E6E8EB;
        }

        .bar-track {
            flex: 1;
            height: 32px;
            background: rgba(230, 232, 235, 0.05);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ECC71, #27AE60);
            border-radius: 6px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.75rem;
        }

        .bar-value {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: #121417;
        }

        .bar-count {
            min-width: 60px;
            text-align: right;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: #E6E8EB;
        }

        /* Gauge chart container */
        .gauge-container {
            position: relative;
            max-width: 300px;
            margin: 2rem auto;
        }

        .gauge-text {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .gauge-percentage {
            font-family: 'Inter', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            color: #2ECC71;
        }

        .gauge-label {
            font-size: 0.85rem;
            color: #9AA0A6;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Wrapped specific styles */
        .wrapped-header {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(46, 204, 113, 0.1));
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .wrapped-title {
            font-family: 'Inter', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #F39C12, #2ECC71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .wrapped-subtitle {
            color: #9AA0A6;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .metric-highlight {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(46, 204, 113, 0.15);
            border-radius: 6px;
            color: #2ECC71;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
        }

        .achievement-card {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(52, 152, 219, 0.05));
            border: 1px solid rgba(46, 204, 113, 0.2);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .achievement-icon {
            font-size: 2rem;
        }

        .achievement-content h4 {
            font-family: 'Inter', sans-serif;
            color: #E6E8EB;
            margin-bottom: 0.25rem;
        }

        .achievement-content p {
            color: #9AA0A6;
            font-size: 0.85rem;
        }

        /* Wrapped Generator Styles */
        .wrapped-generator {
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(46, 204, 113, 0.1));
            border: 2px solid rgba(243, 156, 18, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .config-section {
            background: #181B20;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .config-title {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #F39C12;
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }

        .metric-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(230, 232, 235, 0.03);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .metric-checkbox:hover {
            background: rgba(46, 204, 113, 0.1);
        }

        .metric-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .metric-checkbox label {
            cursor: pointer;
            flex: 1;
            font-size: 0.9rem;
            color: #E6E8EB;
        }

        .preview-container {
            background: #121417;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-canvas {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .btn-primary {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #F39C12, #E67E22);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 0.05em;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: #9AA0A6;
            color: #121417;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #7F8C8D;
        }

        .design-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.6rem;
            margin-top: 0;
        }

        .design-option {
            padding: 1rem;
            background: rgba(230, 232, 235, 0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .design-option:hover {
            border-color: #F39C12;
        }

        .design-option.selected {
            border-color: #2ECC71;
            background: rgba(46, 204, 113, 0.1);
        }

        .design-preview {
            width: 100%;
            height: 70px;
            border-radius: 8px;
            margin-bottom: 0.4rem;
            background: radial-gradient(ellipse at 60% 20%, rgba(255,255,255,0.08) 0%, #0C0D0F 70%);
        }

        .design-preview.gradient1 {
            background: radial-gradient(ellipse at 80% 10%, rgba(243,156,18,0.7) 0%, #0D0A07 70%);
        }

        .design-preview.gradient2 {
            background: radial-gradient(ellipse at 80% 10%, rgba(46,204,113,0.7) 0%, #020D06 70%);
        }

        .design-preview.gradient3 {
            background: radial-gradient(ellipse at 80% 10%, rgba(52,152,219,0.7) 0%, #03060F 70%);
        }

        .design-preview.dark {
            background: radial-gradient(ellipse at 60% 20%, rgba(255,255,255,0.08) 0%, #0C0D0F 70%);
        }

        .wrapped-metric-toggle {
            padding: 0.45rem 0.9rem;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            color: #6B7280;
            font-family: 'Inter', sans-serif;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wrapped-metric-toggle.active {
            background: rgba(243,156,18,0.12);
            border-color: rgba(243,156,18,0.4);
            color: #F39C12;
        }

        .wrapped-metric-toggle:hover:not(.active) {
            border-color: rgba(255,255,255,0.2);
            color: #C0C7D0;
        }

        /* Login Screen Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #121417 0%, #1a1d23 100%);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            background: #181B20;
            border-radius: 20px;
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(230, 232, 235, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: loginSlideIn 0.5s ease-out;
        }

        @keyframes loginSlideIn {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #E6E8EB 0%, #2ECC71 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #9AA0A6;
            font-size: 0.9rem;
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .login-form label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #9AA0A6;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .login-form input {
            width: 100%;
            padding: 1rem;
            background: #121417;
            border: 1px solid rgba(230, 232, 235, 0.1);
            border-radius: 10px;
            color: #E6E8EB;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: #2ECC71;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .dev-bypass {
            margin-top: 1rem;
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid rgba(230, 232, 235, 0.05);
        }

        .dev-bypass button {
            background: transparent;
            border: 1px solid rgba(230, 232, 235, 0.1);
            color: #9AA0A6;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dev-bypass button:hover {
            border-color: #2ECC71;
            color: #2ECC71;
        }

        .login-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #E74C3C;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            text-align: center;
            display: none;
        }

        .login-error.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @media (max-width: 968px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 1rem 0.75rem;
                padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
                padding-left: max(0.75rem, env(safe-area-inset-left, 0px));
                padding-right: max(0.75rem, env(safe-area-inset-right, 0px));
            }
            .container {
                padding: 0;
            }
            header h1 {
                font-size: 1.4rem;
            }
            header .subtitle {
                font-size: 0.75rem;
            }
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }
            .kpi-card {
                padding: 1rem 0.85rem;
            }
            .kpi-value {
                font-size: 1.5rem;
            }
            .tabs {
                gap: 0;
                margin-bottom: 1.5rem;
            }
            .tab {
                padding: 0.6rem 0.85rem;
                font-size: 0.65rem;
                letter-spacing: 0.07em;
            }
            .card {
                padding: 1rem;
            }
            .grid {
                gap: 1rem;
            }
            .dashboard-header h2, .view-header h2 {
                font-size: 1.1rem;
            }
            .lang-switch {
                top: 10px;
                right: 10px;
            }
            .header-actions {
                gap: 0.5rem;
            }
            .btn {
                padding: 0.5rem 0.9rem;
                font-size: 0.75rem;
            }
        }

/* ‚îÄ‚îÄ‚îÄ EXTRACTED FROM INLINE STYLES ‚îÄ‚îÄ‚îÄ */

.reset-confirm-input {
    width: 100%;
    padding: 0.75rem;
    background: #121417;
    border: 2px solid rgba(231,76,60,0.3);
    border-radius: 8px;
    color: #E6E8EB;
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.label-danger {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #E74C3C;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
}

.modal-btn.confirm:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-reset--gray {
    background: #9AA0A6 !important;
}
        /* ‚îÄ‚îÄ‚îÄ LANGUAGE SELECTOR ‚îÄ‚îÄ‚îÄ */
        /* ‚îÄ‚îÄ‚îÄ LANGUAGE SELECTOR (ES | EN) ‚îÄ‚îÄ‚îÄ */
        .lang-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            align-items: center;
            background: rgba(24, 27, 32, 0.9);
            border: 1px solid rgba(230, 232, 235, 0.1);
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 14px rgba(0,0,0,0.3);
        }
        .lang-switch-opt {
            background: none;
            border: none;
            color: #9AA0A6;
            font-family: 'Inter', sans-serif;
            font-size: 0.76rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            cursor: pointer;
            padding: 0.1rem 0.35rem;
            transition: color 0.2s;
        }
        .lang-switch-opt:hover { color: #E6E8EB; }
        .lang-switch-opt.active { color: #2ECC71; }
        .lang-switch-sep {
            color: rgba(230,232,235,0.18);
            font-size: 0.75rem;
            padding: 0 0.05rem;
            pointer-events: none;
            user-select: none;
        }
        @media (max-width:968px) { .lang-switch { top:10px; right:10px; } }

        /* ‚îÄ‚îÄ‚îÄ LOGIN CURSOR CANVAS ‚îÄ‚îÄ‚îÄ */
        #loginCursorCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }

        /* ‚îÄ‚îÄ‚îÄ DASHBOARD BACKGROUND PARTICLES ‚îÄ‚îÄ‚îÄ */
        #dashParticles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
            opacity: 0; transition: opacity 1.2s ease;
        }

        /* ‚îÄ‚îÄ‚îÄ HISTORY FAB & PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #historyFab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            z-index: 9990;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        #historyFab:hover { transform: scale(1.08); }

        #historyBadge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #E74C3C;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.65rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #historyPanel {
            position: fixed;
            bottom: 84px;
            left: 20px;
            width: 360px;
            max-height: 70vh;
            background: #181B20;
            border: 1px solid rgba(230,232,235,0.1);
            border-radius: 16px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.5);
            z-index: 9989;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        #historyPanel.open {
            display: flex;
            animation: slideUpPanel 0.25s ease-out;
        }
        @keyframes slideUpPanel {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .hp-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(230,232,235,0.08);
            font-size: 0.85rem;
            font-weight: 700;
            color: #E6E8EB;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .hp-close {
            background: none;
            border: none;
            color: #9AA0A6;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0 0.25rem;
            line-height: 1;
        }
        .hp-close:hover { color: #E6E8EB; }
        .hp-body {
            overflow-y: auto;
            flex: 1;
            padding: 0.75rem 1rem;
            scrollbar-width: thin;
            scrollbar-color: #2ECC71 rgba(230,232,235,0.05);
        }
        .hp-body::-webkit-scrollbar { width: 4px; }
        .hp-body::-webkit-scrollbar-thumb { background: #2ECC71; border-radius: 2px; }
        .hp-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #2ECC71;
            margin: 0.75rem 0 0.4rem;
        }
        .hp-section-title:first-child { margin-top: 0; }
        .hp-empty {
            color: #9AA0A6;
            font-size: 0.78rem;
            font-style: italic;
            padding: 0.25rem 0;
        }
        .hp-entry {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            padding: 0.5rem 0.6rem;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            margin-bottom: 0.4rem;
            font-size: 0.78rem;
            color: #C0C7D0;
            transition: background 0.15s;
        }
        .hp-entry:hover { background: rgba(255,255,255,0.06); }
        .hp-entry-info { flex: 1; line-height: 1.5; }
        .hp-entry-info strong { color: #E6E8EB; font-size: 0.8rem; }
        .hp-entry-info span  { display: block; }
        .hp-del {
            background: none;
            border: none;
            color: #E74C3C;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0 0.2rem;
            flex-shrink: 0;
            opacity: 0.6;
            transition: opacity 0.15s;
            line-height: 1;
            margin-top: 2px;
        }
        .hp-del:hover { opacity: 1; }
    </style>
</head>
<body>
    <!-- Language Selector: ES | EN -->
    <div class="lang-switch">
        <button class="lang-switch-opt active" id="opt-es" onclick="setLanguage('es')">ES</button>
        <span class="lang-switch-sep">|</span>
        <button class="lang-switch-opt" id="opt-en" onclick="setLanguage('en')">EN</button>
    </div>

    <!-- Login Screen -->
    <div id="loginOverlay" class="login-overlay">
        <canvas id="loginCursorCanvas"></canvas>
        <div class="login-box">
            <div class="login-header">
                <h1>NEVER QUIT</h1>
                <p>Dashboard de Gesti√≥n Profesional</p>
            </div>
            
            <div id="loginError" class="login-error">
                Usuario o contrase√±a incorrectos
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="loginUsername" placeholder="Introduce tu usuario" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPassword" placeholder="Introduce tu contrase√±a" autocomplete="current-password">
                </div>
                
                <button type="submit" class="login-btn">Entrar al Dashboard</button>
            </form>
            
            <!-- DEV MODE: Bypass durante desarrollo -->
            <div class="dev-bypass">
                <button onclick="bypassLogin()" title="Solo durante desarrollo">üîß Modo Desarrollo (Skip Login)</button>
            </div>
        </div>
    </div>

    <!-- Dashboard background particle canvas -->
    <canvas id="dashParticles"></canvas>
    <div class="container">
        <!-- Modal de confirmaci√≥n -->
        <div id="resetModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">‚ö†Ô∏è Confirmar Reset</div>
                <div class="modal-body">
                    ¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n <strong>no se puede deshacer</strong>.
                    <br><br>
                    Se borrar√°n:
                    <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                        <li>Todas las challenges</li>
                        <li>Todos los payouts</li>
                        <li>Todo el historial</li>
                    </ul>
                    <br>
                    <label class="label-danger">
                        Escribe RESET para confirmar:
                    </label>
                    <input type="text" id="resetConfirmInput" class="reset-confirm-input" placeholder="RESET"
                        oninput="document.getElementById('confirmResetBtn').disabled = this.value.toUpperCase() !== 'RESET'">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeResetModal()">Cancelar</button>
                    <button id="confirmResetBtn" class="modal-btn confirm" onclick="confirmReset()" disabled>S√≠, Eliminar Todo</button>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>NEVER QUIT DASHBOARD</h1>
            <p>Sistema de Gesti√≥n de Capital Profesional</p>
            <div class="header-actions">
                <span id="headerUsername" style="color:#9AA0A6;font-size:0.8rem;font-weight:600;letter-spacing:0.04em;"></span>
                <button class="btn-reset" onclick="openResetModal()">üîÑ Reset Datos</button>
                <button class="btn-reset btn-reset--gray" onclick="logout()">üö™ Salir</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="tabs">
            <button class="tab active" data-tab="control">Control Center</button>
            <button class="tab" data-tab="overview">Overview</button>
            <button class="tab" data-tab="performance">Performance</button>
            <button class="tab" data-tab="propfirm">Prop Firm</button>
            <button class="tab" data-tab="ceoview">CEO View</button>
            <button class="tab" data-tab="efficiency">Capital Efficiency</button>
            <button class="tab" data-tab="wrapped">Wrapped</button>
        </div>

        <!-- CONTROL CENTER -->
        <div id="control" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <div class="card-title">Create Challenge</div>
                    <div class="form-group">
                        <label>Prop Firm</label>
                        <select id="createPropFirm">
                            <option>FTMO</option>
                            <option>Alpha Capital Group</option>
                            <option>Orion Funded</option>
                            <option>Bullfy</option>
                            <option>FundedNext</option>
                            <option>The5ers</option>
                            <option>MyForexFunds</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account Size</label>
                        <select id="createAccountSize">
                            <option>10K</option>
                            <option>25K</option>
                            <option selected>50K</option>
                            <option>100K</option>
                            <option>200K</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" id="createPurchaseDate">
                    </div>
                    <div class="form-group">
                        <label>Challenge Cost (‚Ç¨)</label>
                        <input type="number" id="createChallengeCost" placeholder="345.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="createAccountNumber" placeholder="N√∫mero de cuenta de la prop firm">
                    </div>
                    <button class="btn" onclick="createChallenge()">Crear Challenge</button>
                </div>

                <div class="card">
                    <div class="card-title">Update Challenge</div>
                    <div class="form-group">
                        <label>Account</label>
                        <select id="updateAccountId" onchange="onUpdateAccountChange()"></select>
                    </div>
                    <div class="form-group">
                        <label>New Status</label>
                        <select id="updateNewStatus"></select>
                        <div id="statusTransitionHint" style="margin-top: 0.5rem; font-size: 0.78rem; font-weight: 600; letter-spacing: 0.04em;"></div>
                    </div>
                    <div class="form-group">
                        <label>Status Date</label>
                        <input type="date" id="updateStatusDate">
                    </div>
                    <button class="btn" onclick="updateChallenge()">Actualitzar Challenge</button>
                </div>

                <div class="card">
                    <div class="card-title">Register Payout</div>
                    <div class="form-group">
                        <label>Account</label>
                        <select id="payoutAccountId"></select>
                    </div>
                    <div class="form-group">
                        <label>Amount (‚Ç¨)</label>
                        <input type="number" id="payoutAmount" placeholder="2500.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Payout Date</label>
                        <input type="date" id="payoutDate">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="payoutStatus">
                            <option value="Solicitado">Solicitado</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="Recibido" selected>Recibido</option>
                        </select>
                    </div>
                    <button class="btn" onclick="registerPayout()">Registrar Payout</button>
                </div>
            </div>
        </div>

        <!-- OVERVIEW -->
        <div id="overview" class="tab-content"></div>

        <!-- PERFORMANCE -->
        <div id="performance" class="tab-content"></div>

        <!-- PROP FIRM -->
        <div id="propfirm" class="tab-content"></div>

        <!-- CEO VIEW -->
        <div id="ceoview" class="tab-content"></div>

        <!-- CAPITAL EFFICIENCY -->
        <div id="efficiency" class="tab-content"></div>

        <!-- WRAPPED -->
        <div id="wrapped" class="tab-content"></div>
    </div>

    <script>
// ============================================
// LOGIN CURSOR EFFECT ‚Äî Particle Constellation
// ============================================
(function initLoginCursor() {
    const overlay = document.getElementById('loginOverlay');
    const canvas  = document.getElementById('loginCursorCanvas');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    let W, H, mouse = { x: -999, y: -999 };
    const PARTICLES = [];
    const PARTICLE_COUNT = 110;
    const CONNECTION_DIST = 130;
    const COLORS = ['#2ECC71','#27AE60','#1abc9c','#58d68d','#48c774'];

    function resize() {
        W = canvas.width  = overlay.offsetWidth;
        H = canvas.height = overlay.offsetHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    for (let i = 0; i < PARTICLE_COUNT; i++) {
        PARTICLES.push({
            x: Math.random() * W,
            y: Math.random() * H,
            vx: (Math.random() - 0.5) * 0.45,
            vy: (Math.random() - 0.5) * 0.45,
            r: Math.random() * 2.2 + 0.8,
            color: COLORS[Math.floor(Math.random() * COLORS.length)],
            alpha: Math.random() * 0.5 + 0.2
        });
    }

    const SPARKS = [];

    overlay.addEventListener('mousemove', function(e) {
        const rect = overlay.getBoundingClientRect();
        mouse.x = e.clientX - rect.left;
        mouse.y = e.clientY - rect.top;
        for (let i = 0; i < 3; i++) {
            SPARKS.push({
                x: mouse.x + (Math.random() - 0.5) * 10,
                y: mouse.y + (Math.random() - 0.5) * 10,
                vx: (Math.random() - 0.5) * 2.5,
                vy: (Math.random() - 0.5) * 2.5 - 0.8,
                life: 1.0,
                decay: Math.random() * 0.03 + 0.025,
                r: Math.random() * 3 + 1,
                color: COLORS[Math.floor(Math.random() * COLORS.length)]
            });
        }
    });

    function loop() {
        ctx.clearRect(0, 0, W, H);
        if (mouse.x > 0) {
            const grd = ctx.createRadialGradient(mouse.x, mouse.y, 0, mouse.x, mouse.y, 180);
            grd.addColorStop(0, 'rgba(46,204,113,0.12)');
            grd.addColorStop(0.5, 'rgba(46,204,113,0.04)');
            grd.addColorStop(1, 'rgba(46,204,113,0)');
            ctx.fillStyle = grd;
            ctx.beginPath();
            ctx.arc(mouse.x, mouse.y, 180, 0, Math.PI * 2);
            ctx.fill();
        }
        for (let i = 0; i < PARTICLES.length; i++) {
            const p = PARTICLES[i];
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
            if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
            const dx = p.x - mouse.x, dy = p.y - mouse.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 80) { const force = (80 - dist) / 80 * 0.5; p.x += (dx / dist) * force; p.y += (dy / dist) * force; }
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.color; ctx.globalAlpha = p.alpha; ctx.fill(); ctx.globalAlpha = 1;
        }
        ctx.lineWidth = 0.5;
        for (let i = 0; i < PARTICLES.length; i++) {
            for (let j = i + 1; j < PARTICLES.length; j++) {
                const dx = PARTICLES[i].x - PARTICLES[j].x, dy = PARTICLES[i].y - PARTICLES[j].y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < CONNECTION_DIST) {
                    ctx.strokeStyle = `rgba(46,204,113,${(1 - dist / CONNECTION_DIST) * 0.18})`;
                    ctx.globalAlpha = 1; ctx.beginPath();
                    ctx.moveTo(PARTICLES[i].x, PARTICLES[i].y); ctx.lineTo(PARTICLES[j].x, PARTICLES[j].y); ctx.stroke();
                }
            }
            const dx = PARTICLES[i].x - mouse.x, dy = PARTICLES[i].y - mouse.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < CONNECTION_DIST * 1.3) {
                ctx.strokeStyle = `rgba(46,204,113,${(1 - dist / (CONNECTION_DIST * 1.3)) * 0.4})`;
                ctx.lineWidth = 0.8; ctx.beginPath();
                ctx.moveTo(PARTICLES[i].x, PARTICLES[i].y); ctx.lineTo(mouse.x, mouse.y); ctx.stroke();
            }
        }
        for (let i = SPARKS.length - 1; i >= 0; i--) {
            const s = SPARKS[i];
            s.x += s.vx; s.y += s.vy; s.life -= s.decay;
            if (s.life <= 0) { SPARKS.splice(i, 1); continue; }
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r * s.life, 0, Math.PI * 2);
            ctx.fillStyle = s.color; ctx.globalAlpha = s.life * 0.85; ctx.fill();
        }
        ctx.globalAlpha = 1;
        requestAnimationFrame(loop);
    }
    loop();
})();

// ============================================
// DASHBOARD BACKGROUND PARTICLES
// ============================================
let dashParticlesRunning = false;
function initDashParticles() {
    if (dashParticlesRunning) return;
    dashParticlesRunning = true;
    const canvas = document.getElementById('dashParticles');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let W, H;
    const COLORS = ['#2ECC71','#27AE60','#1abc9c','#58d68d'];
    const COUNT  = 55;
    const CONN   = 140;
    const pts = [];

    function resize() {
        W = canvas.width  = window.innerWidth;
        H = canvas.height = window.innerHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    for (let i = 0; i < COUNT; i++) {
        pts.push({
            x:  Math.random() * W,
            y:  Math.random() * H,
            vx: (Math.random() - 0.5) * 0.25,
            vy: (Math.random() - 0.5) * 0.25,
            r:  Math.random() * 1.6 + 0.6,
            color: COLORS[Math.floor(Math.random() * COLORS.length)],
            alpha: Math.random() * 0.18 + 0.06
        });
    }

    function loop() {
        ctx.clearRect(0, 0, W, H);
        for (let i = 0; i < pts.length; i++) {
            const p = pts[i];
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
            if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.color; ctx.globalAlpha = p.alpha; ctx.fill();
        }
        ctx.lineWidth = 0.4;
        for (let i = 0; i < pts.length; i++) {
            for (let j = i + 1; j < pts.length; j++) {
                const dx = pts[i].x - pts[j].x, dy = pts[i].y - pts[j].y;
                const d  = Math.sqrt(dx * dx + dy * dy);
                if (d < CONN) {
                    ctx.strokeStyle = `rgba(46,204,113,${(1 - d / CONN) * 0.08})`;
                    ctx.globalAlpha = 1; ctx.beginPath();
                    ctx.moveTo(pts[i].x, pts[i].y); ctx.lineTo(pts[j].x, pts[j].y); ctx.stroke();
                }
            }
        }
        ctx.globalAlpha = 1;
        requestAnimationFrame(loop);
    }
    loop();
    // Fade in
    setTimeout(() => { canvas.style.opacity = '1'; }, 100);
}

// ============================================
// i18n
// ============================================
const i18n = {
    es: {
        app: { name:"NEVER QUIT", fullName:"NEVER QUIT DASHBOARD", tagline:"Sistema de Gesti√≥n de Capital Profesional" },
        login: { subtitle:"Dashboard de Gesti√≥n Profesional", username:"Usuario", password:"Contrase√±a", usernamePlaceholder:"Introduce tu usuario", passwordPlaceholder:"Introduce tu contrase√±a", submit:"Entrar al Dashboard", error:"Usuario o contrase√±a incorrectos", devMode:"üîß Modo Desarrollo (Skip Login)" },
        modal: { resetTitle:"‚ö†Ô∏è Confirmar Reset", resetConfirm:"¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n <strong>no se puede deshacer</strong>.", resetItems:"Se borrar√°n:", itemChallenges:"Todas las challenges", itemPayouts:"Todos los payouts", itemHistory:"Todo el historial", typeReset:"Escribe RESET para confirmar:", cancel:"Cancelar", confirmDelete:"S√≠, Eliminar Todo" },
        year: { label:"A√ëO ACTIVO:" },
        actions: { resetData:"üîÑ Reset Datos", logout:"üö™ Salir" },
        tabs: { control:"Control Center", overview:"Overview", performance:"Performance", propfirm:"Prop Firm", ceoview:"CEO View", efficiency:"Capital Efficiency", wrapped:"Wrapped" },
        dash: {
            updated:"Actualizado", of:"de", total:"total", costs:"Costos", payments:"pagos",
            fundedAccounts:"cuentas fondeadas", noActiveAccounts:"Sin cuentas activas",
            payoutsReceived:"‚Ü≥ Payouts recibidos", myAccounts:"‚óá MIS CUENTAS ‚Äî ALL TIME",
            colAccount:"Cuenta", colSize:"Tama√±o", colCost:"Coste", colDate:"Fecha",
            colPctActive:"% Activas", totalActive:"Total activas", noSuspended:"Sin suspendidas",
            closedAccounts:"cerradas", suspended:"suspendida", excludedFemSg:"excluida", excludedFemPl:"excluidas",
            noChallenges:"Sin challenges ‚Äî crea una en Control Center",
            phase1WinRate:"‚óá TASA DE √âXITO PHASE 1", phase2WinRate:"TASA DE √âXITO PHASE 2",
            propFirmNoAccounts:"Sin cuentas de {firm} en el per√≠odo seleccionado",
            rendimiento:"Rendimiento", avgTimeToFunding:"TIEMPO PROMEDIO A FONDEO",
            days:"d√≠as", wrappedSubtitle:"TU A√ëO DE TRADING EN REVISI√ìN",
            noDataCreate:"Crea tu primera challenge en Control Center para ver tu Wrapped",
            noDataPeriod:"Sin datos para el per√≠odo seleccionado",
            bestPropFirmRoi:"BEST PROP FIRM ROI", allTime:"All-time",
            viewAllTime:"All-time business snapshot",
            pending:"Pendiente", reached:"‚úÖ Alcanzado",
            projection:"proyecci√≥n basada en ritmo actual",
            selfFunded:"SISTEMA AUTO-FINANCIADO", roiAverage:"ROI PROMEDIO",
            monthNames:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],
            monthNamesFull:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],
            ceoMode:"Modo: PRO", noHistory:"Sin historial todav√≠a",
            progressMetrics:"‚óá M√âTRICAS DE PROGRESO", progressCalculated:"Calculado desde el historial de cambios de estado",
            avgAttempts:"AVG. INTENTOS HASTA FONDEO", phasesPerAccount:"fases por cuenta fondeada",
            avgDaysPhase1:"AVG. D√çAS EN PHASE 1", toPassPhase1:"hasta superar Phase 1",
            avgDaysPhase2:"AVG. D√çAS EN PHASE 2", toGetFunded:"hasta conseguir fondeo",
            efficiencyChart:"% de lo invertido recuperado mediante payouts ¬∑ Datos reales mes a mes",
            quickestFunding:"FONDEO M√ÅS R√ÅPIDO", payoutsByFirm:"‚óá PAYOUTS POR PROP FIRM",
            avgFundingTime:"En promedio, fondeaste cuentas en {n} d√≠as",
            noHistoryDetail:"Cuando tengas challenges y payouts, aqu√≠ ver√°s tu evoluci√≥n global",
            capitalMultiple:"M√öLTIPLO DE CAPITAL", evolutionByYear:"‚óá EVOLUCI√ìN POR A√ëO",
            recoveryTrend:"‚óá TENDENCIA ACUMULADA DE RECUPERACI√ìN"
        }
    },
    en: {
        app: { name:"NEVER QUIT", fullName:"NEVER QUIT DASHBOARD", tagline:"Professional Capital Management System" },
        login: { subtitle:"Professional Management Dashboard", username:"Username", password:"Password", submit:"Enter Dashboard", error:"Incorrect username or password", devMode:"üîß Dev Mode (Skip Login)" },
        modal: { resetTitle:"‚ö†Ô∏è Confirm Reset", resetConfirm:"Are you sure you want to delete all data? This action <strong>cannot be undone</strong>.", resetItems:"Will be deleted:", itemChallenges:"All challenges", itemPayouts:"All payouts", itemHistory:"All history", typeReset:"Type RESET to confirm:", cancel:"Cancel", confirmDelete:"Yes, Delete Everything" },
        year: { label:"ACTIVE YEAR:" },
        actions: { resetData:"üîÑ Reset Data", logout:"üö™ Logout" },
        tabs: { control:"Control Center", overview:"Overview", performance:"Performance", propfirm:"Prop Firm", ceoview:"CEO View", efficiency:"Capital Efficiency", wrapped:"Wrapped" },
        dash: {
            updated:"Updated", of:"of", total:"total", costs:"Costs", payments:"payments",
            fundedAccounts:"funded accounts", noActiveAccounts:"No active accounts",
            payoutsReceived:"‚Ü≥ Payouts received", myAccounts:"‚óá MY ACCOUNTS ‚Äî ALL TIME",
            colAccount:"Account", colSize:"Size", colCost:"Cost", colDate:"Date",
            colPctActive:"% Active", totalActive:"Total active", noSuspended:"No suspended",
            closedAccounts:"closed", suspended:"suspended", excludedFemSg:"excluded", excludedFemPl:"excluded",
            noChallenges:"No challenges ‚Äî create one in Control Center",
            phase1WinRate:"‚óá PHASE 1 WIN RATE", phase2WinRate:"PHASE 2 WIN RATE",
            propFirmNoAccounts:"No accounts for {firm} in the selected period",
            rendimiento:"Performance", avgTimeToFunding:"AVG TIME TO FUNDING",
            days:"days", wrappedSubtitle:"YOUR TRADING YEAR IN REVIEW",
            noDataCreate:"Create your first challenge in Control Center to see your Wrapped",
            noDataPeriod:"No data for the selected period",
            bestPropFirmRoi:"BEST PROP FIRM ROI", allTime:"All-time",
            viewAllTime:"All-time business snapshot",
            pending:"Pending", reached:"‚úÖ Reached",
            projection:"projection based on current pace",
            selfFunded:"SELF-FUNDED SYSTEM", roiAverage:"AVERAGE ROI",
            monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
            monthNamesFull:["January","February","March","April","May","June","July","August","September","October","November","December"],
            ceoMode:"Mode: PRO", noHistory:"No history yet",
            progressMetrics:"‚óá PROGRESS METRICS", progressCalculated:"Calculated from phase change history",
            avgAttempts:"AVG. ATTEMPTS TO FUNDING", phasesPerAccount:"phases per funded account",
            avgDaysPhase1:"AVG. DAYS IN PHASE 1", toPassPhase1:"to pass Phase 1",
            avgDaysPhase2:"AVG. DAYS IN PHASE 2", toGetFunded:"to get funded",
            efficiencyChart:"% of invested amount recovered via payouts ¬∑ Real month-by-month data",
            quickestFunding:"QUICKEST FUNDING", payoutsByFirm:"‚óá PAYOUTS BY PROP FIRM",
            avgFundingTime:"On average, you funded accounts in {n} days",
            noHistoryDetail:"Once you have challenges and payouts, you'll see your global evolution here",
            capitalMultiple:"CAPITAL MULTIPLE", evolutionByYear:"‚óá YEARLY EVOLUTION",
            recoveryTrend:"‚óá CUMULATIVE RECOVERY TREND"
        }
    }
};

let currentLanguage = localStorage.getItem('neverQuitLanguage') || 'es';
if (currentLanguage === 'en') {
    const elEs = document.getElementById('opt-es');
    const elEn = document.getElementById('opt-en');
    if (elEs) elEs.classList.remove('active');
    if (elEn) elEn.classList.add('active');
}

function getTranslation(key) {
    const keys = key.split('.');
    let value = i18n[currentLanguage];
    for (const k of keys) { if (value) value = value[k]; }
    return value || null;
}
// Shorthand for dash translations
function t(key) { return getTranslation('dash.' + key) || key; }

function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('neverQuitLanguage', lang);
    document.getElementById('opt-es').classList.toggle('active', lang === 'es');
    document.getElementById('opt-en').classList.toggle('active', lang === 'en');
    document.documentElement.lang = lang;
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const tr = getTranslation(key);
        if (tr) el.innerHTML = tr;
    });
    // Re-render active dashboard tab to apply translated strings
    if (typeof window._dashUpdateUI === 'function') window._dashUpdateUI();
}
window.setLanguage = setLanguage;

        // === GLOBAL UTILS ===
        function $(id) { return document.getElementById(id); }

        // === LOGIN ===
        // ============================================
        // LOGIN SYSTEM - DEBE ESTAR DISPONIBLE INMEDIATAMENTE
        // ============================================
        
        // Credenciales ofuscadas (pendiente: mover a backend)
        function _checkCredential(u, p) {
            const v = {
                [atob('YWRtaW4=')]: atob('YWRtaW4xMjM='),
                [atob('ZGVtbw==')]: atob('ZGVtbzEyMw==')
            };
            return v[u] !== undefined && v[u] === p;
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const username = $('loginUsername').value.trim();
            const password = $('loginPassword').value;
            const errorDiv = $('loginError');
            
            // Validar credenciales
            if (_checkCredential(username, password)) {
                // Login exitoso
                localStorage.setItem('neverQuitLoggedIn', 'true');
                localStorage.setItem('neverQuitUsername', username);
                
                // Ocultar login con animaci√≥n
                $('loginOverlay').classList.add('hidden');
                const _hdr = document.getElementById('headerUsername');
                if (_hdr) _hdr.textContent = `‚óá ${username.toUpperCase()}`;
                initDashParticles();

                // Inicializar dashboard despu√©s de un delay
                setTimeout(() => {
                    if (typeof initializeDashboard === 'function') {
                        initializeDashboard();
                    }
                }, 500);
                
            } else {
                // Login fallido
                errorDiv.classList.add('show');
                $('loginPassword').value = '';
                
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 3000);
            }
        }

        function bypassLogin() {
            // Solo para desarrollo - permite saltarse el login
            localStorage.setItem('neverQuitLoggedIn', 'true');
            localStorage.setItem('neverQuitUsername', 'dev-mode');

            $('loginOverlay').classList.add('hidden');
            initDashParticles();

            setTimeout(() => {
                if (typeof initializeDashboard === 'function') {
                    initializeDashboard();
                }
            }, 500);
        }

        function logout() {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('neverQuitLoggedIn');
                localStorage.removeItem('neverQuitUsername');
                location.reload();
            }
        }

        // ============================================
        // EXPONER LOGIN/LOGOUT GLOBALMENTE - INMEDIATO
        // (el HTML usa onsubmit/onclick: deben existir
        //  ANTES del DOMContentLoaded, no dentro de √©l)
        // ============================================
        window.handleLogin = handleLogin;
        window.bypassLogin = bypassLogin;
        window.logout      = logout;

        // ============================================
        // INICIALIZACI√ìN - Esperar a que el DOM est√© listo
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            
        // Verificar si ya est√° logueado
        const isLoggedIn = localStorage.getItem('neverQuitLoggedIn') === 'true';

        // Mostrar usuario en header
        function setHeaderUsername() {
            const el = document.getElementById('headerUsername');
            const user = localStorage.getItem('neverQuitUsername');
            if (el && user) el.textContent = `‚óá ${user.toUpperCase()}`;
        }
        setHeaderUsername();

        if (isLoggedIn) {
            // Ya est√° logueado, ocultar login
            $('loginOverlay').classList.add('hidden');
            initDashParticles();
            // Inicializar dashboard despu√©s de un breve delay
            setTimeout(() => {
                initializeDashboard();
            }, 100);
        }

        // ============================================
        // DATOS INICIALES - Estado vac√≠o por defecto
        // ============================================
        let data = {
            master_comptes: [],
            payouts: [],
            examens: []
        };

        // Cargar datos del localStorage
        const savedData = localStorage.getItem('superDashboardData');
        if (savedData) {
            data = JSON.parse(savedData);
        } else {
            // Si no hay datos guardados, usar datos de ejemplo para testing
            data = {
                master_comptes: [
                    // FTMO
                    { id: "FTM_1704067200000_123", accountNumber: "5012345", year: 2025, propFirm: "FTMO", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-15", challengeCost: 345, lastStatusDate: "2025-02-01", active: true },
                    { id: "FTM_1706745600000_456", accountNumber: "5023456", year: 2025, propFirm: "FTMO", accountSize: "100K", status: "PHASE 1", purchaseDate: "2025-02-01", challengeCost: 540, lastStatusDate: "2025-02-01", active: true },
                    { id: "FTM_1704585600000_234", accountNumber: "5015678", year: 2025, propFirm: "FTMO", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-10", challengeCost: 345, lastStatusDate: "2025-01-25", active: true },
                    { id: "FTM_1704412800000_890", accountNumber: "5009876", year: 2025, propFirm: "FTMO", accountSize: "50K", status: "SUSPENDED", purchaseDate: "2025-01-05", challengeCost: 345, lastStatusDate: "2025-01-20", active: false },
                    { id: "FTM_1710460800000_345", accountNumber: "5003421", year: 2024, propFirm: "FTMO", accountSize: "50K", status: "FUNDED", purchaseDate: "2024-03-15", challengeCost: 345, lastStatusDate: "2024-04-01", active: true },
                    
                    // MyForexFunds
                    { id: "MYF_1705881600000_789", accountNumber: "MFF-8392847", year: 2025, propFirm: "MyForexFunds", accountSize: "25K", status: "FUNDED", purchaseDate: "2025-01-20", challengeCost: 180, lastStatusDate: "2025-02-05", active: true },
                    { id: "MYF_1716163200000_678", accountNumber: "MFF-7182934", year: 2024, propFirm: "MyForexFunds", accountSize: "100K", status: "FUNDED", purchaseDate: "2024-05-20", challengeCost: 450, lastStatusDate: "2024-06-10", active: true },
                    { id: "MYF_1707264000000_991", accountNumber: "MFF-5647382", year: 2025, propFirm: "MyForexFunds", accountSize: "50K", status: "PHASE 2", purchaseDate: "2025-02-03", challengeCost: 299, lastStatusDate: "2025-02-10", active: true },
                    
                    // Alpha Capital Group
                    { id: "ACG_1706054400000_567", accountNumber: "ACG-1234567", year: 2025, propFirm: "Alpha Capital Group", accountSize: "100K", status: "PHASE 2", purchaseDate: "2025-01-22", challengeCost: 400, lastStatusDate: "2025-02-05", active: true },
                    { id: "ACG_1706832000000_442", accountNumber: "ACG-9876543", year: 2025, propFirm: "Alpha Capital Group", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-28", challengeCost: 320, lastStatusDate: "2025-02-11", active: true },
                    
                    // Orion Funded
                    { id: "ORI_1705795200000_321", accountNumber: "ORF-9384756", year: 2025, propFirm: "Orion Funded", accountSize: "25K", status: "FUNDED", purchaseDate: "2025-01-18", challengeCost: 165, lastStatusDate: "2025-02-03", active: true },
                    
                    // FundedNext
                    { id: "FND_1707091200000_774", accountNumber: "FN-4729183", year: 2025, propFirm: "FundedNext", accountSize: "100K", status: "PHASE 1", purchaseDate: "2025-02-02", challengeCost: 499, lastStatusDate: "2025-02-02", active: true },
                    
                    // The5ers
                    { id: "T5R_1706227200000_885", accountNumber: "T5-8273645", year: 2025, propFirm: "The5ers", accountSize: "50K", status: "FUNDED", purchaseDate: "2025-01-24", challengeCost: 295, lastStatusDate: "2025-02-08", active: true }
                ],
                payouts: [
                    // FTMO payouts
                    { id: "PAY001", accountId: "FTM_1704067200000_123", year: 2025, payoutDate: "2025-02-05", amount: 2500, status: "Recibido" },
                    { id: "PAY002", accountId: "FTM_1704585600000_234", year: 2025, payoutDate: "2025-02-08", amount: 3200, status: "Recibido" },
                    { id: "PAY003", accountId: "FTM_1704067200000_123", year: 2025, payoutDate: "2025-02-12", amount: 2800, status: "Aprobado" },
                    { id: "PAY004", accountId: "FTM_1710460800000_345", year: 2024, payoutDate: "2024-05-15", amount: 4200, status: "Recibido" },
                    
                    // MyForexFunds payouts
                    { id: "PAY005", accountId: "MYF_1705881600000_789", year: 2025, payoutDate: "2025-02-10", amount: 1200, status: "Recibido" },
                    { id: "PAY006", accountId: "MYF_1716163200000_678", year: 2024, payoutDate: "2024-07-20", amount: 5000, status: "Recibido" },
                    
                    // Orion Funded payout
                    { id: "PAY007", accountId: "ORI_1705795200000_321", year: 2025, payoutDate: "2025-02-09", amount: 950, status: "Recibido" },
                    
                    // Alpha Capital Group payout
                    { id: "PAY008", accountId: "ACG_1706832000000_442", year: 2025, payoutDate: "2025-02-13", amount: 2100, status: "Solicitado" },
                    
                    // The5ers payout
                    { id: "PAY009", accountId: "T5R_1706227200000_885", year: 2025, payoutDate: "2025-02-11", amount: 1850, status: "Recibido" }
                ],
                examens: []
            };
            saveData();
        }

        // === STORAGE ===
        // Guardar datos
        function saveData() {
            localStorage.setItem('superDashboardData', JSON.stringify(data));
        }

        // --- applyTranslations ---
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                var key = el.getAttribute('data-i18n');
                var value = getTranslation(key);
                if (!value) return;
                if (key === 'modal.resetConfirm' || key === 'modal.resetBody') {
                    el.innerHTML = value;
                } else {
                    el.textContent = value;
                }
            });
        }

        // SISTEMA DE DESHACER
        let lastAction = null;
        let undoTimeout = null;

        // ‚îÄ‚îÄ‚îÄ PERSISTENT ACTION HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let actionHistory = { challenges: [], statuses: [], payouts: [] };
        (function loadActionHistory() {
            try {
                const raw = localStorage.getItem('nqActionHistory');
                if (raw) actionHistory = JSON.parse(raw);
            } catch(e) {}
        })();

        function saveLastAction(type, actionData) {
            lastAction = {
                type: type,
                data: actionData,
                timestamp: Date.now()
            };
            
            // Mostrar bot√≥n de deshacer
            showUndoButton();
        }

        function showUndoButton() {
            // Limpiar timeout anterior
            if (undoTimeout) clearTimeout(undoTimeout);
            
            const alertContainer = $('alertContainer');
            
            // Crear bot√≥n de deshacer
            const undoDiv = document.createElement('div');
            undoDiv.id = 'undoButton';
            undoDiv.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #3498DB, #2980B9);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                z-index: 9998;
                animation: slideInRight 0.3s ease-out;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            `;
            undoDiv.innerHTML = '<span style="font-size: 1.2rem;">‚Ü∂</span><span>Deshacer √∫ltima acci√≥n</span>';
            undoDiv.onclick = undoLastAction;
            
            // Remover bot√≥n anterior si existe
            const existing = document.getElementById('undoButton');
            if (existing) existing.remove();
            
            document.body.appendChild(undoDiv);
            
            // Auto-hide despu√©s de 8 segundos
            undoTimeout = setTimeout(() => {
                const btn = document.getElementById('undoButton');
                if (btn) {
                    btn.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => btn.remove(), 300);
                }
                lastAction = null;
            }, 8000);
        }

        function undoLastAction() {
            if (!lastAction) return;
            
            const action = lastAction;
            lastAction = null;
            
            // Remover bot√≥n
            const btn = document.getElementById('undoButton');
            if (btn) btn.remove();
            
            switch(action.type) {
                case 'CREATE_CHALLENGE': {
                    const accountIndex = data.master_comptes.findIndex(a => a.id === action.data.id);
                    if (accountIndex !== -1) {
                        const account = data.master_comptes[accountIndex];
                        data.master_comptes.splice(accountIndex, 1);
                        // Sync: remove from persistent history
                        const hi = actionHistory.challenges.map((c,i)=>({c,i})).reverse().find(({c})=>c.accountId===action.data.id);
                        if (hi !== undefined) actionHistory.challenges.splice(hi.i, 1);
                        saveData(); saveActionHistory(); updateHistoryBadge();
                        updateUI();
                        showAlert(`Challenge eliminada: ${account.accountNumber || account.id}`, 'success');
                    }
                    break;
                }
                case 'UPDATE_CHALLENGE': {
                    const updateAccount = data.master_comptes.find(a => a.id === action.data.accountId);
                    if (updateAccount) {
                        updateAccount.status = action.data.previousStatus;
                        updateAccount.lastStatusDate = action.data.previousDate;
                        updateAccount.active = action.data.previousActive;
                        // Remove the matching examen by accountId + phase (last occurrence)
                        const exPairs = data.examens.map((e, i) => ({ e, i })).reverse();
                        const exHit   = exPairs.find(({ e }) => e.accountId === action.data.accountId && e.phase === action.data.newStatus);
                        if (exHit !== undefined) data.examens.splice(exHit.i, 1);
                        // Sync: remove from persistent history
                        const si = actionHistory.statuses.map((s,i)=>({s,i})).reverse()
                            .find(({s})=>s.accountId===action.data.accountId && s.newStatus===action.data.newStatus);
                        if (si !== undefined) actionHistory.statuses.splice(si.i, 1);
                        saveData(); saveActionHistory(); updateHistoryBadge();
                        updateUI();
                        showAlert(`Estado restaurado a: ${action.data.previousStatus}`, 'success');
                    }
                    break;
                }
                case 'REGISTER_PAYOUT': {
                    const payoutIndex = data.payouts.findIndex(p => p.id === action.data.id);
                    if (payoutIndex !== -1) {
                        data.payouts.splice(payoutIndex, 1);
                        // Sync: remove from persistent history
                        const pi = actionHistory.payouts.findIndex(p => p.id === action.data.id);
                        if (pi !== -1) actionHistory.payouts.splice(pi, 1);
                        saveData(); saveActionHistory(); updateHistoryBadge();
                        updateUI();
                        showAlert(`Payout eliminado: ‚Ç¨${action.data.amount.toLocaleString()}`, 'success');
                    }
                    break;
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ HISTORY PANEL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function saveActionHistory() {
            localStorage.setItem('nqActionHistory', JSON.stringify(actionHistory));
        }

        function updateHistoryBadge() {
            const badge = document.getElementById('historyBadge');
            if (!badge) return;
            const total = actionHistory.challenges.length
                        + actionHistory.statuses.length
                        + actionHistory.payouts.length;
            badge.textContent = total;
            badge.style.display = total > 0 ? 'flex' : 'none';
        }

        function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            if (!panel) return;
            const opening = panel.classList.toggle('open');
            if (opening) renderHistoryPanel();
        }

        function renderHistoryPanel() {
            const body = document.getElementById('historyPanelBody');
            if (!body) return;

            function fmtDate(d) { return d ? d.split('-').reverse().join('/') : '‚Äî'; }

            // Section: Challenges Created
            let html = '<div class="hp-section-title">Challenges Created</div>';
            if (actionHistory.challenges.length === 0) {
                html += '<div class="hp-empty">Sin entradas</div>';
            } else {
                [...actionHistory.challenges].reverse().forEach((c, ri) => {
                    const i = actionHistory.challenges.length - 1 - ri;
                    html += `<div class="hp-entry">
                        <div class="hp-entry-info">
                            <strong>#${c.accountNumber}</strong>
                            <span>${c.propFirm} ¬∑ ${c.accountSize}</span>
                            <span>‚Ç¨${c.challengeCost.toLocaleString()} ¬∑ ${fmtDate(c.purchaseDate)}</span>
                        </div>
                        <button class="hp-del" onclick="deleteHistoryEntry('challenges',${i})" title="Deshacer creaci√≥n">‚úï</button>
                    </div>`;
                });
            }

            // Section: Status Updates
            html += '<div class="hp-section-title">Status Updates</div>';
            if (actionHistory.statuses.length === 0) {
                html += '<div class="hp-empty">Sin entradas</div>';
            } else {
                [...actionHistory.statuses].reverse().forEach((s, ri) => {
                    const i = actionHistory.statuses.length - 1 - ri;
                    html += `<div class="hp-entry">
                        <div class="hp-entry-info">
                            <strong>#${s.accountNumber}</strong>
                            <span>${s.propFirm}</span>
                            <span>${s.previousStatus} ‚Üí ${s.newStatus} ¬∑ ${fmtDate(s.statusDate)}</span>
                        </div>
                        <button class="hp-del" onclick="deleteHistoryEntry('statuses',${i})" title="Revertir estado">‚úï</button>
                    </div>`;
                });
            }

            // Section: Payouts
            html += '<div class="hp-section-title">Payouts</div>';
            if (actionHistory.payouts.length === 0) {
                html += '<div class="hp-empty">Sin entradas</div>';
            } else {
                [...actionHistory.payouts].reverse().forEach((p, ri) => {
                    const i = actionHistory.payouts.length - 1 - ri;
                    html += `<div class="hp-entry">
                        <div class="hp-entry-info">
                            <strong>#${p.accountNumber}</strong>
                            <span>${p.propFirm} ¬∑ ‚Ç¨${p.amount.toLocaleString()}</span>
                            <span>${p.status} ¬∑ ${fmtDate(p.payoutDate)}</span>
                        </div>
                        <button class="hp-del" onclick="deleteHistoryEntry('payouts',${i})" title="Eliminar payout">‚úï</button>
                    </div>`;
                });
            }

            body.innerHTML = html;
        }

        function deleteHistoryEntry(type, index) {
            if (type === 'challenges') {
                const entry = actionHistory.challenges[index];
                if (!entry) return;
                data.master_comptes = data.master_comptes.filter(a => a.id !== entry.accountId);
                data.payouts        = data.payouts.filter(p => p.accountId !== entry.accountId);
                data.examens        = data.examens.filter(e => e.accountId !== entry.accountId);
                // Also remove linked history entries
                actionHistory.statuses  = actionHistory.statuses.filter(s => s.accountId !== entry.accountId);
                actionHistory.payouts   = actionHistory.payouts.filter(p => p.accountId !== entry.accountId);
                actionHistory.challenges.splice(index, 1);
                showAlert(`Challenge eliminada: #${entry.accountNumber}`, 'success');

            } else if (type === 'statuses') {
                const entry = actionHistory.statuses[index];
                if (!entry) return;
                const account = data.master_comptes.find(a => a.id === entry.accountId);
                if (account) {
                    account.status         = entry.previousStatus;
                    account.lastStatusDate = entry.previousDate;
                    account.active         = entry.previousStatus !== 'SUSPENDED';
                    // Remove matching examen entry
                    const pairs = data.examens.map((e, i) => ({ e, i })).reverse();
                    const hit   = pairs.find(({ e }) => e.accountId === entry.accountId && e.phase === entry.newStatus);
                    if (hit !== undefined) data.examens.splice(hit.i, 1);
                }
                actionHistory.statuses.splice(index, 1);
                showAlert(`Estado revertido a: ${entry.previousStatus}`, 'success');

            } else if (type === 'payouts') {
                const entry = actionHistory.payouts[index];
                if (!entry) return;
                data.payouts = data.payouts.filter(p => p.id !== entry.id);
                actionHistory.payouts.splice(index, 1);
                showAlert(`Payout eliminado: ‚Ç¨${entry.amount.toLocaleString()}`, 'success');
            }

            saveData();
            saveActionHistory();
            updateHistoryBadge();
            renderHistoryPanel();
            updateUI();
        }

        // Modal functions
        function openResetModal() {
            $('resetModal').classList.add('active');
        }

        function closeResetModal() {
            $('resetModal').classList.remove('active');
            // Limpiar input y deshabilitar bot√≥n al cerrar
            const input = $('resetConfirmInput');
            const btn = $('confirmResetBtn');
            if (input) input.value = '';
            if (btn) { btn.disabled = true; }
        }

        function confirmReset() {
            // Doble verificaci√≥n por seguridad (adem√°s del disabled del bot√≥n)
            const input = $('resetConfirmInput');
            if (!input || input.value.toUpperCase() !== 'RESET') {
                showAlert('‚ö†Ô∏è Escribe RESET para confirmar', 'error');
                return;
            }

            // Limpiar completamente el localStorage
            localStorage.removeItem('superDashboardData');
            
            // Resetear el objeto data a vac√≠o
            data = {
                master_comptes: [],
                payouts: [],
                examens: []
            };
            
            // Cerrar modal
            closeResetModal();
            
            // Actualizar UI inmediatamente
            updateUI();
            
            showAlert('‚úÖ Todos los datos han sido eliminados', 'success');
        }

        // Export backup function
        // Mostrar alert
        function showAlert(message, type = 'success') {
            const alertContainer = $('alertContainer');
            
            // Crear el alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.innerHTML = `<span>${message}</span>`;
            
            // Limpiar alerts anteriores
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            // Auto-dismiss despu√©s de 3 segundos
            setTimeout(() => {
                alertDiv.classList.add('hiding');
                setTimeout(() => {
                    if (alertContainer.contains(alertDiv)) {
                        alertContainer.removeChild(alertDiv);
                    }
                }, 300); // Tiempo de la animaci√≥n de salida
            }, 3000);
        }

        // Crear challenge
        // === EVENTS: CREATE / UPDATE / PAYOUT ===
        function createChallenge() {
            const propFirm = document.getElementById('createPropFirm').value;
            const accountSize = document.getElementById('createAccountSize').value;
            const purchaseDate = document.getElementById('createPurchaseDate').value;
            const challengeCost = parseFloat(document.getElementById('createChallengeCost').value);
            const accountNumber = document.getElementById('createAccountNumber').value.trim();

            if (!purchaseDate || !challengeCost || !accountNumber) {
                showAlert('‚ö†Ô∏è Completa todos los campos', 'error');
                return;
            }

            // CORRECCI√ìN: Validar fecha futura
            if (new Date(purchaseDate) > new Date()) {
                showAlert('La fecha de compra no puede ser futura', 'error');
                return;
            }

            if (challengeCost <= 0) {
                showAlert('‚ö†Ô∏è El costo debe ser mayor a 0', 'error');
                return;
            }

            // CORRECCI√ìN: Validar que el accountSize sea un tama√±o reconocido
            const validSizes = ['10K', '25K', '50K', '100K', '200K'];
            if (!validSizes.includes(accountSize)) {
                showAlert('‚ö†Ô∏è Tama√±o de cuenta no v√°lido', 'error');
                return;
            }

            const year = new Date(purchaseDate).getFullYear();

            // CORRECCI√ìN: Validar duplicados solo dentro del mismo a√±o
            if (data.master_comptes.find(a => a.accountNumber === accountNumber && a.year === year)) {
                showAlert('Este n√∫mero de cuenta ya existe para el a√±o ' + year, 'error');
                return;
            }

            // Generar ID interno √∫nico
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            const firmPrefix = propFirm.substring(0, 3).toUpperCase().replace(/\s/g, '');
            const internalId = `${firmPrefix}_${timestamp}_${random}`;

            const newAccount = {
                id: internalId,                    // ID interno √∫nico
                accountNumber: accountNumber,      // N√∫mero de cuenta visible (el real de la prop firm)
                year: year,
                propFirm: propFirm,
                accountSize: accountSize,
                status: 'PHASE 1',
                purchaseDate: purchaseDate,
                challengeCost: challengeCost,
                lastStatusDate: purchaseDate,
                active: true
            };

            data.master_comptes.push(newAccount);
            saveData();

            // Push to persistent history
            actionHistory.challenges.push({
                accountId:     internalId,
                accountNumber: accountNumber,
                propFirm:      propFirm,
                accountSize:   accountSize,
                challengeCost: challengeCost,
                purchaseDate:  purchaseDate
            });
            if (actionHistory.challenges.length > 20) actionHistory.challenges.shift();
            saveActionHistory();
            updateHistoryBadge();

            // Guardar para deshacer
            saveLastAction('CREATE_CHALLENGE', {
                id: internalId,
                accountNumber: accountNumber
            });
            
            showAlert(`Challenge creada exitosamente: ${accountNumber} (${propFirm} - ${accountSize})`, 'success');
            
            // Limpiar campos
            document.getElementById('createChallengeCost').value = '';
            document.getElementById('createAccountNumber').value = '';
            
            updateUI();
        }

        // ‚îÄ‚îÄ‚îÄ STATUS TRANSITION SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const STATUS_TRANSITIONS = {
            "PHASE 1":  ["PHASE 2", "SUSPENDED"],
            "PHASE 2":  ["FUNDED",  "SUSPENDED"],
            "FUNDED":   ["SUSPENDED"],
            "SUSPENDED": []
        };

        const STATUS_COLORS = {
            "PHASE 1":  "#3498DB",
            "PHASE 2":  "#F39C12",
            "FUNDED":   "#2ECC71",
            "SUSPENDED":"#E74C3C"
        };

        function onUpdateAccountChange() {
            const accountId = document.getElementById('updateAccountId').value;
            const statusSelect = document.getElementById('updateNewStatus');
            const hint = document.getElementById('statusTransitionHint');

            if (!accountId) {
                statusSelect.innerHTML = '';
                statusSelect.disabled = true;
                hint.textContent = '';
                return;
            }

            const account = data.master_comptes.find(a => a.id === accountId);
            if (!account) return;

            const currentStatus = account.status;
            const allowed = STATUS_TRANSITIONS[currentStatus] || [];

            if (allowed.length === 0) {
                // Terminal state
                statusSelect.innerHTML = '<option>SUSPENDED</option>';
                statusSelect.disabled = true;
                hint.innerHTML = `<span style="color: #E74C3C;">‚õî SUSPENDED ‚Äî Final state. No further transitions allowed.</span>`;
            } else {
                statusSelect.disabled = false;
                statusSelect.innerHTML = allowed.map(s =>
                    `<option value="${s}">${s}</option>`
                ).join('');

                // Build hint badges
                const badges = allowed.map(s =>
                    `<span style="background: ${STATUS_COLORS[s]}22; color: ${STATUS_COLORS[s]}; border: 1px solid ${STATUS_COLORS[s]}55; border-radius: 4px; padding: 1px 7px;">${s}</span>`
                ).join(' ');
                hint.innerHTML = `<span style="color: ${STATUS_COLORS[currentStatus]};">${currentStatus}</span> ‚Üí ${badges}`;
            }
        }

        // Update challenge
        function updateChallenge() {
            const accountId = document.getElementById('updateAccountId').value;
            const newStatus = document.getElementById('updateNewStatus').value;
            const statusDate = document.getElementById('updateStatusDate').value;

            if (!accountId || !statusDate) {
                showAlert('‚ö†Ô∏è Selecciona una cuenta y fecha', 'error');
                return;
            }

            // CORRECCI√ìN: Validar fecha futura
            if (new Date(statusDate) > new Date()) {
                showAlert('La fecha de estado no puede ser futura', 'error');
                return;
            }

            const account = data.master_comptes.find(a => a.id === accountId);
            if (account) {
                // ‚îÄ‚îÄ‚îÄ STRICT TRANSITION VALIDATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const currentStatus = account.status;
                const allowedNext = STATUS_TRANSITIONS[currentStatus] || [];

                if (allowedNext.length === 0) {
                    showAlert(`‚õî SUSPENDED ‚Äî Final state. No further transitions allowed.`, 'error');
                    return;
                }
                if (!allowedNext.includes(newStatus)) {
                    showAlert(`‚õî Transition not allowed: ${currentStatus} ‚Üí ${newStatus}`, 'error');
                    return;
                }
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                // Guardar estado anterior para deshacer
                const previousStatus = account.status;
                const previousDate = account.lastStatusDate;
                const previousActive = account.active;

                account.status = newStatus;
                account.lastStatusDate = statusDate;
                account.active = newStatus !== 'SUSPENDED';
                
                // Registrar en examens
                data.examens.push({
                    id: `EX${data.examens.length + 1}`,
                    accountId: accountId,
                    phase: newStatus,
                    statusDate: statusDate
                });
                
                saveData();

                // Push to persistent history
                actionHistory.statuses.push({
                    accountId:      accountId,
                    accountNumber:  account.accountNumber || account.id,
                    propFirm:       account.propFirm || '',
                    previousStatus: previousStatus,
                    previousDate:   previousDate,
                    newStatus:      newStatus,
                    statusDate:     statusDate
                });
                if (actionHistory.statuses.length > 20) actionHistory.statuses.shift();
                saveActionHistory();
                updateHistoryBadge();

                // Guardar para deshacer
                saveLastAction('UPDATE_CHALLENGE', {
                    accountId: accountId,
                    previousStatus: previousStatus,
                    previousDate: previousDate,
                    previousActive: previousActive,
                    newStatus: newStatus
                });
                
                const displayNumber = account.accountNumber || account.id;
                showAlert(`Estado actualizado: ${displayNumber} ‚Üí ${newStatus}`, 'success');
                updateUI();
            }
        }

        // Register payout
        function registerPayout() {
            const accountId = document.getElementById('payoutAccountId').value;
            const amount = parseFloat(document.getElementById('payoutAmount').value);
            const payoutDate = document.getElementById('payoutDate').value;
            const status = document.getElementById('payoutStatus').value;

            if (!accountId || !amount || !payoutDate || !status) {
                showAlert('‚ö†Ô∏è Completa todos los campos', 'error');
                return;
            }

            // CORRECCI√ìN: Validar fecha futura
            if (new Date(payoutDate) > new Date()) {
                showAlert('La fecha de payout no puede ser futura', 'error');
                return;
            }

            if (amount <= 0) {
                showAlert('‚ö†Ô∏è El monto debe ser mayor a 0', 'error');
                return;
            }

            // CORRECCI√ìN: Validar que el payout no sea absurdamente alto (>200K‚Ç¨ en una sola operaci√≥n)
            const account = data.master_comptes.find(a => a.id === accountId);
            if (account) {
                const accountSizeNum = parseInt(account.accountSize.replace('K', '')) * 1000;
                if (amount > accountSizeNum * 2) {
                    showAlert(`‚ö†Ô∏è El payout (‚Ç¨${amount.toLocaleString()}) supera 2x el tama√±o de la cuenta (${account.accountSize}). Verifica el importe.`, 'error');
                    return;
                }
            }

            const year = new Date(payoutDate).getFullYear();
            const newPayout = {
                id: `PAY${Date.now()}`,
                accountId: accountId,
                year: year,
                payoutDate: payoutDate,
                amount: amount,
                status: status
            };

            data.payouts.push(newPayout);
            saveData();

            // Push to persistent history
            actionHistory.payouts.push({
                id:            newPayout.id,
                accountId:     accountId,
                accountNumber: account ? (account.accountNumber || account.id) : accountId,
                propFirm:      account ? (account.propFirm || '') : '',
                amount:        amount,
                payoutDate:    payoutDate,
                status:        status
            });
            if (actionHistory.payouts.length > 20) actionHistory.payouts.shift();
            saveActionHistory();
            updateHistoryBadge();

            // Guardar para deshacer
            saveLastAction('REGISTER_PAYOUT', {
                id: newPayout.id,
                amount: amount,
                accountId: accountId
            });
            
            const accountDisplay = account ? (account.accountNumber || account.id) : accountId;
            showAlert(`Payout registrado: ‚Ç¨${amount.toLocaleString()} desde ${accountDisplay}`, 'success');
            
            document.getElementById('payoutAmount').value = '';
            updateUI();
        }

        // Calculate days to funding (for efficiency dashboard)
        function calculateDaysToFunding(account) {
            const startDate = new Date(account.purchaseDate);
            const fundedDate = new Date(account.lastStatusDate);
            const diffTime = Math.abs(fundedDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // ‚îÄ‚îÄ‚îÄ TIME FILTER UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Per-view local filter state (independent, no global year)
        let performanceTimeFilter = "ALL_TIME";
        let propFirmTimeFilter    = "ALL_TIME";
        let efficiencyTimeFilter  = "ALL_TIME";
        let wrappedTimeFilter     = "ALL_TIME";

        function getAvailableYears() {
            const years = new Set();
            data.master_comptes.forEach(a => { if (a.year) years.add(a.year); });
            data.payouts.forEach(p => { if (p.year) years.add(p.year); });
            return Array.from(years).sort();
        }

        function filterByYear(arr, selectedYear) {
            if (selectedYear === "ALL_TIME") return arr;
            return arr.filter(item => item.year === parseInt(selectedYear));
        }

        function buildYearOptions(selectedYear) {
            const years = getAvailableYears();
            let opts = `<option value="ALL_TIME" ${selectedYear === "ALL_TIME" ? "selected" : ""}>All-time</option>`;
            years.forEach(y => {
                opts += `<option value="${y}" ${String(selectedYear) === String(y) ? "selected" : ""}>${y}</option>`;
            });
            return opts;
        }
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // ‚îÄ‚îÄ‚îÄ SHARED WIN-RATE HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Single source of truth used by Performance, CEO View and Wrapped Generator.
        // Phase 1 WR: accounts that cleared Phase 1 (now in PHASE 2 or FUNDED) / total
        // Phase 2 WR: FUNDED / accounts that reached Phase 2 (PHASE 2 + FUNDED)
        function calcWinRates(accounts) {
            const total      = accounts.length;
            const funded     = accounts.filter(a => a.status === 'FUNDED').length;
            const inPhase2   = accounts.filter(a => a.status === 'PHASE 2').length;
            const passedP1   = inPhase2 + funded;   // cleared Phase 1
            const p1Rate     = total    > 0 ? (passedP1 / total   * 100) : 0;
            const p2Rate     = passedP1 > 0 ? (funded   / passedP1 * 100) : 0;
            return { phase1: p1Rate, phase2: p2Rate, passedPhase1: passedP1, fundedCount: funded, inPhase2 };
        }

        // Render Overview
        // === RENDER: OVERVIEW ===
        function renderOverview() {
            const yearAccounts = data.master_comptes;
            const yearPayouts  = data.payouts;

            const activeFunded = yearAccounts.filter(a => a.status === 'FUNDED' && a.active).length;
            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalCosts = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const netProfit = totalPayouts - totalCosts;
            // BUG FIX: si no hay payouts todav√≠a, ROI = 0% (no mostrar -100% desde el inicio)
            const roi = (totalCosts > 0 && totalPayouts > 0) ? ((totalPayouts - totalCosts) / totalCosts * 100) : 0;

            // Capital actiu fondejat (suma dels sizes dels comptes FUNDED actius)
            const activeFundedCapital = yearAccounts
                .filter(a => a.status === 'FUNDED' && a.active)
                .reduce((sum, a) => {
                    const sizeNum = parseInt(a.accountSize.replace('K', '')) * 1000;
                    return sum + sizeNum;
                }, 0);

            const activeAccountsOnly = yearAccounts.filter(a => a.active);
            const suspendedCount = yearAccounts.filter(a => a.status === 'SUSPENDED').length;
            // statusCounts usa solo cuentas activas (consistente con el gr√°fico donut)
            const statusCounts = {
                'FUNDED': activeAccountsOnly.filter(a => a.status === 'FUNDED').length,
                'PHASE 1': activeAccountsOnly.filter(a => a.status === 'PHASE 1').length,
                'PHASE 2': activeAccountsOnly.filter(a => a.status === 'PHASE 2').length
            };

            const activeStatusCounts = {
                'FUNDED': statusCounts['FUNDED'],
                'PHASE 1': statusCounts['PHASE 1'],
                'PHASE 2': statusCounts['PHASE 2']
            };

            const overviewHtml = `
                <div class="dashboard-header">
                    <h2>OVERVIEW</h2>
                    <span class="view-label">${t('viewAllTime')}</span>
                    <div class="subtitle" style="margin-top:0.5rem;">${t('updated')} ${new Date().toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', year: 'numeric' })}</div>
                </div>

                <!-- NET P&L HERO CARD -->
                <div class="kpi-card" style="background: linear-gradient(135deg, ${netProfit >= 0 ? 'rgba(46,204,113,0.08), rgba(39,174,96,0.04)' : 'rgba(231,76,60,0.08), rgba(192,57,43,0.04)'}); border: 1px solid ${netProfit >= 0 ? 'rgba(46,204,113,0.25)' : 'rgba(231,76,60,0.25)'}; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; padding: 1.5rem 2rem;">
                    <div>
                        <div class="kpi-label" style="font-size: 0.7rem; letter-spacing: 0.12em; margin-bottom: 0.4rem;">${currentLanguage === 'en' ? 'NET BUSINESS PROFIT' : 'BENEFICIO NETO DEL NEGOCIO'}</div>
                        <div style="font-size: 2.4rem; font-weight: 800; color: ${netProfit >= 0 ? '#2ECC71' : '#E74C3C'}; line-height: 1;">${netProfit >= 0 ? '+' : ''}${netProfit.toLocaleString()} ‚Ç¨</div>
                        <div class="kpi-subtitle" style="margin-top: 0.4rem;">${currentLanguage === 'en' ? 'After deducting' : 'Tras descontar'} ${totalCosts.toLocaleString()} ‚Ç¨ ${currentLanguage === 'en' ? 'in costs' : 'en costes'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="kpi-label" style="font-size: 0.7rem; letter-spacing: 0.12em; margin-bottom: 0.4rem;">ROI TOTAL</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: ${roi > 0 ? '#2ECC71' : roi < 0 ? '#E74C3C' : '#9AA0A6'};">${roi > 0 ? '+' : ''}${roi.toFixed(1)}%</div>
                        <div class="kpi-subtitle" style="margin-top: 0.4rem;">${yearPayouts.length} ${t('payments')}</div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Active Funded Capital</div>
                        <div class="kpi-value success">${(activeFundedCapital).toLocaleString()} ‚Ç¨</div>
                        <div class="kpi-subtitle">${activeFunded} ${t('fundedAccounts')}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Total Payouts</div>
                        <div class="kpi-value success">${totalPayouts.toLocaleString()} ‚Ç¨</div>
                        <div class="kpi-subtitle">${yearPayouts.length} ${t('payments')}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${currentLanguage === 'en' ? 'Total Invested' : 'Total Invertido'}</div>
                        <div class="kpi-value danger">${totalCosts.toLocaleString()} ‚Ç¨</div>
                        <div class="kpi-subtitle">${yearAccounts.length} ${t('total')} ${currentLanguage === 'en' ? 'accounts' : 'cuentas'}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Active Funded Accounts</div>
                        <div class="kpi-value">${activeFunded}</div>
                        <div class="kpi-subtitle">${t('of')} ${yearAccounts.length} ${t('total')}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">‚óá ACCOUNT STATUS</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Count</th>
                                    <th>${t('colPctActive')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span class="status-badge funded">FUNDED</span></td>
                                    <td>${statusCounts.FUNDED}</td>
                                    <td>${activeAccountsOnly.length > 0 ? ((statusCounts.FUNDED / activeAccountsOnly.length) * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr>
                                    <td><span class="status-badge phase1">PHASE 1</span></td>
                                    <td>${statusCounts['PHASE 1']}</td>
                                    <td>${activeAccountsOnly.length > 0 ? ((statusCounts['PHASE 1'] / activeAccountsOnly.length) * 100).toFixed(1) : 0}%</td>
                                </tr>
                                <tr>
                                    <td><span class="status-badge phase2">PHASE 2</span></td>
                                    <td>${statusCounts['PHASE 2']}</td>
                                    <td>${activeAccountsOnly.length > 0 ? ((statusCounts['PHASE 2'] / activeAccountsOnly.length) * 100).toFixed(1) : 0}%</td>
                                </tr>
                                ${suspendedCount > 0 ? `
                                <tr style="opacity: 0.5;">
                                    <td><span class="status-badge suspended">SUSPENDED</span></td>
                                    <td>${suspendedCount}</td>
                                    <td style="color: #9AA0A6; font-style: italic;">${t('closedAccounts')}</td>
                                </tr>` : ''}
                            </tbody>
                        </table>
                        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #9AA0A6;">
                            ${t('totalActive')}: ${activeAccountsOnly.length} ¬∑ ${suspendedCount > 0 ? `${suspendedCount} ${t('suspended')}${suspendedCount > 1 ? 's' : ''} ${suspendedCount > 1 ? t('excludedFemPl') : t('excludedFemSg')}` : t('noSuspended')}
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">Active Accounts</h3>
                        <div class="chart-container">
                            <canvas id="activeAccountsChart"></canvas>
                        </div>
                        <div style="text-align: center; margin-top: 1rem; color: #9AA0A6; font-size: 0.85rem;">
                            Total: ${activeAccountsOnly.length}
                        </div>
                    </div>
                </div>
            `;

            // A√±adir tabla de cuentas individuales al HTML
            let accountsTableHtml = '';
            if (yearAccounts.length > 0) {
                const rows = yearAccounts
                    .sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate))
                    .map(acc => {
                        const statusClass = acc.status === 'FUNDED' ? 'funded'
                            : acc.status === 'PHASE 1' ? 'phase1'
                            : acc.status === 'PHASE 2' ? 'phase2' : 'suspended';
                        const payoutsForAcc = data.payouts
                            .filter(p => p.accountId === acc.id)
                            .reduce((s, p) => s + p.amount, 0);
                        const rowStyle = !acc.active ? 'opacity:0.5;' : '';
                        let row = '<tr style="' + rowStyle + '">'
                            + '<td style="font-weight:700;">' + acc.accountNumber + '</td>'
                            + '<td>' + acc.propFirm + '</td>'
                            + '<td style="font-weight:600;">' + acc.accountSize + '</td>'
                            + '<td><span class="status-badge ' + statusClass + '">' + acc.status + '</span></td>'
                            + '<td style="color:#E74C3C;">-‚Ç¨' + acc.challengeCost.toLocaleString() + '</td>'
                            + '<td style="color:#9AA0A6;">' + new Date(acc.purchaseDate).toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES') + '</td>'
                            + '</tr>';
                        if (payoutsForAcc > 0) {
                            row += '<tr style="background:rgba(46,204,113,0.03);' + rowStyle + '">'
                                + '<td colspan="4" style="padding-top:0.3rem;padding-bottom:0.5rem;color:#9AA0A6;font-size:0.8rem;padding-left:2.5rem;">' + t('payoutsReceived') + '</td>'
                                + '<td style="color:#2ECC71;padding-top:0.3rem;padding-bottom:0.5rem;">+‚Ç¨' + payoutsForAcc.toLocaleString() + '</td>'
                                + '<td></td></tr>';
                        }
                        return row;
                    }).join('');

                accountsTableHtml = '<div class="table-container" style="margin-top:1.5rem;">'
                    + '<h3 style="margin-bottom:1rem;font-size:1.1rem;font-weight:700;">' + t('myAccounts') + '</h3>'
                    + '<table><thead><tr>'
                    + '<th>' + t('colAccount') + '</th><th>Prop Firm</th><th>' + t('colSize') + '</th><th>Status</th><th>' + t('colCost') + '</th><th>' + t('colDate') + '</th>'
                    + '</tr></thead><tbody>' + rows + '</tbody></table></div>';
            }

            document.getElementById('overview').innerHTML = overviewHtml + accountsTableHtml;

            // Create donut chart (o empty state si no hay cuentas)
            const ctx = document.getElementById('activeAccountsChart');
            if (ctx && activeAccountsOnly.length === 0) {
                ctx.closest('.table-container').querySelector('.chart-container').innerHTML =
                    '<div style="text-align:center;padding:2rem;color:#9AA0A6;"><div style="font-size:2rem;margin-bottom:0.5rem;">üìã</div><div>' + t('noActiveAccounts') + '</div></div>';
            } else if (ctx && activeAccountsOnly.length > 0) {
                if (window.activeChart && typeof window.activeChart.destroy === 'function') {
                    window.activeChart.destroy();
                }

                window.activeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['FUNDED', 'PHASE 1', 'PHASE 2'],
                        datasets: [{
                            data: [
                                activeStatusCounts.FUNDED,
                                activeStatusCounts['PHASE 1'],
                                activeStatusCounts['PHASE 2']
                            ],
                            backgroundColor: ['#2ECC71', '#3498DB', '#F39C12'],
                            borderColor: '#121417',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#E6E8EB',
                                    font: { family: 'Inter', size: 12, weight: '600' },
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
        }

        // Render Performance
        // === RENDER: PERFORMANCE ===
        function renderPerformance() {
            const yearAccounts = filterByYear(data.master_comptes, performanceTimeFilter);
            const yearPayouts  = filterByYear(data.payouts, performanceTimeFilter);
            
            const totalChallenges = yearAccounts.length;
            const phase1CurrentCount = yearAccounts.filter(a => a.status === 'PHASE 1').length;
            const phase2CurrentCount = yearAccounts.filter(a => a.status === 'PHASE 2').length;
            const suspendedCount = yearAccounts.filter(a => a.status === 'SUSPENDED').length;

            const { phase1: phase1WinRate, phase2: phase2WinRate, passedPhase1, fundedCount } = calcWinRates(yearAccounts);
            
            const totalCosts = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const avgCostPerFunded = fundedCount > 0 ? totalCosts / fundedCount : 0;
            // BUG FIX: ROI no debe ser negativo si no hay payouts todav√≠a
            const performanceRoi = (totalCosts > 0 && totalPayouts > 0) ? ((totalPayouts - totalCosts) / totalCosts * 100) : 0;
            
            // ROI per prop firm
            const propFirms = ['FTMO', 'Alpha Capital Group', 'Orion Funded', 'Bullfy', 'FundedNext', 'The5ers', 'MyForexFunds'];
            const roiByFirm = propFirms.map(firm => {
                const firmAccounts = yearAccounts.filter(a => a.propFirm === firm);
                const firmCosts = firmAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
                const firmAccountIds = firmAccounts.map(a => a.id);
                const firmPayouts = yearPayouts.filter(p => firmAccountIds.includes(p.accountId))
                    .reduce((sum, p) => sum + p.amount, 0);
                const roi = firmCosts > 0 ? ((firmPayouts - firmCosts) / firmCosts * 100) : 0;
                return { firm, roi, payouts: firmPayouts, costs: firmCosts };
            }).filter(f => f.costs > 0).sort((a, b) => b.roi - a.roi);

            const bestFirm = roiByFirm[0] || { firm: 'N/A', roi: 0 };

            const performanceHtml = `
                <div class="view-header">
                    <h2>PERFORMANCE</h2>
                    ${totalChallenges === 0 ? `<div style="padding:0.5rem;color:#F39C12;font-size:0.85rem;">${t('noChallenges')}</div>` : ''}
                    <div class="subtitle">${t('updated')} ${new Date().toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', year: 'numeric' })}</div>
                    <div class="time-filter">
                        <select id="performanceTimeFilter" onchange="performanceTimeFilter=this.value;renderPerformance();">
                            ${buildYearOptions(performanceTimeFilter)}
                        </select>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">${t('phase1WinRate')}</div>
                        <div class="kpi-value success">${phase1WinRate.toFixed(0)}%</div>
                        <div class="kpi-subtitle">${passedPhase1} ${t('of')} ${totalChallenges}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('phase2WinRate')}</div>
                        <div class="kpi-value success">${phase2WinRate.toFixed(0)}%</div>
                        <div class="kpi-subtitle">${fundedCount} funded</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">AVG. COST PER FUNDED ACCOUNT</div>
                        <div class="kpi-value">${avgCostPerFunded.toFixed(0)} ‚Ç¨</div>
                        <div class="kpi-subtitle">Total costs: ${totalCosts.toLocaleString()}‚Ç¨</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">BEST PROP FIRM ROI</div>
                        <div class="kpi-value success">${bestFirm.firm}</div>
                        <div class="kpi-subtitle">+${bestFirm.roi.toFixed(0)}%</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">‚óá CHALLENGE SUCCESS RATE</h3>
                        
                        <div class="bar-chart">
                            <div class="bar-row">
                                <div class="bar-label">PHASE 1</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${phase1WinRate}%; background: linear-gradient(90deg, #F39C12, #E67E22);">
                                        ${phase1WinRate > 15 ? '<span class="bar-value">' + phase1WinRate.toFixed(0) + '%</span>' : ''}
                                    </div>
                                </div>
                                <div class="bar-count">${phase1WinRate.toFixed(0)}%</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">PHASE 2</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${phase2WinRate}%; background: linear-gradient(90deg, #2ECC71, #27AE60);">
                                        ${phase2WinRate > 15 ? '<span class="bar-value">' + phase2WinRate.toFixed(0) + '%</span>' : ''}
                                    </div>
                                </div>
                                <div class="bar-count">${phase2WinRate.toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">APPROVAL RATE</h3>
                        
                        <div style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 1rem;">
                                <div class="kpi-value success" style="font-size: 3rem;">${totalChallenges}</div>
                                <div style="color: #9AA0A6; margin-top: 0.5rem;">Challenges Totales</div>
                            </div>
                            
                            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1.5rem 0;">
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">En Phase 1</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700;">${phase1CurrentCount}</div>
                                    <div style="color: #9AA0A6; font-size: 0.75rem;">actual</div>
                                </div>
                                
                                <div style="color: #2ECC71; font-size: 1.5rem;">‚Üí</div>
                                
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">Pasaron P1</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700; color: #F39C12;">${passedPhase1}</div>
                                    <div style="color: #F39C12; font-size: 0.75rem;">${phase1WinRate.toFixed(0)}%</div>
                                </div>
                                
                                <div style="color: #2ECC71; font-size: 1.5rem;">‚Üí</div>
                                
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">En Phase 2</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700;">${phase2CurrentCount}</div>
                                    <div style="color: #9AA0A6; font-size: 0.75rem;">actual</div>
                                </div>
                                
                                <div style="color: #2ECC71; font-size: 1.5rem;">‚Üí</div>
                                
                                <div style="text-align: center;">
                                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 0.25rem;">Funded</div>
                                    <div style="font-family: 'Inter', sans-serif; font-size: 1.2rem; font-weight: 700; color: #2ECC71;">${fundedCount}</div>
                                    <div style="color: #2ECC71; font-size: 0.75rem;">${phase2WinRate.toFixed(0)}%</div>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(230, 232, 235, 0.1);">
                                <div style="color: #9AA0A6; font-size: 0.85rem; margin-bottom: 0.5rem;">Resumen:</div>
                                <div style="color: #9AA0A6; font-size: 0.8rem;">
                                    ${phase1WinRate.toFixed(0)}% supera Phase 1 ¬∑ ${phase2WinRate.toFixed(0)}% supera Phase 2 ¬∑ ${fundedCount} Cuentas Fondeadas
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">‚óá ROI BY PROP FIRM</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div class="chart-container" style="max-width: none;">
                            <canvas id="roiLineChart"></canvas>
                        </div>
                        <div class="chart-container" style="max-width: none;">
                            <canvas id="roiBarChart"></canvas>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('performance').innerHTML = performanceHtml;

            // ROI Line Chart
            const lineCtx = document.getElementById('roiLineChart');
            if (lineCtx && roiByFirm.length > 0) {
                if (window.roiLineChart && typeof window.roiLineChart.destroy === 'function') {
                    window.roiLineChart.destroy();
                }

                window.roiLineChart = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: roiByFirm.map(f => f.firm),
                        datasets: [{
                            label: 'ROI %',
                            data: roiByFirm.map(f => f.roi),
                            borderColor: '#2ECC71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#2ECC71',
                            pointBorderColor: '#121417',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                titleColor: '#E6E8EB',
                                bodyColor: '#E6E8EB',
                                callbacks: {
                                    label: (context) => `+${context.parsed.y.toFixed(0)}%`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => value + '%'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }

            // ROI Bar Chart
            const barCtx = document.getElementById('roiBarChart');
            if (barCtx && roiByFirm.length > 0) {
                if (window.roiBarChart && typeof window.roiBarChart.destroy === 'function') {
                    window.roiBarChart.destroy();
                }

                window.roiBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: roiByFirm.map(f => f.firm),
                        datasets: [{
                            data: roiByFirm.map(f => f.roi),
                            backgroundColor: ['#2ECC71', '#9AA0A6', '#F39C12'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (context) => `+${context.parsed.y.toFixed(0)}%`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => value + '%'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        // CONFIGURACI√ìN DE PROP FIRMS CON REGLAS REALES (2025)
        const PROP_FIRMS_CONFIG = {
            'FTMO': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80-90%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Restricci√≥n 2min antes/despu√©s (Standard)',
                note_funded: 'Sin restricci√≥n en Swing Account',
                minTradingDays: 4
            },
            'Alpha Capital Group': {
                profitTarget_P1: 8,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Trades 2min antes/despu√©s deben durar +2min',
                minTradingDays: 3
            },
            'The5ers': {
                profitTarget_P1: 8,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80-100%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Permitido sin restricciones',
                note_funded: 'Escalado progresivo hasta 100% profit split'
            },
            'FundedNext': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80-95%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Permitido sin restricciones',
                minTradingDays: 0
            },
            'Orion Funded': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Consultar reglas espec√≠ficas',
                minTradingDays: 3
            },
            'Bullfy': {
                profitTarget_P1: 10,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 10,
                split: '80%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Consultar reglas espec√≠ficas',
                minTradingDays: 3
            },
            'MyForexFunds': {
                profitTarget_P1: 8,
                profitTarget_P2: 5,
                maxDailyLoss: 5,
                maxLoss: 12,
                split: '75-85%',
                newsTrading_Challenge: 'Permitido sin restricciones',
                newsTrading_Funded: 'Firma temporalmente cerrada',
                note: '‚ö†Ô∏è CERRADA desde 2023 - Reapertura esperada 2026',
                minTradingDays: 3
            }
        };

        // Render Prop Firm View
        // === RENDER: PROP FIRM VIEW ===
        function renderPropFirm() {
            // Get selected firm from dropdown if it exists, otherwise default to FTMO
            const firmSelector = document.getElementById('firmSelector');
            const selectedFirm = firmSelector ? firmSelector.value : 'FTMO';

            // CORRECCI√ìN: Obtener configuraci√≥n de la firma
            const firmConfig = PROP_FIRMS_CONFIG[selectedFirm] || PROP_FIRMS_CONFIG['FTMO'];

            const yearAccounts = filterByYear(data.master_comptes, propFirmTimeFilter).filter(a => a.propFirm === selectedFirm);
            const yearPayouts  = filterByYear(data.payouts, propFirmTimeFilter).filter(p => {
                const account = data.master_comptes.find(a => a.id === p.accountId);
                return account && account.propFirm === selectedFirm;
            });

            const totalInvested = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const challengesBought = yearAccounts.length;
            const cuentasFunded = yearAccounts.filter(a => a.status === 'FUNDED').length;
            const roi = totalInvested > 0 ? ((totalPayouts - totalInvested) / totalInvested * 100) : 0;

            const statusCounts = {
                'FUNDED': yearAccounts.filter(a => a.status === 'FUNDED').length,
                'PHASE 1': yearAccounts.filter(a => a.status === 'PHASE 1').length,
                'PHASE 2': yearAccounts.filter(a => a.status === 'PHASE 2').length,
                'SUSPENDED': yearAccounts.filter(a => a.status === 'SUSPENDED').length
            };

            const propFirmHtml = `
                <div class="view-header">
                    <h2>PROP FIRM ¬∑ ${selectedFirm}</h2>
                    ${yearAccounts.length === 0 ? `<div style="display:inline-block;padding:0.25rem 0.75rem;background:rgba(243,156,18,0.1);border-radius:6px;color:#F39C12;font-size:0.8rem;margin-top:0.5rem;">${t('propFirmNoAccounts').replace('{firm}', selectedFirm)}</div>` : ''}
                    <div class="subtitle">${t('rendimiento')} ¬∑ ${t('updated')} ${new Date().toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', year: 'numeric' })}</div>
                    <div class="time-filter">
                        <select id="propFirmTimeFilter" onchange="propFirmTimeFilter=this.value;renderPropFirm();">
                            ${buildYearOptions(propFirmTimeFilter)}
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <select id="firmSelector" style="padding: 0.75rem 1.5rem; background: #181B20; border: 1px solid rgba(230, 232, 235, 0.1); border-radius: 8px; color: #E6E8EB; font-size: 0.95rem; font-weight: 600;">
                        <option value="FTMO" ${selectedFirm === 'FTMO' ? 'selected' : ''}>FTMO</option>
                        <option value="Alpha Capital Group" ${selectedFirm === 'Alpha Capital Group' ? 'selected' : ''}>Alpha Capital Group</option>
                        <option value="Orion Funded" ${selectedFirm === 'Orion Funded' ? 'selected' : ''}>Orion Funded</option>
                        <option value="Bullfy" ${selectedFirm === 'Bullfy' ? 'selected' : ''}>Bullfy</option>
                        <option value="FundedNext" ${selectedFirm === 'FundedNext' ? 'selected' : ''}>FundedNext</option>
                        <option value="The5ers" ${selectedFirm === 'The5ers' ? 'selected' : ''}>The5ers</option>
                        <option value="MyForexFunds" ${selectedFirm === 'MyForexFunds' ? 'selected' : ''}>MyForexFunds</option>
                    </select>
                    <span style="margin-left: 2rem; color: #9AA0A6; font-size: 0.8rem;">P1: ${firmConfig.profitTarget_P1}% target ¬∑ Max loss: ${firmConfig.maxLoss}%</span>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">‚óá CHALLENGES COMPRADAS</div>
                        <div class="kpi-value">${challengesBought}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">CUENTAS FONDEADAS</div>
                        <div class="kpi-value success">${cuentasFunded}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">‚Ç¨ INVERTIDO</div>
                        <div class="kpi-value">‚Ç¨${totalInvested.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">‚Ç¨ PAYOUTS</div>
                        <div class="kpi-value success">‚Ç¨${totalPayouts.toLocaleString()}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">‚óá ACCOUNT STATUS</h3>
                        
                        <div class="bar-chart">
                            <div class="bar-row">
                                <div class="bar-label">FUNDED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${challengesBought > 0 ? (statusCounts.FUNDED / challengesBought * 100) : 0}%; background: linear-gradient(90deg, #2ECC71, #27AE60);"></div>
                                </div>
                                <div class="bar-count">${statusCounts.FUNDED}</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">PHASE 1</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${challengesBought > 0 ? (statusCounts['PHASE 1'] / challengesBought * 100) : 0}%; background: linear-gradient(90deg, #F39C12, #E67E22);"></div>
                                </div>
                                <div class="bar-count">${statusCounts['PHASE 1']}</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">SUSPENDED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${challengesBought > 0 ? (statusCounts.SUSPENDED / challengesBought * 100) : 0}%; background: linear-gradient(90deg, #9AA0A6, #7F8C8D);"></div>
                                </div>
                                <div class="bar-count">${statusCounts.SUSPENDED}</div>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label">ROI</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value success" style="font-size: 3.5rem;">+${roi.toFixed(0)}%</div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">‚óá REGLAS DE ${selectedFirm.toUpperCase()}</h3>
                    <ul style="list-style: none; padding: 0; color: #9AA0A6; line-height: 2;">
                        <li>‚Ä¢ <strong>Phase 1:</strong> ${firmConfig.profitTarget_P1}% profit target</li>
                        <li>‚Ä¢ <strong>Phase 2:</strong> ${firmConfig.profitTarget_P2}% profit target</li>
                        <li>‚Ä¢ <strong>Max Daily Loss:</strong> ${firmConfig.maxDailyLoss}%</li>
                        <li>‚Ä¢ <strong>Max Loss:</strong> ${firmConfig.maxLoss}%</li>
                        <li>‚Ä¢ <strong>Profit Split:</strong> ${firmConfig.split}</li>
                        ${firmConfig.minTradingDays ? `<li>‚Ä¢ <strong>Min Trading Days:</strong> ${firmConfig.minTradingDays}</li>` : ''}
                        <li style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(230,232,235,0.1);">
                            <strong>üì∞ News Trading (Challenge):</strong><br/>
                            <span style="font-size: 0.9rem;">${firmConfig.newsTrading_Challenge}</span>
                        </li>
                        <li style="margin-top: 0.5rem;">
                            <strong>üì∞ News Trading (Funded):</strong><br/>
                            <span style="font-size: 0.9rem;">${firmConfig.newsTrading_Funded}</span>
                        </li>
                        ${firmConfig.note ? 
                            `<li style="margin-top: 0.75rem; font-size: 0.85rem; color: #F39C12; padding: 0.5rem; background: rgba(243,156,18,0.1); border-radius: 6px;">
                                ${firmConfig.note}
                            </li>` : ''}
                        ${firmConfig.note_funded && !firmConfig.note ? 
                            `<li style="margin-top: 0.75rem; font-size: 0.85rem; color: #2ECC71;">
                                <strong>üí° Nota:</strong> ${firmConfig.note_funded}
                            </li>` : ''}
                    </ul>
                </div>
            `;

            document.getElementById('propfirm').innerHTML = propFirmHtml;

            // Re-attach event listener after re-rendering
            setTimeout(() => {
                const newSelector = document.getElementById('firmSelector');
                if (newSelector) {
                    newSelector.addEventListener('change', renderPropFirm);
                }
            }, 0);
        }

        // Render CEO View
        // === RENDER: CEO VIEW ===
        function renderCEOView() {
            // All-time stats across all years
            const allAccounts = data.master_comptes;
            const allPayouts = data.payouts;

            const totalPayouts = allPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalInvested = allAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const capitalMultiple = totalInvested > 0 ? totalPayouts / totalInvested : 0;

            // Group by year
            const years = [...new Set(allAccounts.map(a => a.year))].sort();
            const yearlyPayouts = years.map(year => {
                return allPayouts.filter(p => p.year === year).reduce((sum, p) => sum + p.amount, 0);
            });

            const bestYear = years[yearlyPayouts.indexOf(Math.max(...yearlyPayouts))] || 'N/A';

            // ‚îÄ‚îÄ M√âTRICAS DEL ARRAY EXAMENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Intentos promedio hasta fondear (n¬∫ de cambios de fase por cuenta fondeada)
            const fundedAccountsAll = allAccounts.filter(a => a.status === 'FUNDED');
            let avgAttemptsToFund = 0;
            if (fundedAccountsAll.length > 0 && data.examens.length > 0) {
                const attemptsPerAccount = fundedAccountsAll.map(acc => {
                    return data.examens.filter(e => e.accountId === acc.id).length || 1;
                });
                avgAttemptsToFund = attemptsPerAccount.reduce((s, v) => s + v, 0) / fundedAccountsAll.length;
            }

            // Tiempo promedio en Phase 1 (d√≠as entre P1 y P2 en el historial de examens)
            let avgDaysPhase1 = 0;
            let avgDaysPhase2 = 0;
            if (data.examens.length > 0) {
                const phase2Events = data.examens.filter(e => e.phase === 'PHASE 2');
                const fundedEvents = data.examens.filter(e => e.phase === 'FUNDED');

                // Para cada cuenta, buscar transici√≥n P1‚ÜíP2
                const p1Durations = [];
                phase2Events.forEach(ev2 => {
                    const account = allAccounts.find(a => a.id === ev2.accountId);
                    if (account && account.purchaseDate) {
                        const days = Math.round((new Date(ev2.statusDate) - new Date(account.purchaseDate)) / 86400000);
                        if (days > 0 && days < 365) p1Durations.push(days);
                    }
                });
                if (p1Durations.length > 0) avgDaysPhase1 = p1Durations.reduce((s, v) => s + v, 0) / p1Durations.length;

                // Para cada cuenta, buscar transici√≥n P2‚ÜíFUNDED
                const p2Durations = [];
                fundedEvents.forEach(evF => {
                    const lastP2 = [...data.examens]
                        .filter(e => e.accountId === evF.accountId && e.phase === 'PHASE 2')
                        .sort((a, b) => new Date(b.statusDate) - new Date(a.statusDate))[0];
                    if (lastP2) {
                        const days = Math.round((new Date(evF.statusDate) - new Date(lastP2.statusDate)) / 86400000);
                        if (days > 0 && days < 365) p2Durations.push(days);
                    }
                });
                if (p2Durations.length > 0) avgDaysPhase2 = p2Durations.reduce((s, v) => s + v, 0) / p2Durations.length;
            }

            const hasExamenData = data.examens.length > 0;
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            const ceoViewHtml = `
                <div class="dashboard-header">
                    <h2>CEO VIEW ¬∑ ALL TIME</h2>
                    <div class="subtitle">${t('ceoMode')}</div>
                </div>
                ${allAccounts.length === 0 ? `
                <div style="text-align:center;padding:3rem;color:#9AA0A6;border:1px dashed rgba(230,232,235,0.15);border-radius:12px;margin-bottom:2rem;">
                    <div style="font-size:3rem;margin-bottom:1rem;">üìà</div>
                    <div style="font-size:1.1rem;font-weight:600;margin-bottom:0.5rem;">${t('noHistory')}</div>
                    <div style="font-size:0.9rem;">${t('noHistoryDetail')}</div>
                </div>` : ''}

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">‚óá TOTAL PAYOUTS</div>
                        <div class="kpi-value">‚Ç¨${totalPayouts.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">TOTAL INVESTED</div>
                        <div class="kpi-value success">‚Ç¨${totalInvested.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('capitalMultiple')}</div>
                        <div class="kpi-value">${capitalMultiple.toFixed(2)}x</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">BEST YEAR</div>
                        <div class="kpi-value">${bestYear}</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('evolutionByYear')}</h3>
                    <div class="chart-container" style="max-width: 800px;">
                        <canvas id="ceoLineChart"></canvas>
                    </div>
                </div>

                ${hasExamenData ? `
                <div class="table-container">
                    <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 700;">${t('progressMetrics')}</h3>
                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 1.5rem;">${t('progressCalculated')}</div>
                    <div class="kpi-grid" style="margin-bottom: 0;">
                        <div class="kpi-card">
                            <div class="kpi-label">${t('avgAttempts')}</div>
                            <div class="kpi-value">${avgAttemptsToFund > 0 ? avgAttemptsToFund.toFixed(1) : '‚Äî'}</div>
                            <div class="kpi-subtitle">${t('phasesPerAccount')}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">${t('avgDaysPhase1')}</div>
                            <div class="kpi-value">${avgDaysPhase1 > 0 ? Math.round(avgDaysPhase1) : '‚Äî'} <span style="font-size: 1rem;">${t('days')}</span></div>
                            <div class="kpi-subtitle">${t('toPassPhase1')}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">${t('avgDaysPhase2')}</div>
                            <div class="kpi-value">${avgDaysPhase2 > 0 ? Math.round(avgDaysPhase2) : '‚Äî'} <span style="font-size: 1rem;">${t('days')}</span></div>
                            <div class="kpi-subtitle">${t('toGetFunded')}</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">ENTRADAS EN HISTORIAL</div>
                            <div class="kpi-value">${data.examens.length}</div>
                            <div class="kpi-subtitle">cambios de fase registrados</div>
                        </div>
                    </div>
                </div>` : ''}

                <div class="table-container">
                    <h3 style="margin-bottom: 1rem; font-size: 1.1rem; font-weight: 700;">‚óá √öLTIMOS PAYOUTS</h3>
                    ${allPayouts.length === 0 ? '<div class="empty-state">No hay payouts registrados</div>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cuenta</th>
                                    <th>Prop Firm</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allPayouts
                                    .sort((a, b) => new Date(b.payoutDate) - new Date(a.payoutDate))
                                    .slice(0, 10)
                                    .map(payout => {
                                        const account = allAccounts.find(a => a.id === payout.accountId);
                                        const accountNumber = account ? (account.accountNumber || account.id) : 'N/A';
                                        const propFirm = account ? account.propFirm : 'N/A';
                                        const statusClass = payout.status === 'Recibido' ? 'funded' : payout.status === 'Aprobado' ? 'phase2' : 'phase1';
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(payout.payoutDate).toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES')}</td>
                                                <td style="font-weight: 600;">${accountNumber}</td>
                                                <td>${propFirm}</td>
                                                <td style="font-weight: 700; color: #2ECC71;">‚Ç¨${payout.amount.toLocaleString()}</td>
                                                <td><span class="status-badge ${statusClass}">${payout.status || 'Recibido'}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            `;

            document.getElementById('ceoview').innerHTML = ceoViewHtml;

            // CEO Line Chart
            const ctx = document.getElementById('ceoLineChart');
            if (ctx && years.length > 0) {
                if (window.ceoChart && typeof window.ceoChart.destroy === 'function') {
                    window.ceoChart.destroy();
                }

                window.ceoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Payouts',
                            data: yearlyPayouts,
                            borderColor: '#2ECC71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#2ECC71',
                            pointBorderColor: '#121417',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (context) => `‚Ç¨${context.parsed.y.toLocaleString()}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => '‚Ç¨' + (value / 1000).toFixed(0) + 'k'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        // === RENDER: EFFICIENCY ===
        // Render Capital Efficiency
        function renderCapitalEfficiency() {
            const allAccounts = filterByYear(data.master_comptes, efficiencyTimeFilter);
            const allPayouts  = filterByYear(data.payouts, efficiencyTimeFilter);
            const totalWithdrawn = allPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalInvested = allAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const withdrawnToInvestedRatio = totalInvested > 0 ? totalWithdrawn / totalInvested : 0;

            // Average time to funding
            const fundedAccounts = allAccounts.filter(a => a.status === 'FUNDED');
            const avgTimeToFunding = fundedAccounts.length > 0 
                ? fundedAccounts.reduce((sum, a) => sum + calculateDaysToFunding(a), 0) / fundedAccounts.length 
                : 0;

            // Self-funded system percentage
            const selfFundedPercentage = totalInvested > 0 ? Math.min((totalWithdrawn / totalInvested) * 100, 100) : 0;

            // Break-even timing ‚Äî calcular din√°micamente
            let breakEvenMonth = t('pending');
            if (totalInvested > 0 && totalWithdrawn > 0) {
                if (totalWithdrawn >= totalInvested) {
                    breakEvenMonth = t('reached');
                } else {
                    // Calcular proyecci√≥n basada en la tasa mensual de los √∫ltimos 3 meses
                    const last3Months = data.payouts
                        .filter(p => p.payoutDate)
                        .sort((a, b) => new Date(b.payoutDate) - new Date(a.payoutDate))
                        .slice(0, 10);
                    const recentMonthlyRate = last3Months.length > 0
                        ? last3Months.reduce((s, p) => s + p.amount, 0) / 3
                        : 0;
                    if (recentMonthlyRate > 0) {
                        const monthsRemaining = Math.ceil((totalInvested - totalWithdrawn) / recentMonthlyRate);
                        const breakDate = new Date();
                        breakDate.setMonth(breakDate.getMonth() + monthsRemaining);
                        const monthNames = getTranslation('dash.monthNames');
                        breakEvenMonth = `${monthNames[breakDate.getMonth()]} ${breakDate.getFullYear()}`;
                    }
                }
            }

            const efficiencyHtml = `
                <div class="view-header">
                    <h2>CAPITAL EFFICIENCY</h2>
                    ${allAccounts.length === 0 ? `<div style="padding:0.5rem;color:#F39C12;font-size:0.85rem;">${t('noChallenges')}</div>` : ''}
                    <div class="subtitle">${t('rendimiento')} ¬∑ ${t('updated')} ${new Date().toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'es-ES', { month: 'short', year: 'numeric' })}</div>
                    <div class="time-filter">
                        <select id="efficiencyTimeFilter" onchange="efficiencyTimeFilter=this.value;renderCapitalEfficiency();">
                            ${buildYearOptions(efficiencyTimeFilter)}
                        </select>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">‚Ç¨ WITHDRAWN / ‚Ç¨ INVERTIDO</div>
                        <div class="kpi-value success">${withdrawnToInvestedRatio.toFixed(2)}x</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('avgTimeToFunding')}</div>
                        <div class="kpi-value">${Math.round(avgTimeToFunding)} <span style="font-size: 1rem;">${t('days')}</span></div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">${t('selfFunded')}</div>
                        <div class="kpi-value success">${selfFundedPercentage.toFixed(0)}%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">TIMING BREAK-EVEN</div>
                        <div class="kpi-value" style="font-size: 1.4rem;">${breakEvenMonth}</div>
                        <div class="kpi-subtitle">${t('projection')}</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">‚óá FUNDED / INVESTED</h3>
                        
                        <div class="bar-chart">
                            <div class="bar-row">
                                <div class="bar-label">FUNDED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: ${Math.min(withdrawnToInvestedRatio * 20, 100)}%; background: linear-gradient(90deg, #2ECC71, #27AE60);">
                                        ${withdrawnToInvestedRatio > 0.5 ? '<span class="bar-value">‚Ç¨' + totalWithdrawn.toLocaleString() + '</span>' : ''}
                                    </div>
                                </div>
                                <div class="bar-count">‚Ç¨${totalWithdrawn.toLocaleString()}</div>
                            </div>
                            
                            <div class="bar-row">
                                <div class="bar-label">INVESTED</div>
                                <div class="bar-track">
                                    <div class="bar-fill" style="width: 50%; background: linear-gradient(90deg, #9AA0A6, #7F8C8D);">
                                        <span class="bar-value">‚Ç¨${totalInvested.toLocaleString()}</span>
                                    </div>
                                </div>
                                <div class="bar-count">‚Ç¨${totalInvested.toLocaleString()}</div>
                            </div>
                        </div>

                        <div style="margin-top: 1.5rem; text-align: center;">
                            <div class="kpi-value success" style="font-size: 2.5rem;">+${((withdrawnToInvestedRatio - 1) * 100).toFixed(0)}%</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">‚óá SELF-FUNDING STATUS</h3>
                        
                        <div class="gauge-container">
                            <canvas id="selfFundingGauge"></canvas>
                            <div class="gauge-text">
                                <div class="gauge-percentage">${selfFundedPercentage.toFixed(0)}%</div>
                                <div class="gauge-label">‚Ç¨${totalWithdrawn.toLocaleString()} WITHDRAWN</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; font-weight: 700;">${t('recoveryTrend')}</h3>
                    <div style="color: #9AA0A6; font-size: 0.8rem; margin-bottom: 1.5rem;">${t('efficiencyChart')}</div>
                    <div class="chart-container" style="max-width: 800px;">
                        <canvas id="autofinancingChart"></canvas>
                    </div>
                </div>
            `;

            document.getElementById('efficiency').innerHTML = efficiencyHtml;

            // Self-funding Gauge Chart
            const gaugeCtx = document.getElementById('selfFundingGauge');
            if (gaugeCtx) {
                if (window.gaugeChart && typeof window.gaugeChart.destroy === 'function') {
                    window.gaugeChart.destroy();
                }

                window.gaugeChart = new Chart(gaugeCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [selfFundedPercentage, 100 - selfFundedPercentage],
                            backgroundColor: ['#2ECC71', 'rgba(230, 232, 235, 0.1)'],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        cutout: '75%'
                    }
                });
            }

            // Autofinancing trend chart ‚Äî datos reales de payouts acumulados por mes
            const trendCtx = document.getElementById('autofinancingChart');
            if (trendCtx) {
                if (window.autofinancingChart && typeof window.autofinancingChart.destroy === 'function') {
                    window.autofinancingChart.destroy();
                }

                // Calcular acumulado real mes a mes (todos los a√±os, ordenado por fecha)
                const allSortedPayouts = [...data.payouts]
                    .filter(p => p.payoutDate)
                    .sort((a, b) => new Date(a.payoutDate) - new Date(b.payoutDate));

                const totalInvestedAll = data.master_comptes.reduce((sum, a) => sum + a.challengeCost, 0);

                let monthLabels = [];
                let monthData = [];

                if (allSortedPayouts.length > 0) {
                    // Agrupar payouts por mes YYYY-MM
                    const monthMap = {};
                    allSortedPayouts.forEach(p => {
                        const d = new Date(p.payoutDate);
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        monthMap[key] = (monthMap[key] || 0) + p.amount;
                    });

                    // Acumulado cronol√≥gico
                    const sortedKeys = Object.keys(monthMap).sort();
                    let cumulative = 0;
                    sortedKeys.forEach(key => {
                        cumulative += monthMap[key];
                        const [yr, mo] = key.split('-');
                        const monthNames = getTranslation('dash.monthNames');
                        monthLabels.push(`${monthNames[parseInt(mo)-1]} ${yr}`);
                        // Ratio acumulado sobre lo invertido (%)
                        monthData.push(totalInvestedAll > 0 ? parseFloat(((cumulative / totalInvestedAll) * 100).toFixed(1)) : 0);
                    });
                } else {
                    monthLabels = ['Sin datos'];
                    monthData = [0];
                }

                window.autofinancingChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: '% Payouts / Invertido',
                            data: monthData,
                            borderColor: '#2ECC71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#2ECC71',
                            pointBorderColor: '#121417',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (ctx) => `${ctx.parsed.y.toFixed(1)}% recuperado`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (v) => v + '%'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6', maxRotation: 45 },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
        }

        // Render Wrapped
        // === RENDER: WRAPPED ===
        function renderWrapped() {
            const yearAccounts = filterByYear(data.master_comptes, wrappedTimeFilter);
            const yearPayouts  = filterByYear(data.payouts, wrappedTimeFilter);

            const totalPayouts = yearPayouts.reduce((sum, p) => sum + p.amount, 0);
            const totalInvested = yearAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
            const avgROI = totalInvested > 0 ? ((totalPayouts - totalInvested) / totalInvested * 100) : 0;
            const fundedAccounts = yearAccounts.filter(a => a.status === 'FUNDED').length;
            
            // Calculate quickest funding
            const fundedAccountsWithDays = yearAccounts
                .filter(a => a.status === 'FUNDED')
                .map(a => ({ ...a, days: calculateDaysToFunding(a) }))
                .sort((a, b) => a.days - b.days);
            const quickestFunding = fundedAccountsWithDays.length > 0 ? fundedAccountsWithDays[0].days : 0;

            // Capital multiple
            const capitalMultiple = totalInvested > 0 ? totalPayouts / totalInvested : 0;

            // Self-funded percentage
            const selfFundedPercentage = totalInvested > 0 ? Math.min((totalPayouts / totalInvested) * 100, 100) : 0;

            // Win rates
            const totalChallenges = yearAccounts.length;
            const { phase1: phase1WinRate, phase2: phase2WinRate } = calcWinRates(yearAccounts);

            // Avg time to funding
            const avgTimeToFunding = fundedAccountsWithDays.length > 0 
                ? fundedAccountsWithDays.reduce((sum, a) => sum + a.days, 0) / fundedAccountsWithDays.length 
                : 0;

            // Payouts by prop firm
            const propFirms = ['FTMO', 'Alpha Capital Group', 'Orion Funded', 'Bullfy', 'FundedNext', 'The5ers', 'MyForexFunds'];
            const payoutsByFirm = propFirms.map(firm => {
                const firmAccountIds = yearAccounts.filter(a => a.propFirm === firm).map(a => a.id);
                const firmPayouts = yearPayouts.filter(p => firmAccountIds.includes(p.accountId))
                    .reduce((sum, p) => sum + p.amount, 0);
                return { firm, payouts: firmPayouts };
            }).filter(f => f.payouts > 0).sort((a, b) => b.payouts - a.payouts);

            // Completed challenges count
            const completedByFirm = propFirms.map(firm => {
                const count = yearAccounts.filter(a => a.propFirm === firm && a.status === 'FUNDED').length;
                return { firm, count };
            }).filter(f => f.count > 0);

            const wrappedHtml = `
                <div class="wrapped-header" style="position:relative;">
                    <div class="wrapped-title">PROP FIRM WRAPPED${wrappedTimeFilter !== "ALL_TIME" ? " ¬∑ " + wrappedTimeFilter : ""}</div>
                    <div class="wrapped-subtitle">${t('wrappedSubtitle')}</div>
                    <div style="margin-top: 1rem;">
                        <select id="wrappedYearSelect" style="padding: 0.75rem 1.5rem; background: #181B20; border: 1px solid rgba(243, 156, 18, 0.3); border-radius: 8px; color: #E6E8EB; font-size: 0.95rem; font-weight: 600;"
                            onchange="wrappedTimeFilter=this.value;renderWrapped();">
                            ${buildYearOptions(wrappedTimeFilter)}
                        </select>
                    </div>
                </div>

                ${yearAccounts.length === 0 ? `
                <div style="text-align:center; padding: 3rem; color: #9AA0A6; border: 1px dashed rgba(230,232,235,0.15); border-radius: 12px; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${t('noDataPeriod')}</div>
                    <div style="font-size: 0.9rem;">${t('noDataCreate')}</div>
                </div>` : ''}

                <div class="kpi-grid">
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(52, 152, 219, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-value success" style="font-size: 2.5rem;">+‚Ç¨${totalPayouts.toLocaleString()}</div>
                        <div class="kpi-label">TOTAL PAYOUTS</div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.05), rgba(230, 126, 34, 0.05)); border: 1px solid rgba(243, 156, 18, 0.2);">
                        <div class="kpi-value warning" style="font-size: 2.5rem;">${(totalPayouts > 0 && totalInvested > 0) ? (avgROI >= 0 ? "+" : "") + avgROI.toFixed(0) + "%" : "‚Äî"}</div>
                        <div class="kpi-label">${t('roiAverage')}</div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(41, 128, 185, 0.05)); border: 1px solid rgba(52, 152, 219, 0.2);">
                        <div class="kpi-value" style="font-size: 2.5rem; color: #F39C12;">${quickestFunding > 0 ? quickestFunding + ' <span style="font-size: 1.2rem;">DAYS</span>' : '‚Äî'}</div>
                        <div class="kpi-label">${t('quickestFunding')}</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 700;">${t('payoutsByFirm')}</h3>
                    <div class="chart-container" style="max-width: 600px;">
                        <canvas id="wrappedPayoutsChart"></canvas>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(39, 174, 96, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-label" style="text-align: center;">üå± CUENTAS FONDEADAS</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value success" style="font-size: 3.5rem;">${fundedAccounts}</div>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(39, 174, 96, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-label" style="text-align: center;">üí∞ M√öLTIPLO DE CAPITAL</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value" style="font-size: 3.5rem;">${capitalMultiple > 0 ? capitalMultiple.toFixed(2) + "x" : "‚Äî"}</div>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(46, 204, 113, 0.05), rgba(39, 174, 96, 0.05)); border: 1px solid rgba(46, 204, 113, 0.2);">
                        <div class="kpi-label" style="text-align: center;">‚ôªÔ∏è SISTEMA AUTO-FINANCIADO</div>
                        <div style="text-align: center; padding: 2rem 0;">
                            <div class="kpi-value success" style="font-size: 3.5rem;">${selfFundedPercentage.toFixed(0)}%</div>
                        </div>
                    </div>
                </div>

                ${totalChallenges > 0 ? `
                <div class="achievement-card">
                    <div class="achievement-icon">‚úÖ</div>
                    <div class="achievement-content">
                        <h4>${phase1WinRate.toFixed(0)}% TASA DE √âXITO PHASE 1</h4>
                        <p>${passedPhase1} de ${totalChallenges} challenges superaron Phase 1</p>
                    </div>
                </div>` : ''}

                ${fundedAccounts > 0 ? `
                <div class="achievement-card">
                    <div class="achievement-icon">üî•</div>
                    <div class="achievement-content">
                        <h4>${phase2WinRate.toFixed(0)}% TASA DE √âXITO PHASE 2</h4>
                        <p>Convertiste ${phase2WinRate.toFixed(0)}% de intentos de Phase 2 en cuentas fondeadas</p>
                    </div>
                </div>` : ''}

                ${avgTimeToFunding > 0 ? `
                <div class="achievement-card">
                    <div class="achievement-icon">‚ö°</div>
                    <div class="achievement-content">
                        <h4>${Math.round(avgTimeToFunding)} DAYS TIEMPO PROMEDIO HASTA FONDEO</h4>
                        <p>${t('avgFundingTime').replace('{n}', Math.round(avgTimeToFunding))}</p>
                    </div>
                </div>` : ''}

                ${completedByFirm.map(f => `
                    <div class="achievement-card">
                        <div class="achievement-icon">${f.firm === 'FTMO' ? '‚óÜ' : f.firm === 'MyForexFunds' ? '‚óá' : '‚óà'}</div>
                        <div class="achievement-content">
                            <h4>${f.count} ${f.firm} COMPLETADAS</h4>
                            <p>Fondeaste exitosamente ${f.count} ${f.firm} cuenta${f.count > 1 ? 's' : ''}</p>
                        </div>
                    </div>
                `).join('')}

                <!-- WRAPPED GENERATOR -->
                <div class="wrapped-generator" style="background: linear-gradient(135deg, rgba(243,156,18,0.04), rgba(230,126,34,0.02)); border: 1px solid rgba(243,156,18,0.12); border-radius: 20px; padding: 2.5rem;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 2.5rem;">
                        <div style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.18em; color: #F39C12; margin-bottom: 0.6rem; text-transform: uppercase;">Create your story</div>
                        <h2 style="font-size: 2rem; font-weight: 900; color: #FFFFFF; margin: 0; letter-spacing: -0.02em;">PROP FIRM WRAPPED</h2>
                        <p style="color: #6B7280; font-size: 0.85rem; margin-top: 0.5rem;">Tu a√±o en trading, en una imagen para compartir</p>
                    </div>

                    <!-- Period + Design in one row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <!-- Period -->
                        <div>
                            <div class="config-title" style="margin-bottom: 0.75rem;">PERIODO</div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                                    <input type="radio" name="wrappedPeriod" value="monthly" style="width: 14px; height: 14px; accent-color: #F39C12; cursor: pointer;">
                                    Mensual
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; background: rgba(243,156,18,0.1); border: 1px solid rgba(243,156,18,0.3); border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: #F39C12;">
                                    <input type="radio" name="wrappedPeriod" value="yearly" checked style="width: 14px; height: 14px; accent-color: #F39C12; cursor: pointer;">
                                    Anual
                                </label>
                            </div>
                            <div id="monthSelector" style="margin-top: 0.75rem; display: none;">
                                <select id="wrappedMonth" style="padding: 0.5rem 1rem; background: #121417; border: 1px solid rgba(230, 232, 235, 0.1); border-radius: 8px; color: #E6E8EB; font-family: Inter, sans-serif; font-size: 0.85rem; width: 100%;">
                                    <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                                    <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                                    <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                                    <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                                </select>
                            </div>
                        </div>

                        <!-- Design -->
                        <div>
                            <div class="config-title" style="margin-bottom: 0.75rem;">TEMA VISUAL</div>
                            <div class="design-selector" style="gap: 0.6rem;">
                                <div class="design-option selected" data-design="gradient1" onclick="selectDesign('gradient1')" title="Obsidian Gold">
                                    <div class="design-preview gradient1"></div>
                                    <div style="font-size: 0.72rem; font-weight: 700; letter-spacing: 0.05em; margin-top: 4px;">GOLD</div>
                                </div>
                                <div class="design-option" data-design="gradient2" onclick="selectDesign('gradient2')" title="Neon Verde">
                                    <div class="design-preview gradient2"></div>
                                    <div style="font-size: 0.72rem; font-weight: 700; letter-spacing: 0.05em; margin-top: 4px;">GREEN</div>
                                </div>
                                <div class="design-option" data-design="gradient3" onclick="selectDesign('gradient3')" title="Deep Blue">
                                    <div class="design-preview gradient3"></div>
                                    <div style="font-size: 0.72rem; font-weight: 700; letter-spacing: 0.05em; margin-top: 4px;">BLUE</div>
                                </div>
                                <div class="design-option" data-design="dark" onclick="selectDesign('dark')" title="Noir Platinum">
                                    <div class="design-preview dark"></div>
                                    <div style="font-size: 0.72rem; font-weight: 700; letter-spacing: 0.05em; margin-top: 4px;">NOIR</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Metric toggles -->
                    <div style="margin-bottom: 2rem;">
                        <div class="config-title" style="margin-bottom: 0.75rem;">M√âTRICAS ‚Äî toca para seleccionar (m√°x. 6)</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="metricToggles">
                            <button class="wrapped-metric-toggle active" data-metric="netprofit">NET PROFIT</button>
                            <button class="wrapped-metric-toggle active" data-metric="payouts">PAYOUTS</button>
                            <button class="wrapped-metric-toggle active" data-metric="roi">ROI</button>
                            <button class="wrapped-metric-toggle active" data-metric="funded">FUNDED</button>
                            <button class="wrapped-metric-toggle active" data-metric="winrate">WIN RATE P1</button>
                            <button class="wrapped-metric-toggle" data-metric="winrate2">WIN RATE P2</button>
                            <button class="wrapped-metric-toggle" data-metric="invested">INVERTIDO</button>
                            <button class="wrapped-metric-toggle" data-metric="fastest">FONDEO M√ÅS R√ÅPIDO</button>
                            <button class="wrapped-metric-toggle" data-metric="avgtime">TIEMPO PROMEDIO</button>
                            <button class="wrapped-metric-toggle" data-metric="multiple">M√öLTIPLO</button>
                            <button class="wrapped-metric-toggle" data-metric="bestfirm">TOP FIRM</button>
                        </div>
                    </div>

                    <!-- Generate CTA -->
                    <button onclick="generateWrappedPreview()" style="width: 100%; padding: 1.1rem 2rem; background: linear-gradient(135deg, #F39C12, #E67E22); border: none; border-radius: 14px; color: #0D0A07; font-family: Inter, sans-serif; font-size: 1rem; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; box-shadow: 0 4px 24px rgba(243,156,18,0.3);"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 32px rgba(243,156,18,0.45)'"
                        onmouseout="this.style.transform='';this.style.boxShadow='0 4px 24px rgba(243,156,18,0.3)'">
                        GENERAR WRAPPED
                    </button>

                    <!-- Preview -->
                    <div id="wrappedPreview" style="display: none; margin-top: 2rem;">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div style="font-size: 0.7rem; font-weight: 700; letter-spacing: 0.15em; color: #2ECC71; text-transform: uppercase; margin-bottom: 0.4rem;">‚úì Listo para compartir</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #E6E8EB;">Tu Wrapped est√° generado ¬∑ 1080 √ó 1920 px</div>
                        </div>
                        <div class="preview-container" style="border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                            <canvas id="wrappedCanvas" width="1080" height="1920" class="preview-canvas"></canvas>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                            <button onclick="closePreview()" style="padding: 0.9rem 1.5rem; background: transparent; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; color: #9AA0A6; font-family: Inter, sans-serif; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: border-color 0.2s, color 0.2s;"
                                onmouseover="this.style.borderColor='rgba(255,255,255,0.3)';this.style.color='#E6E8EB'"
                                onmouseout="this.style.borderColor='rgba(255,255,255,0.12)';this.style.color='#9AA0A6'">
                                ‚Üê EDITAR
                            </button>
                            <button onclick="downloadWrapped('png')" style="padding: 0.9rem 1.5rem; background: linear-gradient(135deg, #2ECC71, #27AE60); border: none; border-radius: 12px; color: #021A0D; font-family: Inter, sans-serif; font-size: 0.85rem; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; box-shadow: 0 4px 20px rgba(46,204,113,0.3);"
                                onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 28px rgba(46,204,113,0.45)'"
                                onmouseout="this.style.transform='';this.style.boxShadow='0 4px 20px rgba(46,204,113,0.3)'">
                                ‚Üì DESCARGAR PNG
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('wrapped').innerHTML = wrappedHtml;

            // Payouts by firm chart
            const chartCtx = document.getElementById('wrappedPayoutsChart');
            if (chartCtx && payoutsByFirm.length > 0) {
                if (window.wrappedChart && typeof window.wrappedChart.destroy === 'function') {
                    window.wrappedChart.destroy();
                }

                window.wrappedChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: payoutsByFirm.map(f => f.firm),
                        datasets: [{
                            data: payoutsByFirm.map(f => f.payouts),
                            backgroundColor: ['#2ECC71', '#9AA0A6', '#F39C12'],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#181B20',
                                callbacks: {
                                    label: (context) => `‚Ç¨${context.parsed.y.toLocaleString()}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9AA0A6',
                                    callback: (value) => '‚Ç¨' + (value / 1000).toFixed(0) + 'k'
                                },
                                grid: { color: 'rgba(230, 232, 235, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9AA0A6' },
                                grid: { display: false }
                            }
                        }
                    }
                });
            }
            
            // Inicializar listeners del wrapped generator
            setTimeout(initWrappedListeners, 100);
        }

        // Update UI
        // ============================================
        // INICIALIZACI√ìN DEL DASHBOARD
        // ============================================
        function initializeDashboard() {
            // Actualizar UI inicial
            updateUI();
        }

        function updateUI() {
            // Update account selects
            // Para Update Challenge: excluir SUSPENDED (estado terminal, sin transiciones posibles)
            const allActiveAccounts = data.master_comptes.filter(a => a.status !== 'SUSPENDED');
            
            // Para Register Payout: mostrar SOLO cuentas FUNDED
            const fundedAccounts = data.master_comptes.filter(a => a.status === 'FUNDED' && a.active);

            // Update Challenge dropdown - todas las cuentas activas
            const updateSelect = document.getElementById('updateAccountId');
            if (updateSelect) {
                if (allActiveAccounts.length === 0) {
                    updateSelect.innerHTML = '<option value="">No hay cuentas disponibles</option>';
                } else {
                    const statusOrder = { 'PHASE 1': 0, 'PHASE 2': 1, 'FUNDED': 2, 'SUSPENDED': 3 };
                    const sortedAccounts = [...allActiveAccounts].sort((a, b) =>
                        (statusOrder[a.status] ?? 9) - (statusOrder[b.status] ?? 9)
                    );
                    updateSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>' +
                        sortedAccounts.map(a => {
                            const num = a.accountNumber || a.id;
                            const size = a.accountSize || '?';
                            const firm = a.propFirm || '?';
                            const status = a.status;
                            const suspended = status === 'SUSPENDED' ? ' ‚õî' : '';
                            return `<option value="${a.id}">#${num} | ${size} | ${firm} ‚Äî ${status}${suspended}</option>`;
                        }).join('');
                }
                // Reset status select + hint whenever accounts are reloaded
                onUpdateAccountChange();
            }

            // Payout dropdown - solo cuentas FUNDED
            const payoutSelect = document.getElementById('payoutAccountId');
            if (payoutSelect) {
                if (fundedAccounts.length === 0) {
                    payoutSelect.innerHTML = '<option value="">No hay cuentas fondeadas</option>';
                } else {
                    payoutSelect.innerHTML = '<option value="">Selecciona una cuenta...</option>' +
                        fundedAccounts.map(a => {
                            const displayNumber = a.accountNumber || a.id;
                            return `<option value="${a.id}">${displayNumber} - ${a.propFirm}</option>`;
                        }).join('');
                }
            }

            // Render all tabs
            renderOverview();
            renderPerformance();
            renderPropFirm();
            renderCEOView();
            renderCapitalEfficiency();
            renderWrapped();

            updateHistoryBadge();
        }
        window._dashUpdateUI = updateUI; // expose for setLanguage re-render

        // === EVENTS: UI / TABS ===
        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                // Renderizar el dashboard correspondiente cuando se hace clic
                switch(tabName) {
                    case 'overview':
                        renderOverview();
                        break;
                    case 'performance':
                        renderPerformance();
                        break;
                    case 'propfirm':
                        renderPropFirm();
                        break;
                    case 'ceoview':
                        renderCEOView();
                        break;
                    case 'efficiency':
                        renderCapitalEfficiency();
                        break;
                    case 'wrapped':
                        renderWrapped();
                        break;
                }
            });
        });

        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('createPurchaseDate').value = today;
        document.getElementById('updateStatusDate').value = today;
        document.getElementById('payoutDate').value = today;

        // === INIT ===
        // Initial render
        updateUI();

        // WRAPPED GENERATOR FUNCTIONS
        let selectedDesign = 'gradient1';

        // Toggle month selector based on period - usando delegaci√≥n de eventos
        document.addEventListener('change', (e) => {
            if (e.target.name === 'wrappedPeriod') {
                const monthSelector = document.getElementById('monthSelector');
                if (monthSelector) {
                    monthSelector.style.display = e.target.value === 'monthly' ? 'block' : 'none';
                }
            }
        });

        // Tambi√©n a√±adir listeners despu√©s de renderizar wrapped
        function initWrappedListeners() {
            // wrappedYearSelect is now fully local ‚Äî handled inline via onchange

            const monthlyRadio = document.querySelector('input[name="wrappedPeriod"][value="monthly"]');
            const yearlyRadio = document.querySelector('input[name="wrappedPeriod"][value="yearly"]');
            
            if (monthlyRadio) {
                monthlyRadio.addEventListener('change', function() {
                    const monthSelector = document.getElementById('monthSelector');
                    if (monthSelector) monthSelector.style.display = 'block';
                });
            }
            
            if (yearlyRadio) {
                yearlyRadio.addEventListener('change', function() {
                    const monthSelector = document.getElementById('monthSelector');
                    if (monthSelector) monthSelector.style.display = 'none';
                });
            }
        }

        function selectDesign(design) {
            selectedDesign = design;
            document.querySelectorAll('.design-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-design="${design}"]`)?.classList.add('selected');
        }

        // Metric toggle handler (event delegation ‚Äî works on dynamic HTML)
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.wrapped-metric-toggle');
            if (!btn) return;
            const maxMetrics = 6;
            const allToggles = document.querySelectorAll('.wrapped-metric-toggle');
            const activeCount = document.querySelectorAll('.wrapped-metric-toggle.active').length;
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
            } else if (activeCount < maxMetrics) {
                btn.classList.add('active');
            }
        });

        function generateWrappedPreview() {
            const canvas = document.getElementById('wrappedCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = 1080;
            const height = 1920;

            // Get selected period
            const period = document.querySelector('input[name="wrappedPeriod"]:checked').value;
            const year = wrappedTimeFilter !== "ALL_TIME" ? parseInt(wrappedTimeFilter) : new Date().getFullYear();
            let periodText = wrappedTimeFilter !== "ALL_TIME" ? year.toString() : "All-time";
            let filterData = filterByYear(data.master_comptes, wrappedTimeFilter);
            let filterPayouts = filterByYear(data.payouts, wrappedTimeFilter);

            if (period === 'monthly') {
                const month = parseInt(document.getElementById('wrappedMonth').value);
                const monthNames = getTranslation('dash.monthNamesFull');
                periodText = `${monthNames[month]} ${year}`;
                // Filter by BOTH month AND year (year already resolved above, defaults to current year for ALL_TIME)
                filterData    = filterData.filter(a    => { const d = new Date(a.purchaseDate); return d.getMonth() === month && d.getFullYear() === year; });
                filterPayouts = filterPayouts.filter(p => { const d = new Date(p.payoutDate);   return d.getMonth() === month && d.getFullYear() === year; });
            }

            // Calculate metrics
            const metrics = {
                payouts: filterPayouts.reduce((sum, p) => sum + p.amount, 0),
                invested: filterData.reduce((sum, a) => sum + a.challengeCost, 0),
                funded: filterData.filter(a => a.status === 'FUNDED').length,
                roi: 0,
                netprofit: 0,
                winrate: 0,
                winrate2: 0,
                fastest: 0,
                avgtime: 0,
                multiple: 0,
                bestfirm: 'N/A'
            };

            metrics.roi = metrics.invested > 0 ? ((metrics.payouts - metrics.invested) / metrics.invested * 100) : 0;
            metrics.netprofit = metrics.payouts - metrics.invested;
            metrics.multiple = metrics.invested > 0 ? (metrics.payouts / metrics.invested) : 0;

            const { phase1: wr1, phase2: wr2 } = calcWinRates(filterData);
            metrics.winrate  = wr1;
            metrics.winrate2 = wr2;

            const fundedWithDays = filterData
                .filter(a => a.status === 'FUNDED')
                .map(a => calculateDaysToFunding(a));
            
            if (fundedWithDays.length > 0) {
                metrics.fastest = Math.min(...fundedWithDays);
                metrics.avgtime = fundedWithDays.reduce((a, b) => a + b, 0) / fundedWithDays.length;
            }

            // Best firm by ROI
            const propFirms = ['FTMO', 'Alpha Capital Group', 'Orion Funded', 'Bullfy', 'FundedNext', 'The5ers', 'MyForexFunds'];
            const firmROIs = propFirms.map(firm => {
                const firmAccounts = filterData.filter(a => a.propFirm === firm);
                const firmCosts = firmAccounts.reduce((sum, a) => sum + a.challengeCost, 0);
                const firmAccountIds = firmAccounts.map(a => a.id);
                const firmPayouts = filterPayouts.filter(p => firmAccountIds.includes(p.accountId))
                    .reduce((sum, p) => sum + p.amount, 0);
                const roi = firmCosts > 0 ? ((firmPayouts - firmCosts) / firmCosts * 100) : 0;
                return { firm, roi };
            }).filter(f => f.roi > 0).sort((a, b) => b.roi - a.roi);
            
            if (firmROIs.length > 0) {
                metrics.bestfirm = firmROIs[0].firm;
            }

            // Get selected metrics (from simplified selector)
            const selectedMetrics = [];
            document.querySelectorAll('.wrapped-metric-toggle.active').forEach(btn => {
                selectedMetrics.push(btn.getAttribute('data-metric'));
            });
            if (selectedMetrics.length === 0) {
                selectedMetrics.push('netprofit', 'payouts', 'roi', 'funded', 'winrate');
            }

            // === DRAW ===
            drawWrappedBackground(ctx, width, height, selectedDesign);
            drawWrappedBranding(ctx, width, periodText, selectedDesign);

            // Layout metrics: smart grid based on count
            const count = selectedMetrics.length;
            const cols = count === 1 ? 1 : 2;
            const cardW = count === 1 ? 800 : 460;
            const cardH = count <= 2 ? 280 : count <= 4 ? 240 : 200;
            const gap = 30;
            const totalGridW = cols * cardW + (cols - 1) * gap;
            const startX = (width - totalGridW) / 2;
            const startY = 340;

            selectedMetrics.forEach((metric, i) => {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = startX + col * (cardW + gap);
                const y = startY + row * (cardH + gap);
                drawMetricCard(ctx, x, y, cardW, cardH, metric, metrics);
            });

            // Footer watermark
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(255,255,255,0.18)';
            ctx.font = '500 26px Inter';
            ctx.fillText('neverquit.app', width / 2, height - 80);

            // Show preview
            document.getElementById('wrappedPreview').style.display = 'block';
            document.getElementById('wrappedPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.arcTo(x + w, y, x + w, y + r, r);
            ctx.lineTo(x + w, y + h - r);
            ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
            ctx.lineTo(x + r, y + h);
            ctx.arcTo(x, y + h, x, y + h - r, r);
            ctx.lineTo(x, y + r);
            ctx.arcTo(x, y, x + r, y, r);
            ctx.closePath();
        }

        function drawOrb(ctx, cx, cy, radius, color1, color2) {
            const radial = ctx.createRadialGradient(cx, cy, 0, cx, cy, radius);
            radial.addColorStop(0, color1);
            radial.addColorStop(1, color2);
            ctx.fillStyle = radial;
            ctx.beginPath();
            ctx.arc(cx, cy, radius, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawWrappedBackground(ctx, width, height, design) {
            // Base fill
            if (design === 'gradient1') {
                // OBSIDIAN GOLD ‚Äî dark base + amber radial glow
                const base = ctx.createLinearGradient(0, 0, 0, height);
                base.addColorStop(0, '#0D0A07');
                base.addColorStop(0.5, '#110E08');
                base.addColorStop(1, '#0A0806');
                ctx.fillStyle = base; ctx.fillRect(0, 0, width, height);
                // Orbs
                drawOrb(ctx, width * 0.8, height * 0.12, 600, 'rgba(243,156,18,0.18)', 'rgba(243,156,18,0)');
                drawOrb(ctx, width * 0.15, height * 0.75, 700, 'rgba(230,126,34,0.12)', 'rgba(230,126,34,0)');
                drawOrb(ctx, width * 0.5, height * 0.4, 900, 'rgba(241,196,15,0.06)', 'rgba(241,196,15,0)');
                // Noise grain via tiny dots
                ctx.fillStyle = 'rgba(255,255,255,0.012)';
                for (let i = 0; i < 3000; i++) {
                    ctx.fillRect(Math.random()*width, Math.random()*height, 1.5, 1.5);
                }
            } else if (design === 'gradient2') {
                // NEON VERDE ‚Äî dark + emerald radial
                const base = ctx.createLinearGradient(0, 0, 0, height);
                base.addColorStop(0, '#020D06');
                base.addColorStop(1, '#010803');
                ctx.fillStyle = base; ctx.fillRect(0, 0, width, height);
                drawOrb(ctx, width * 0.75, height * 0.1, 650, 'rgba(46,204,113,0.2)', 'rgba(46,204,113,0)');
                drawOrb(ctx, width * 0.2, height * 0.8, 600, 'rgba(39,174,96,0.14)', 'rgba(39,174,96,0)');
                drawOrb(ctx, width * 0.5, height * 0.5, 800, 'rgba(46,204,113,0.05)', 'rgba(46,204,113,0)');
                ctx.fillStyle = 'rgba(255,255,255,0.012)';
                for (let i = 0; i < 3000; i++) ctx.fillRect(Math.random()*width, Math.random()*height, 1.5, 1.5);
            } else if (design === 'gradient3') {
                // DEEP BLUE ‚Äî dark navy + electric blue
                const base = ctx.createLinearGradient(0, 0, 0, height);
                base.addColorStop(0, '#03060F');
                base.addColorStop(1, '#020509');
                ctx.fillStyle = base; ctx.fillRect(0, 0, width, height);
                drawOrb(ctx, width * 0.8, height * 0.08, 700, 'rgba(52,152,219,0.2)', 'rgba(52,152,219,0)');
                drawOrb(ctx, width * 0.1, height * 0.85, 600, 'rgba(41,128,185,0.14)', 'rgba(41,128,185,0)');
                drawOrb(ctx, width * 0.45, height * 0.45, 850, 'rgba(52,152,219,0.06)', 'rgba(52,152,219,0)');
                ctx.fillStyle = 'rgba(255,255,255,0.012)';
                for (let i = 0; i < 3000; i++) ctx.fillRect(Math.random()*width, Math.random()*height, 1.5, 1.5);
            } else {
                // NOIR PLATINUM ‚Äî pure dark
                const base = ctx.createLinearGradient(0, 0, 0, height);
                base.addColorStop(0, '#0C0D0F');
                base.addColorStop(1, '#070809');
                ctx.fillStyle = base; ctx.fillRect(0, 0, width, height);
                drawOrb(ctx, width * 0.8, height * 0.1, 600, 'rgba(255,255,255,0.04)', 'rgba(255,255,255,0)');
                drawOrb(ctx, width * 0.15, height * 0.85, 500, 'rgba(255,255,255,0.03)', 'rgba(255,255,255,0)');
                ctx.fillStyle = 'rgba(255,255,255,0.01)';
                for (let i = 0; i < 2000; i++) ctx.fillRect(Math.random()*width, Math.random()*height, 1.5, 1.5);
            }

            // Subtle horizontal rule near top
            const accentColor = design === 'gradient1' ? '#F39C12' : design === 'gradient2' ? '#2ECC71' : design === 'gradient3' ? '#3498DB' : '#555';
            const lineGrad = ctx.createLinearGradient(100, 0, width - 100, 0);
            lineGrad.addColorStop(0, 'rgba(255,255,255,0)');
            lineGrad.addColorStop(0.3, accentColor + '66');
            lineGrad.addColorStop(0.7, accentColor + '66');
            lineGrad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.strokeStyle = lineGrad;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(100, 290);
            ctx.lineTo(width - 100, 290);
            ctx.stroke();
        }

        function drawWrappedBranding(ctx, width, periodText, design) {
            const accentColor = design === 'gradient1' ? '#F39C12' : design === 'gradient2' ? '#2ECC71' : design === 'gradient3' ? '#3498DB' : '#A0A8B0';

            // NEVERQUIT wordmark
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.font = '900 96px Inter';
            ctx.letterSpacing = '0.05em';
            ctx.fillText('NEVERQUIT', width / 2, 155);

            // Accent dot
            ctx.fillStyle = accentColor;
            ctx.beginPath();
            ctx.arc(width / 2 + 445, 128, 12, 0, Math.PI * 2);
            ctx.fill();

            // PROP FIRM WRAPPED subtitle
            ctx.fillStyle = accentColor;
            ctx.font = '700 34px Inter';
            ctx.fillText('PROP FIRM WRAPPED', width / 2, 210);

            // Period badge
            const badgeW = 340, badgeH = 64, badgeX = (width - badgeW) / 2, badgeY = 236;
            drawRoundedRect(ctx, badgeX, badgeY, badgeW, badgeH, 32);
            ctx.fillStyle = accentColor + '22';
            ctx.fill();
            drawRoundedRect(ctx, badgeX, badgeY, badgeW, badgeH, 32);
            ctx.strokeStyle = accentColor + '55';
            ctx.lineWidth = 1.5;
            ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.85)';
            ctx.font = '600 30px Inter';
            ctx.fillText(periodText.toUpperCase(), width / 2, 278);
        }

        function drawMetricCard(ctx, x, y, w, h, metric, metrics) {
            const metricData = {
                payouts:   { label: 'TOTAL PAYOUTS',    value: `‚Ç¨${metrics.payouts.toLocaleString()}`,        sub: null },
                netprofit: { label: 'NET PROFIT',        value: `${metrics.netprofit >= 0 ? '+' : ''}‚Ç¨${metrics.netprofit.toLocaleString()}`, sub: null },
                roi:       { label: 'TOTAL ROI',         value: `${metrics.roi > 0 ? '+' : ''}${metrics.roi.toFixed(1)}%`, sub: null },
                funded:    { label: 'FUNDED ACCOUNTS',   value: metrics.funded.toString(),                    sub: null },
                invested:  { label: 'TOTAL INVESTED',    value: `‚Ç¨${metrics.invested.toLocaleString()}`,      sub: null },
                winrate:   { label: 'PHASE 1 WIN RATE',  value: `${metrics.winrate.toFixed(0)}%`,             sub: null },
                winrate2:  { label: 'PHASE 2 WIN RATE',  value: `${metrics.winrate2.toFixed(0)}%`,            sub: null },
                fastest:   { label: 'FASTEST FUNDING',   value: `${metrics.fastest}d`,                       sub: null },
                avgtime:   { label: 'AVG FUNDING TIME',  value: `${Math.round(metrics.avgtime)}d`,            sub: null },
                multiple:  { label: 'CAPITAL MULTIPLE',  value: `${metrics.multiple.toFixed(2)}x`,           sub: null },
                bestfirm:  { label: 'TOP PROP FIRM',     value: metrics.bestfirm,                            sub: null }
            };

            const d = metricData[metric] || { label: metric.toUpperCase(), value: '‚Äî', sub: null };

            // Glassmorphism card
            const isNetProfit = metric === 'netprofit';
            const glassColor = isNetProfit && metrics.netprofit < 0 ? 'rgba(231,76,60,0.08)' : 'rgba(255,255,255,0.05)';
            const borderColor = isNetProfit && metrics.netprofit < 0 ? 'rgba(231,76,60,0.3)' : 'rgba(255,255,255,0.12)';

            drawRoundedRect(ctx, x, y, w, h, 28);
            ctx.fillStyle = glassColor;
            ctx.fill();
            drawRoundedRect(ctx, x, y, w, h, 28);
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = 1.5;
            ctx.stroke();

            // Top accent line
            const accentGrad = ctx.createLinearGradient(x + 40, 0, x + w - 40, 0);
            accentGrad.addColorStop(0, 'rgba(255,255,255,0)');
            accentGrad.addColorStop(0.5, 'rgba(255,255,255,0.35)');
            accentGrad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.strokeStyle = accentGrad;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x + 40, y + 1.5);
            ctx.lineTo(x + w - 40, y + 1.5);
            ctx.stroke();

            ctx.textAlign = 'center';
            const cx = x + w / 2;

            // Label
            ctx.fillStyle = 'rgba(255,255,255,0.45)';
            ctx.font = '600 26px Inter';
            ctx.fillText(d.label, cx, y + 58);

            // Value
            const valueColor = (metric === 'netprofit' && metrics.netprofit < 0) ? '#FF6B6B'
                             : (metric === 'netprofit' || metric === 'payouts') ? '#6EE7A0'
                             : '#FFFFFF';
            ctx.fillStyle = valueColor;

            // Auto-scale font for long values
            let fontSize = 72;
            ctx.font = `800 ${fontSize}px Inter`;
            while (ctx.measureText(d.value).width > w - 60 && fontSize > 36) {
                fontSize -= 4;
                ctx.font = `800 ${fontSize}px Inter`;
            }
            ctx.fillText(d.value, cx, y + 58 + fontSize * 1.25);
        }

        function closePreview() {
            document.getElementById('wrappedPreview').style.display = 'none';
        }

        function downloadWrapped(format) {
            const canvas = document.getElementById('wrappedCanvas');
            
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = `wrapped-${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showAlert('‚úÖ Wrapped descargado como PNG');
            } else if (format === 'pdf') {
                // Para PDF necesitar√≠amos una librer√≠a como jsPDF
                // Por ahora convertimos a PNG de alta calidad
                const link = document.createElement('a');
                link.download = `wrapped-${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                showAlert('‚úÖ Wrapped descargado (alta calidad)');
            }
        }

        // ============================================
        // EXPONER FUNCIONES GLOBALMENTE (para onclick en HTML)
        // ============================================
        window.createChallenge = createChallenge;
        window.updateChallenge = updateChallenge;
        window.onUpdateAccountChange = onUpdateAccountChange;
        window.registerPayout = registerPayout;
        window.openResetModal = openResetModal;
        window.closeResetModal = closeResetModal;
        window.confirmReset = confirmReset;
        window.closePreview = closePreview;
        window.downloadWrapped = downloadWrapped;
        window.generateWrappedPreview = generateWrappedPreview;
        window.selectDesign = selectDesign;
        // History panel
        window.toggleHistoryPanel = toggleHistoryPanel;
        window.deleteHistoryEntry = deleteHistoryEntry;

        // ============================================
        // SWIPE FUNCTIONALITY
        // ============================================
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        const minSwipeDistance = 90;

        const tabOrder = ['control', 'overview', 'performance', 'propfirm', 'ceoview', 'efficiency', 'wrapped'];

        function getCurrentTabIndex() {
            const activeTab = document.querySelector('.tab.active');
            const tabName = activeTab ? activeTab.getAttribute('data-tab') : 'control';
            return tabOrder.indexOf(tabName);
        }

        function switchToTab(index) {
            if (index < 0 || index >= tabOrder.length) return;
            
            const tabName = tabOrder[index];
            const tabButton = document.querySelector(`.tab[data-tab="${tabName}"]`);
            
            if (tabButton) {
                tabButton.click();
                
                // Scroll al tab si no est√° visible
                tabButton.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function handleSwipe() {
            const horizontalDiff = touchEndX - touchStartX;
            const verticalDiff = Math.abs(touchEndY - touchStartY);
            
            // Solo procesar si es un swipe horizontal (no vertical)
            if (verticalDiff > 30) return;
            
            const currentIndex = getCurrentTabIndex();
            
            // Swipe derecha ‚Üí tab anterior
            if (horizontalDiff > minSwipeDistance) {
                switchToTab(currentIndex - 1);
            }
            // Swipe izquierda ‚Üí tab siguiente
            else if (horizontalDiff < -minSwipeDistance) {
                switchToTab(currentIndex + 1);
            }
        }

        // Event listeners para touch
        const tabContents = document.querySelector('.container');
        
        tabContents.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        tabContents.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, { passive: true });

        // Tambi√©n permitir arrastre con mouse para desktop
        let mouseStartX = 0;
        let mouseStartY = 0;
        let isDragging = false;

        tabContents.addEventListener('mousedown', (e) => {
            // Solo en elementos de contenido, no en inputs/buttons
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT') return;
            
            isDragging = true;
            mouseStartX = e.screenX;
            mouseStartY = e.screenY;
        });

        tabContents.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
        });

        tabContents.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;
            
            const horizontalDiff = e.screenX - mouseStartX;
            const verticalDiff = Math.abs(e.screenY - mouseStartY);
            
            // Solo procesar si es un arrastre horizontal
            if (verticalDiff > 30) return;
            
            const currentIndex = getCurrentTabIndex();
            
            if (horizontalDiff > minSwipeDistance) {
                switchToTab(currentIndex - 1);
            } else if (horizontalDiff < -minSwipeDistance) {
                switchToTab(currentIndex + 1);
            }
        });

        // Keyboard navigation (flechas izquierda/derecha)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                // No interferir si est√° escribiendo
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
                
                const currentIndex = getCurrentTabIndex();
                
                if (e.key === 'ArrowLeft') {
                    switchToTab(currentIndex - 1);
                } else if (e.key === 'ArrowRight') {
                    switchToTab(currentIndex + 1);
                }
                
                e.preventDefault();
            }
        });

        }); // Fin DOMContentLoaded

    </script>

    <!-- ‚îÄ‚îÄ‚îÄ HISTORY FAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <button id="historyFab" onclick="toggleHistoryPanel()" title="Historial de acciones">
        üïí
        <span id="historyBadge" style="display:none;">0</span>
    </button>

    <!-- ‚îÄ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="historyPanel">
        <div class="hp-header">
            <span>Historial de Acciones</span>
            <button class="hp-close" onclick="toggleHistoryPanel()">‚úï</button>
        </div>
        <div class="hp-body" id="historyPanelBody"></div>
    </div>

</body>
</html>